---
title: "Variance evaluation"
author: "ERM"
date: "`r Sys.Date()`"
runtime: shiny
output: 
  html_document: 
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```

```{r package loading, message=FALSE, warning=FALSE}

library(tidyverse)
library(ggpubr)
library(ggsignif)
library(gprofiler2)
library(paletteer)
library(ggVennDiagram)
library(gridtext)
library(scales)
library(kableExtra)
library(qvalue)
library(data.table)
library(ComplexHeatmap)

```

### variance of genes across treatment

This contains the wrangling of the data frame and analysis code, and is how the analysis was processed.

```{r manip mean across indv, eval=FALSE,echo=TRUE}
filcpm_counts <- read.csv("data/filtered_cpm_counts.csv", row.names = 1)

mean_vardrug <- filcpm_counts %>% 
 select(c(starts_with("Da")&ends_with("24h")),
        c(starts_with("Do")&ends_with("24h")),
        c(starts_with("Ep")&ends_with("24h")),
        c(starts_with("Mi")&ends_with("24h")),
        c(starts_with("Tr")&ends_with("24h")),
        c(starts_with("Ve")&ends_with("24h")),
       c(starts_with("Da")&ends_with("3h")),
        c(starts_with("Do")&ends_with("3h")),
        c(starts_with("Ep")&ends_with("3h")),
        c(starts_with("Mi")&ends_with("3h")),
        c(starts_with("Tr")&ends_with("3h")),
        c(starts_with("Ve")&ends_with("3h")))
        
  rownames(mean_vardrug) <- rownames(filcpm_counts)  
 write.csv(mean_vardrug, "data/organized_drugframe.csv")
        
        
mean_vardrug1 <- mean_vardrug %>% 
rowwise() %>% 
  mutate(mean.Da.3=mean(c_across(Da.1.3h:Da.6.3h)),
         var.Da.3=var(c_across(Da.1.3h:Da.6.3h)),
         mean.Do.3=mean(c_across(Do.1.3h:Do.6.3h)),
         var.Do.3=var(c_across(Do.1.3h:Do.6.3h)),
         mean.Ep.3=mean(c_across(Ep.1.3h:Ep.6.3h)),
         var.Ep.3=var(c_across(Ep.1.3h:Ep.6.3h)),
         mean.Mi.3=mean(c_across(Mi.1.3h:Mi.6.3h)),
         var.Mi.3=var(c_across(Mi.1.3h:Mi.6.3h)),
         mean.Tr.3=mean(c_across(Tr.1.3h:Tr.6.3h)),
         var.Tr.3=var(c_across(Tr.1.3h:Tr.6.3h)),
         mean.Ve.3=mean(c_across(Ve.1.3h:Ve.6.3h)),
         var.Ve.3=var(c_across(Ve.1.3h:Ve.6.3h)),
         mean.Da.24=mean(c_across(Da.1.24h:Da.6.24h)),
         var.Da.24=var(c_across(Da.1.24h:Da.6.24h)),
         mean.Do.24=mean(c_across(Do.1.24h:Do.6.24h)),
         var.Do.24=var(c_across(Do.1.24h:Do.6.24h)),
         mean.Ep.24=mean(c_across(Ep.1.24h:Ep.6.24h)),
         var.Ep.24=var(c_across(Ep.1.24h:Ep.6.24h)),
         mean.Mi.24=mean(c_across(Mi.1.24h:Mi.6.24h)),
         var.Mi.24=var(c_across(Mi.1.24h:Mi.6.24h)),
         mean.Tr.24=mean(c_across(Tr.1.24h:Tr.6.24h)),
         var.Tr.24=var(c_across(Tr.1.24h:Tr.6.24h)),
         mean.Ve.24=mean(c_across(Ve.1.24h:Ve.6.24h)),
         var.Ve.24=var(c_across(Ve.1.24h:Ve.6.24h))) %>% 
         select(mean.Da.3:var.Ve.24)
rownames(mean_vardrug1) <- rownames(filcpm_counts)
write.csv(mean_vardrug1,"data/mean_vardrug1.csv")



```

### plotting of data

```{r graph of var by drug indv, fig.height=5, fig.width=6}
mean_vardrug1 <- read.csv("data/mean_vardrug1.csv", row.names = 1)


drug_frame <- mean_vardrug1 %>%
  rownames_to_column(var = "entrezid") %>%
  pivot_longer(cols = mean.Da.3:var.Ve.24,
               names_to = "short",
               values_to = "values") %>%
  separate(short, into = c("calc", "treatment", "time")) %>%
  mutate(treatment = factor(
    treatment,
    levels = c("Do", "Ep", "Da", "Mi", "Tr", "Ve"),
    labels = c("DOX", "EPI", "DNR", "MTX", "TRZ", "VEH")
  )) %>%
  mutate(time = factor(
    time,
    levels = c("3", "24"),
    labels = c("3 hours", "24 hours")
  )) %>%
  group_by(treatment, time, calc) %>%
  as.data.frame

drug_pal_fact <-
  c("#8B006D",
    "#DF707E",
    "#F1B72B",
    "#3386DD",
    "#707031",
    "#41B333")

drug_frame %>%
  filter(calc != "mean") %>%
  ggplot(., aes(x = treatment, y = values, fill = treatment)) +
  geom_boxplot(outlier.shape = NA) +
  geom_signif(
    comparisons = list(
      c("DOX", "VEH"),
      c("EPI", "VEH"),
      c("DNR", "VEH"),
      c("MTX", "VEH"),
      c("TRZ", "VEH")
    ),
    test = "t.test",
    tip_length = 0.01,
    map_signif_level = FALSE,
    textsize = 4,
    y_position = 0.85,
    step_increase = 0.1
  ) +
  facet_wrap( ~ time) +
  ggtitle("Variance") +
  coord_cartesian(ylim = c(0, 1)) +
  # ylim(0,2)+
  scale_fill_manual(values = drug_pal_fact) +
  theme_bw() +
  xlab(" ") +
  ylab(expression("variance of log "[2] ~ " cpm ")) +
  theme(
    strip.background = element_rect(
      fill = "white",
      linetype = 1,
      linewidth = 0.5
    ),
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    axis.title = element_text(size = 10, color = "black"),
    axis.ticks = element_line(linewidth = 1.0),
    panel.background = element_rect(colour = "black", size = 1),
    axis.text.x = element_blank(),
    strip.text.x = element_text(margin = margin(2, 0, 2, 0, "mm"), face = "bold")
  )

drug_frame %>%
  filter(calc!="mean") %>%
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot(outlier.shape=NA)+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=FALSE,
              textsize =4,
               y_position=(.5),
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("var statistics")#+
  # ylim(0,0.5)

drug_frame %>%
  filter(calc != "var") %>%
  ggplot(., aes(x = treatment, y = values, fill = treatment)) +
  geom_boxplot(outlier.shape = NA) +
  geom_signif(
    comparisons = list(
      c("TRZ", "VEH"),
      c("MTX", "VEH"),
      c("DNR", "VEH"),
      c("EPI", "VEH"),
      c("DOX", "VEH")
    ),
    test = "t.test",
    tip_length = 0.01,
    map_signif_level = FALSE,
    textsize = 4,
    y_position = 11,
    step_increase = 0.05
  ) +
  facet_wrap(. ~ time) +
  ggtitle("Means") +
  ylim(0, 18) +
  scale_fill_manual(values = drug_pal_fact) +
  theme_bw() +
  xlab(" ") +
  ylab(expression("counts log"[2] ~ "cpm ")) +
  theme(
    strip.background = element_rect(
      fill = "white",
      linetype = 1,
      linewidth = 0.5
    ),
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    axis.title = element_text(size = 10, color = "black"),
    axis.ticks = element_line(linewidth = 1.0),
    panel.background = element_rect(colour = "black", size = 1),
    axis.text.x = element_blank(),
    strip.text.x = element_text(margin = margin(2, 0, 2, 0, "mm"), face = "bold")
  )

```

### Finding where the variance may exist

This is initial analysis to see if DOX response eGenes are increased in variance within my data.

```{r evaluate eGenes in var}
mean_vardrug1 <- read.csv("data/mean_vardrug1.csv",row.names = 1)
my_exp_genes <- read.csv("data/backGL.txt")
GTEx_genes <- read.csv("data/GTEx_gene_list.csv",row.names = 1)
GTEx <- intersect(GTEx_genes$entrezgene_id,my_exp_genes$ENTREZID)
knowles5 <-readRDS("output/knowles5.RDS")


drug_frame2<- mean_vardrug1 %>% 
  rownames_to_column(var = "entrezid") %>% 
  filter(entrezid %in%knowles5$entrezgene_id) %>% 
  pivot_longer(cols = mean.Da.3:var.Ve.24, names_to = "short", values_to = "values") %>% 
  separate(short, into=c("calc","treatment","time")) %>% 
  mutate(treatment= factor(treatment, levels = c("Do","Ep","Da","Mi","Tr","Ve"),labels = c("DOX","EPI","DNR","MTX","TRZ","VEH"))) %>% 
  mutate(time= factor(time, levels = c("3","24"), labels= c("3 hours","24 hours"))) %>% 
  group_by(treatment, time, calc) %>% 
  as.data.frame

ggplot(drug_frame2, aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.1)+
  ggtitle(" Dox eGenes")+
  # stat_compare_means(method= "anova", label.y=15, label.x =2)+
  facet_wrap(time~calc, scales = "free_y")

  drug_frame2 %>% 
  filter(calc!="mean") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("var using response eGenes")+
  ylim(0,1.0)

drug_frame2 %>% 
  filter(calc!="var") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("TRZ","VEH"),
                                c("MTX","VEH"),
                                c("DNR","VEH"),
                                c("EPI","VEH"),
                                c("DOX","VEH")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.05)+
  facet_wrap(.~time)+
  ggtitle("Means using response eGenes")+
  ylim(0,18)

  
```

We found significant differences to the vehicle in the EPI 24 hour variance. This was based on a smaller set of genes,

This was a different way of wrangling the values with var.test as the function across all genes.

```{r data wrangling-evalute variance, message=FALSE, warning=FALSE, eval=FALSE}

organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)

DNR.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Da")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Da")),c_across(starts_with("Ve"))))) 
  
DOX.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Do")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
 rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Do")),c_across(starts_with("Ve")))))

EPI.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Ep")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
 rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Ep")),c_across(starts_with("Ve")))))

MTX.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Mi")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Mi")),c_across(starts_with("Ve")))))
TRZ.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Tr")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Tr")),c_across(starts_with("Ve")))))

DNR.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Da")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Da")),c_across(starts_with("Ve")))))
DOX.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Do")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Do")),c_across(starts_with("Ve"))))) 
EPI.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Ep")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Ep")),c_across(starts_with("Ve")))))
MTX.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Mi")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Mi")),c_across(starts_with("Ve")))))


TRZ.VEH.3 <- organized_drugframe %>% 
  rownames_to_column(.id = "gene") %>% 
  rowwise() %>% 
  select(c(starts_with("Tr")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  mutate(data=list(var.test(c_across(starts_with("Tr")),c_across(starts_with("Ve")))))

Var_test_list24 <- list(DNR.VEH.24,DOX.VEH.24,EPI.VEH.24,MTX.VEH.24,TRZ.VEH.24)
                      
names(Var_test_list24) <- c('DNR.VEH.24','DOX.VEH.24','EPI.VEH.24','MTX.VEH.24','TRZ.VEH.24')
                    
  
 saveRDS(Var_test_list24,"data/Var_test_list24.RDS")   
 
 
 Var_test_list3 <- list(DNR.VEH.3,DOX.VEH.3,EPI.VEH.3,MTX.VEH.3,TRZ.VEH.3)
                      
names(Var_test_list3) <- c('DNR.VEH.3','DOX.VEH.3','EPI.VEH.3','MTX.VEH.3','TRZ.VEH.3')
                     saveRDS(Var_test_list3,"data/Var_test_list3.RDS") 
```

Watch for the caption to tell which data set is plotted! \#### 3 hour

```{r extract pvalue and qvalue list 3 hours}

                 
organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)
Var_test_list3 <- readRDS("data/Var_test_list3.RDS")
#Is the data normally distributed?


set3 <- names(Var_test_list3)
shorterlist <- Var_test_list3[[1]][[13]]
names(shorterlist) <- rownames(organized_drugframe)

framefun3 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set3)){
  a <- set3[i]
    s_list<- Var_test_list3[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$p.value), .id="ENTREZID")
   framefun3[paste0(a)] <- hold$`.x$p.value`
 
}
est3pDNR <- qvalue(p=framefun3$DNR.VEH.3)
est3pDOX <- qvalue(p=framefun3$DOX.VEH.3)
est3pEPI <- qvalue(p=framefun3$EPI.VEH.3)
est3pMTX <- qvalue(p=framefun3$MTX.VEH.3)
est3pTRZ <- qvalue(p=framefun3$TRZ.VEH.3)

summary(est3pDNR)
summary(est3pDOX)
summary(est3pEPI)
summary(est3pMTX)
summary(est3pTRZ)



EPIq3 <- data.table(pvalues=est3pEPI$pvalues,EPIqvalues=est3pEPI$qvalues)
EPI3_genelist <- framefun3 %>% dplyr::select(ENTREZID,EPI.VEH.3)
EPIstorelist3 <- EPI3_genelist %>%
  full_join(.,EPIq3, by=c("EPI.VEH.3"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.1) %>% 
  # mutate(ENTREZID=as.integer(ENTREZID))
# saveRDS(storeEPI,"data/qvalueEPItemp.RDS")

DNRq3<- data.table(pvalues=est3pDNR$pvalues,DNRqvalues=est3pDNR$qvalues)

DNR3_genelist <- framefun3 %>% dplyr::select(ENTREZID,DNR.VEH.3)

DNRstorelist3 <-DNR3_genelist %>%
  full_join(.,DNRq3, by=c("DNR.VEH.3"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.2)  
  
DOXq3 <- data.table(pvalues=est3pDOX$pvalues,DOXqvalues=est3pDOX$qvalues)
DOX3_genelist <- framefun3 %>% dplyr::select(ENTREZID,DOX.VEH.3)
DOXstorelist3 <-DOX3_genelist %>%
  full_join(.,DOXq3, by=c("DOX.VEH.3"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.2)

MTXq3 <- data.table(pvalues=est3pMTX$pvalues,MTXqvalues=est3pMTX$qvalues)
MTX3_genelist <- framefun3 %>% dplyr::select(ENTREZID,MTX.VEH.3)
MTXstorelist3 <-MTX3_genelist %>%
  full_join(.,MTXq3, by=c("MTX.VEH.3"="pvalues"))# %>% 
  # dplyr::filter(qvalues<.2)

TRZq3 <- data.table(pvalues=est3pTRZ$pvalues,TRZqvalues=est3pTRZ$qvalues)
TRZ3_genelist <- framefun3 %>% dplyr::select(ENTREZID,TRZ.VEH.3)
TRZstorelist3 <- TRZ3_genelist %>%
  full_join(.,TRZq3, by=c("TRZ.VEH.3"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.2)

# 
# DOXstorelist3$DOXqvalues,EPIstorelist3$EPIqvalues,MTXstorelist3$MTXqvalues]
qval3hr <-  DOXstorelist3 %>% 
   full_join(.,EPIstorelist3, by="ENTREZID") %>% 
    
    full_join(.,DNRstorelist3, by="ENTREZID") %>% 
    full_join(.,MTXstorelist3, by="ENTREZID") %>% 
    full_join(.,TRZstorelist3, by="ENTREZID") %>% 
  select(ENTREZID, ends_with("qvalues"))
# saveRDS(qval3hr,"data/qval3hr.RDS")
```

We ended up using the qvalue package to find genes that are more than likely highly variable genes.

#### 24 hour

```{r extract pvalue and qvalue list 24 hours}

                 
organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)

Var_test_list24 <- readRDS("data/Var_test_list24.RDS")
set24 <- names(Var_test_list24) 

framefun24 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set24)){
  a <- set24[i]
    s_list<- Var_test_list24[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$p.value), .id="ENTREZID")
   framefun24[paste0(a)] <- hold$`.x$p.value`
 
}
est24pDNR <- qvalue(p=framefun24$DNR.VEH.24)
est24pDOX <- qvalue(p=framefun24$DOX.VEH.24)
est24pEPI <- qvalue(p=framefun24$EPI.VEH.24)
est24pMTX <- qvalue(p=framefun24$MTX.VEH.24)
est24pTRZ <- qvalue(p=framefun24$TRZ.VEH.24)

summary(est24pDNR)
summary(est24pDOX)
summary(est24pEPI)
summary(est24pMTX)
summary(est24pTRZ)

EPIq24 <- data.table(pvalues=est24pEPI$pvalues,EPIqvalues=est24pEPI$qvalues)
EPI24_genelist <- framefun24 %>% dplyr::select(ENTREZID,EPI.VEH.24)
EPIstorelist24 <- EPI24_genelist %>%
  full_join(.,EPIq24, by=c("EPI.VEH.24"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.1) %>% 
  # mutate(ENTREZID=as.integer(ENTREZID))
# saveRDS(storeEPI,"data/qvalueEPItemp.RDS")
DNRq24 <- data.table(pvalues=est24pDNR$pvalues,DNRqvalues=est24pDNR$qvalues)

DNR24_genelist <- framefun24 %>% dplyr::select(ENTREZID,DNR.VEH.24)

DNRstorelist24 <-DNR24_genelist %>%
  full_join(.,DNRq24, by=c("DNR.VEH.24"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.2)  
  
DOXq24 <- data.table(pvalues=est24pDOX$pvalues,DOXqvalues=est24pDOX$qvalues)
DOX24_genelist <- framefun24 %>% dplyr::select(ENTREZID,DOX.VEH.24)
DOXstorelist24 <-DOX24_genelist %>%
  full_join(.,DOXq24, by=c("DOX.VEH.24"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.2)
# 
MTXq24 <- data.table(pvalues=est24pMTX$pvalues,MTXqvalues=est24pMTX$qvalues)
MTX24_genelist <- framefun24 %>% dplyr::select(ENTREZID,MTX.VEH.24)
MTXstorelist24 <-MTX24_genelist %>%
  full_join(.,MTXq24, by=c("MTX.VEH.24"="pvalues"))# %>% 
  # dplyr::filter(qvalues<.2)

TRZq24 <- data.table(pvalues=est24pTRZ$pvalues,TRZqvalues=est24pTRZ$qvalues)
TRZ24_genelist <- framefun24 %>% dplyr::select(ENTREZID,TRZ.VEH.24)
TRZstorelist24 <- TRZ24_genelist %>%
  full_join(.,TRZq24, by=c("TRZ.VEH.24"="pvalues")) #%>% 
  # dplyr::filter(qvalues<.2)

qval24hr <-  DOXstorelist24 %>% 
   full_join(.,EPIstorelist24, by="ENTREZID") %>% 
    
    full_join(.,DNRstorelist24, by="ENTREZID") %>% 
    full_join(.,MTXstorelist24, by="ENTREZID") %>% 
    full_join(.,TRZstorelist24, by="ENTREZID") %>% 
  select(ENTREZID, ends_with("qvalues"), ends_with("24"))
# saveRDS(qval24hr,"data/qval24hr.RDS") 

 
```

## evaluation of F statistic using correlation

```{r Fstatcorr}

organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)
Var_test_list3 <- readRDS("data/Var_test_list3.RDS")
#Is the data normally distributed?

set3 <- names(Var_test_list3)
shorterlist <- Var_test_list3[[1]][[13]]
names(shorterlist) <- rownames(organized_drugframe)

statfun3 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set3)){
  a <- set3[i]
    s_list<- Var_test_list3[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$statistic), .id="ENTREZID")
   statfun3[paste0(a)] <- hold$`.x$statistic`
 
}

Var_test_list24 <- readRDS("data/Var_test_list24.RDS")
set24 <- names(Var_test_list24) 

statfun24 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set24)){
  a <- set24[i]
    s_list<- Var_test_list24[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$statistic), .id="ENTREZID")
   statfun24[paste0(a)] <- hold$`.x$statistic`
 
}
 col_fun <- circlize::colorRamp2(c(-1,0, 1), c("blue","white", "red"))
 
# to combine with 3 hr
matstat24 <- statfun24 %>%  
   column_to_rownames('ENTREZID') %>% 
   as.matrix(.) #%>%
   # rowwise() %>% 
# 24 hour spearman correlation

statfun24 %>%  
   column_to_rownames('ENTREZID') %>% 
   # as.matrix(.) #%>%
   cor(.,method="spearman", use="pairwise") %>% 
   Heatmap(., column_title = "24 hour F stat corr", col=col_fun)
# to combine with 24 hr
matstat3 <-  
  statfun3 %>% 
   column_to_rownames('ENTREZID') %>% 
   as.matrix(.)
 


statfun3 %>% 
   column_to_rownames('ENTREZID') %>% 
   # as.matrix(.) %>% 
   # rowwise() %>% 
   cor(.) %>% 
   Heatmap(., column_title = "3 hour F stat corr", col=col_fun)
matstatall <- statfun24 %>% 
  full_join(., statfun3, by="ENTREZID") %>% 
   column_to_rownames('ENTREZID') %>% 
   as.matrix(.) 

statfun24 %>% 
  full_join(., statfun3, by="ENTREZID") %>% 
   column_to_rownames('ENTREZID') %>% 
   # as.matrix(.) %>% 
   # rowwise() %>% 
   cor(., method="spearman") %>% 
   Heatmap(., column_title = "3 & 24 hr F stat corr", 
           col=col_fun,
           cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", .[i, j]), x, y, gp = gpar(fontsize = 10))})

matframeall <-framefun24 %>% 
  full_join(., framefun3, by="ENTREZID") %>% 
   column_to_rownames('ENTREZID') %>% 
   as.matrix(.)  
framefun3 %>% 
  column_to_rownames('ENTREZID') %>% 
   # as.matrix(.) %>% 
   # rowwise() %>% 
   cor(., method="spearman",use="pairwise") %>% 
   Heatmap(., column_title = "3 hour pval corr", col=col_fun)
matframe24 <- framefun24 %>% 
  # full_join(., framefun, by="ENTREZID") %>% 
  column_to_rownames('ENTREZID') %>% 
   as.matrix(.)# %>%


framefun24 %>% 
  full_join(., framefun3, by="ENTREZID") %>% 
  column_to_rownames('ENTREZID') %>% 
   # as.matrix(.) %>% 
   # rowwise() %>% 
   cor(.,method="spearman") %>% 
   Heatmap(., column_title = "24 and 3 hour p val correlation", col=col_fun,
           cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", .[i, j]), x, y, gp = gpar(fontsize = 10))})




```

### q stat plots using Spearman correlation

```{r qstat plotsheatmap}
# sum(qvalue24hr$EPIqvalues<0.1)

qvalue3hr <- readRDS("data/qval3hr.RDS")
qvalue3hr %>%  
  column_to_rownames('ENTREZID') %>% 
  select(!TRZqvalues) %>% 
   as.matrix(.) %>%
   # rowwise() %>% 
   cor(., method="spearman") %>% 
  
   Heatmap(., column_title = "3 hour q value corr (Spearman)", col=col_fun,
           )


qvalue24hr <- readRDS("data/qval24hr.RDS")
qvalue24hr %>%  
  column_to_rownames('ENTREZID') %>% 
  select(!MTXqvalues) %>%
  select(ends_with("qvalues")) %>% 
   as.matrix(.) %>%
   # rowwise() %>% 
   cor(.,method="spearman", use="pairwise")%>%
  
   Heatmap(., column_title = "24 hour q value corr", col=col_fun,na_col = "tan",
           cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", .[i, j]), x, y, gp = gpar(fontsize = 10))})


```

## 3 and 24 hour histogram of var using un-adjusted and adjust p.values

```{r plot pvalue as histo}
framefun3 %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  ggplot(.,aes(x=p.value,col=drug,fill=drug))+
  geom_histogram()+
  facet_wrap(~drug)+
  ggtitle("3 hour var.test un-adjusted p.value ")


hist(est3pDNR)+labs(caption= "DNR 3")
hist(est3pDOX)+labs(caption= "DOX 3")
hist(est3pEPI)+labs(caption= "EPI 3")
hist(est3pMTX)+labs(caption= "MTX 3")
hist(est3pTRZ)+labs(caption= "TRZ 3")

plot(est3pDNR)
plot(est3pDOX)
plot(est3pEPI)
plot(est3pMTX)
plot(est3pTRZ)


framefun24 %>% 
  dplyr::filter(ENTREZID %in% EPIstorelist24$ENTREZID) %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  ggplot(.,aes(x=p.value,col=drug,fill=drug))+
  geom_histogram()+
  facet_wrap(~drug)+
  ggtitle("24 hour var.test un-adjusted p.value")
  
hist(est24pDNR)+labs(caption= "DNR 24")
hist(est24pDOX)+labs(caption= "DOX 24")
hist(est24pEPI)+labs(caption= "EPI 24")
hist(est24pMTX)+labs(caption= "MTX 24")
hist(est24pTRZ)+labs(caption= "TRZ 24")


plot(est24pDNR, caption =paste("DNR"))
print("DNR")
plot(est24pDOX)
print("DOX")
plot(est24pEPI)
print("EPI")
plot(est24pMTX)
print("MTX")
plot(est24pTRZ)
print("TRZ")


```

```{r gene filtering}
backGL <-read_csv("data/backGL.txt", 
    col_types = cols(...1 = col_skip()))
var3 <- list <- framefun3 %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  filter(p.value<0.05)

var24 <- list <- framefun24 %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  filter(p.value<0.05)

DOX_24_var <- var24 %>% filter(drug=="DOX") %>% select(ENTREZID)#1089 
EPI_24_var <- var24 %>% filter(drug=="EPI")%>% select(ENTREZID)#2211
DNR_24_var <- var24 %>% filter(drug=="DNR")%>% select(ENTREZID)#928
MTX_24_var <- var24 %>% filter(drug=="MTX")%>% select(ENTREZID)#269
TRZ_24_var <- var24 %>% filter(drug=="TRZ")%>% select(ENTREZID)#157

geneset_24 <- list(DOX_24_var$ENTREZID, EPI_24_var$ENTREZID, DNR_24_var$ENTREZID, MTX_24_var$ENTREZID, TRZ_24_var$ENTREZID)
names(geneset_24) <- c("DOX_24_var","EPI_24_var","DNR_24_var" ,"MTX_24_var","TRZ_24_var")

DOX_3_var <- var3 %>% filter(drug=="DOX")%>% select(ENTREZID)#346
EPI_3_var <- var3 %>% filter(drug=="EPI")%>% select(ENTREZID)#332
DNR_3_var <- var3 %>% filter(drug=="DNR")%>% select(ENTREZID)#385
MTX_3_var <- var3 %>% filter(drug=="MTX")%>% select(ENTREZID)#277
TRZ_3_var <- var3 %>% filter(drug=="TRZ")%>% select(ENTREZID)#262

geneset_3 <- list(DOX_3_var$ENTREZID,EPI_3_var$ENTREZID,DNR_3_var$ENTREZID ,MTX_3_var$ENTREZID,TRZ_3_var$ENTREZID)
names(geneset_3) <- c("DOX_3_var","EPI_3_var","DNR_3_var" ,"MTX_3_var","TRZ_3_var")

# saveRDS(geneset_24,"data/geneset_24.RDS")
```

## Venn of highly variable genes

based on nominal pvalues \<0.05

```{r venn of 24 hours}

geneset_24 <- readRDS("data/geneset_24.RDS")
ggVennDiagram::ggVennDiagram(geneset_24,
              category.names = c("DOX\nn = 1089 ",
                                 "EPI\nn = 2211\n",
                                 "DNR\nn = 928",
                                 "MTX\nn = 269", 
                                "TRZ\nn = 157"),
              show_intersect = FALSE,
              set_color = "black",
              category_size = c(6,6,6,6),
              label = "count",
              label_percent_digit = 1,
              label_size = 4,
              label_alpha = 0,
              label_color = "black",
              edge_lty = "solid", set_size = 4.5)+
  scale_x_continuous(expand = expansion(mult = .3))+
  scale_y_continuous(expand = expansion(mult = .2))+
  scale_color_paletteer_d(palette = "fishualize::Bodianus_pulchellus")+
  scale_fill_distiller(palette="Spectral", direction = -1)+
  labs(title = "24 hour var genes p. value <0.05",
       caption = paste("n =", length(unique(var24$ENTREZID)),"genes"))+
  
  theme(plot.title = element_text(size = rel(1.6), hjust = 0.5, vjust =1))

```

## 24 hour DOX highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of DOX24}

# DOX_var24gost <- gost(query = DOX_24_var$ENTREZID,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))

# saveRDS(DOX_var24gost,"data/DEG-GO/var/DOX_var24gost.RDS")
DOX_var24gost <- readRDS("data/DEG-GO/var/DOX_var24gost.RDS")

DOX_var24p <- gostplot(DOX_var24gost, capped = FALSE, interactive = TRUE)
DOX_var24p

DOX_var24_table <- DOX_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

DOX_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('DOX24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  DOX_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "DOX 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")



```

## 24 hour EPI highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of EPI24}

# EPI_var24gost <- gost(query = EPI_24_var$ENTREZID,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))
# 
# saveRDS(EPI_var24gost,"data/DEG-GO/var/EPI_var24gost.RDS")
EPI_var24gost <- readRDS("data/DEG-GO/var/EPI_var24gost.RDS")

# EPI_var24p <- gostplot(EPI_var24gost, capped = FALSE, interactive = TRUE)
# EPI_var24p

EPI_var24_table <- EPI_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

EPI_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=3 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('EPI24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  EPI_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "EPI 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")

EPI_var24_table %>% 
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG EPI 24 hour enrichment terms of highly var genes using nominal p value") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")


```


### EPI 508 var genes (using q value <0.1)
  Looking at variance in all treatment & time in the significantly variable EPI genes (n = 508)


```{r epi 508 corr}
EPIstore <- EPIstorelist24 %>% 
  dplyr::filter(EPIqvalues<0.1)

var508only <-  mean_vardrug1 %>% 
  rownames_to_column(var = "entrezid") %>% 
  mutate(entrezid=as.integer(entrezid)) %>% 
  dplyr::filter(entrezid %in% EPIstore$ENTREZID) %>% 
  column_to_rownames("entrezid") %>% 
  dplyr::select(starts_with("var"))
var_corr <- cor(var508only)

ComplexHeatmap::Heatmap(var_corr)

var50824only <-  var508only %>% 
   dplyr::select(starts_with("var")&contains(".24"))
  
 
var_24corr <- cor(var50824only)
ComplexHeatmap::Heatmap(var_24corr)

var_all <- mean_vardrug1 %>% 
   dplyr::select(starts_with("var"))

var_24all <- mean_vardrug1 %>% 
    dplyr::select(starts_with("var")&contains(".24"))

var_allcorr <- cor(var_all)

ComplexHeatmap::Heatmap(var_allcorr,col=col_fun)

var_24allcorr <- cor(var_24all)

ComplexHeatmap::Heatmap(var_24allcorr,col=col_fun)

DOXreQTLs <- readRDS("output/DOXreQTLs.RDS")

# storeEPI %>% 
#   filter (ENTREZID %in% DOXreQTLs$ENTREZID) %>% 
#   left_join(., backGL, by=c("ENTREZID"))

ggVennDiagram::ggVennDiagram(list(unique(EPIstore$ENTREZID),DOXreQTLs$ENTREZID),category.names = c("EPI var\nn = 508","DOXreQTLs\nn = 142"))


```

```{r epivarvar}

mean_vardrug1 <- read.csv("data/mean_vardrug1.csv", row.names = 1)


drug_frameepivar<- mean_vardrug1 %>% 
  rownames_to_column(var = "entrezid") %>% 
  dplyr::filter(entrezid %in% EPIstore$ENTREZID) %>% 
  pivot_longer(cols = mean.Da.3:var.Ve.24, names_to = "short", values_to = "values") %>% 
  separate(short, into=c("calc","treatment","time")) %>% 
  mutate(treatment= factor(treatment, levels = c("Do","Ep","Da","Mi","Tr","Ve"),labels = c("DOX","EPI","DNR","MTX","TRZ","VEH"))) %>% 
  mutate(time= factor(time, levels = c("3","24"), labels= c("3 hours","24 hours"))) %>% 
  group_by(treatment, time, calc) %>% 
  mutate(entrezid=as.integer(entrezid)) %>% 
  as.data.frame

drug_pal_fact <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")

drug_frameepivar %>% 
  filter(calc!="mean") %>% 
  ggplot(., aes(x= treatment, y=values, fill=treatment))+
  geom_boxplot(outlier.shape=NA)+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              tip_length = 0.01,
              map_signif_level=FALSE,
              textsize =4,
              y_position=0.85,
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("Variance of 508 highly variable EPI genes")+
  # coord_cartesian(ylim = c(0,1))+
  # ylim(0,2)+
scale_fill_manual(values=drug_pal_fact)+
  theme_bw()+
  xlab(" ")+
  ylab(expression("variance of log "[2]~" cpm "))+
  theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "mm"),face = "bold"))


drug_frameepivar %>% 
  filter(calc!="var") %>% 
  ggplot(., aes(x= treatment, y=values,fill=treatment))+
  geom_boxplot(outlier.shape=NA)+
  geom_signif(comparisons =list(c("TRZ","VEH"),
                                c("MTX","VEH"),
                                c("DNR","VEH"),
                                c("EPI","VEH"),
                                c("DOX","VEH")),
              test= "t.test",
              tip_length = 0.01,
              map_signif_level=FALSE,
              textsize =4,
              y_position=11,
              step_increase = 0.05)+
  facet_wrap(.~time)+
  ggtitle("Means of the 508 highly variable EPI genes")+
  ylim(0,15)+
 scale_fill_manual(values=drug_pal_fact)+
  theme_bw()+
  xlab(" ")+
  ylab(expression("counts log"[2]~"cpm "))+
  theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "mm"),face = "bold"))



```

## EPI var GO info
GO analysis across the 508 genes
```{r Epi-go-qvalue}


# 
# EPIvargostq <- gost(query = EPIstore$ENTREZID,
#                     organism = "hsapiens", significant = FALSE,
#                     ordered_query = TRUE,
#                     domain_scope = "custom",
#                     measure_underrepresentation = FALSE,
#                     evcodes = FALSE,
#                     user_threshold = 0.05,
#                     correction_method = c("fdr"),
#                     custom_bg =my_exp_genes$ENTREZID,
#                     sources=c("GO:BP","KEGG"))
# saveRDS(EPIvargostq,"data/DEG-GO/EPIvargostq.RDS")
EPIvargostq <- readRDS("data/DEG-GO/EPIvargostq.RDS")
# EPIvarq<- gostplot(EPIvargostq, capped = FALSE, interactive = TRUE)
# EPIvarq

EPI_table_var <- EPIvargostq$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))  
 
 EPI_table_var  %>% 
    dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=5 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
    ggplot(., aes(x = log_val, y =reorder(term_name,p_value), 
                  col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)))+
    scale_y_discrete(labels = scales::label_wrap(30))+
    guides(col="none", 
           size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('EPI highly var genes GO:BP terms') +
     xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
    theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.ticks = element_line(linewidth = 1.5),
          axis.line = element_line(linewidth = 1.5),
          axis.text = element_text(size = 10, color = "black", angle = 0),
          strip.text.x = element_text(size = 15, color = "black", face = "bold"))
  
  EPI_table_var  %>% 
    dplyr::filter(source=="KEGG") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=5 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
    ggplot(., aes(x = log_val, y =reorder(term_name,p_value), 
                  col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)))+
    scale_y_discrete(labels = scales::label_wrap(30))+
    guides(col="none", 
           size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('EPI highly var genes KEGG terms') +
     xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("KEGG term")+
    theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.ticks = element_line(linewidth = 1.5),
          axis.line = element_line(linewidth = 1.5),
          axis.text = element_text(size = 10, color = "black", angle = 0),
          strip.text.x = element_text(size = 15, color = "black", face = "bold"))
 
 
 
  EPI_table_var %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
    kable(.,) %>% 
    kable(.,caption = "KEGG GO:BP var enrichment terms ") %>% 
    kable_paper("striped", full_width = FALSE) %>%
    kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>%
    scroll_box(width = "100%", height = "400px") 
  
  
 EPI_table_var %>%  
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG EPI var enrichment terms of highly var genes") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")
  
  
  
```
we did not find significantly enriched GO:BP or KEGG pathways enrichment in the 508 highly variable EPI gene names



## 24 hour DNR highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of DNR24}

# DNR_var24gost <- gost(query = DNR_24_var$ENTREZID,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))
# 
# saveRDS(DNR_var24gost,"data/DEG-GO/var/DNR_var24gost.RDS")
DNR_var24gost <- readRDS("data/DEG-GO/var/DNR_var24gost.RDS")

DNR_var24p <- gostplot(DNR_var24gost, capped = FALSE, interactive = TRUE)
DNR_var24p

DNR_var24_table <- DNR_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

DNR_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=3 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('DNR24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  DNR_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "DNR 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")

DNR_var24_table %>% 
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG DNR 24 hour enrichment terms of highly var genes") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")


```

## 24 hour MTX highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of MTX24}

# MTX_var24gost <- gost(query = MTX_24_var$ENTREZID,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))
# 
# saveRDS(MTX_var24gost,"data/DEG-GO/var/MTX_var24gost.RDS")
MTX_var24gost <- readRDS("data/DEG-GO/var/MTX_var24gost.RDS")

MTX_var24p <- gostplot(MTX_var24gost, capped = FALSE, interactive = TRUE)
MTX_var24p

MTX_var24_table <- MTX_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

MTX_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('MTX24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  MTX_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "MTX 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")

MTX_var24_table %>% 
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG MTX 24 hour enrichment terms of highly var genes") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")


```

## 24 hour TRZ highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of TRZ24}

# TRZ_var24gost <- gost(query = TRZ_24_var$ENTREZID,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))
# 
# saveRDS(TRZ_var24gost,"data/DEG-GO/var/TRZ_var24gost.RDS")
TRZ_var24gost <- readRDS("data/DEG-GO/var/TRZ_var24gost.RDS")

TRZ_var24p <- gostplot(TRZ_var24gost, capped = FALSE, interactive = TRUE)
TRZ_var24p

TRZ_var24_table <- TRZ_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

TRZ_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('TRZ24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  TRZ_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "TRZ 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")

TRZ_var24_table %>% 
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG TRZ 24 hour enrichment terms of highly var genes") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")


```

## 24 hour AC shared highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of AC_share24}
venn24part <- VennDiagram::get.venn.partitions(geneset_24)
AC_share <- venn24part$..values..[[25]]
# AC_share_var24gost <- gost(query = AC_share,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))
# 
# saveRDS(AC_share_var24gost,"data/DEG-GO/var/AC_share_var24gost.RDS")
AC_share_var24gost <- readRDS("data/DEG-GO/var/AC_share_var24gost.RDS")

AC_share_var24p <- gostplot(AC_share_var24gost, capped = FALSE, interactive = TRUE)
AC_share_var24p

AC_share_var24_table <- AC_share_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

AC_share_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('AC_share24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  AC_share_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "AC_share 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")

AC_share_var24_table %>% 
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG AC_share 24 hour enrichment terms of highly var genes") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")


```

## 24 hour TOP2i shared highly variable genes

based on nominal pvalues \<0.05

```{r GO analysis of TOP2i24}

TOP2i <- venn24part$..values..[[17]]
# TOP2i_var24gost <- gost(query = TOP2i,
#                   organism = "hsapiens",
#                   significant = FALSE,
#                   ordered_query = TRUE,
#                   domain_scope = "custom",
#                   measure_underrepresentation = FALSE,
#                   evcodes = FALSE,
#                   numeric_ns="ENTREZGENE",
#                   user_threshold = 0.05,
#                   correction_method = "fdr",
#                   custom_bg = backGL$ENTREZID,
#                   sources=c("GO:BP","KEGG"))
# 
# saveRDS(TOP2i_var24gost,"data/DEG-GO/var/TOP2i_var24gost.RDS")
TOP2i_var24gost <- readRDS("data/DEG-GO/var/TOP2i_var24gost.RDS")

TOP2i_var24p <- gostplot(TOP2i_var24gost, capped = FALSE, interactive = TRUE)
TOP2i_var24p

TOP2i_var24_table <- TOP2i_var24gost$result %>% 
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value))

TOP2i_var24_table %>% 
 dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
   geom_vline(xintercept = (-log10(0.05)), col="red")+
    scale_y_discrete(labels = label_wrap(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('TOP2i 24 hour top 10 GO:BP terms') +
    xlab(expression(" -"~log[10]~("adj. p-value")))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
  TOP2i_var24_table %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "TOP2i 24 enrichment terms of highly var genes") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")

TOP2i_var24_table %>% 
  filter(source=="KEGG") %>% 
    mutate_at(.vars = 6, .funs= scientific_format()) %>% 
  kable(.,caption = "KEGG TOP2i 24 hour enrichment terms of highly var genes") %>% 
  
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")


```


