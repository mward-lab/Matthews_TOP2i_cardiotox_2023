---
title: "Variance"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r package loading}

library(tidyverse)
library(ggpubr)
library(ggsignif)
library(gprofiler2)

```

## initial calculations and data loading  

### by individual  


```{r data loading, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
filcpm_counts <- read.csv("data/filtered_cpm_counts.csv", row.names = 1)
time <- rep((rep(c("3h", "24h"), c(6,6))), 6) 
time <- ordered(time, levels =c("3h", "24h"))

indv <- as.factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12))) 


group <-(rep(c("1","2","3","4","5","6","7","8","9","10","11","12"),6)) 
group <- factor(group,levels = c( 1,2,3,4,5,6,7,8,9,10,11,12))

drug <- rep(c("DNR","DOX","EPI","MTX","TRZ", "VEH"),12)


mean_varframe <- filcpm_counts %>% 
  rowwise() %>% 
  mutate(mean.1.3=mean(c_across(Da.1.3h:Ve.1.3h)),
         var.1.3=var(c_across(Da.1.3h:Ve.1.3h)),
         mean.2.3=mean(c_across(Da.2.3h:Ve.2.3h)),
         var.2.3=var(c_across(Da.2.3h:Ve.2.3h)),
         mean.3.3=mean(c_across(Da.3.3h:Ve.3.3h)),
         var.3.3=var(c_across(Da.3.3h:Ve.3.3h)),
         mean.4.3=mean(c_across(Da.4.3h:Ve.4.3h)),
         var.4.3=var(c_across(Da.4.3h:Ve.4.3h)),
         mean.5.3=mean(c_across(Da.5.3h:Ve.5.3h)),
         var.5.3=var(c_across(Da.5.3h:Ve.5.3h)),
         mean.6.3=mean(c_across(Da.6.3h:Ve.6.3h)),
         var.6.3=var(c_across(Da.6.3h:Ve.6.3h)),
         mean.1.24=mean(c_across(Da.1.24h:Ve.1.24h)),
         var.1.24=var(c_across(Da.1.24h:Ve.1.24h)),
         mean.2.24=mean(c_across(Da.2.24h:Ve.2.24h)),
         var.2.24=var(c_across(Da.2.24h:Ve.2.24h)),
         mean.3.24=mean(c_across(Da.3.24h:Ve.3.24h)),
         var.3.24=var(c_across(Da.3.24h:Ve.3.24h)),
         mean.4.24=mean(c_across(Da.4.24h:Ve.4.24h)),
         var.4.24=var(c_across(Da.4.24h:Ve.4.24h)),
         mean.5.24=mean(c_across(Da.5.24h:Ve.5.24h)),
         var.5.24=var(c_across(Da.5.24h:Ve.5.24h)),
         mean.6.24=mean(c_across(Da.6.24h:Ve.6.24h)),
         var.6.24=var(c_across(Da.6.24h:Ve.6.24h))) 


  
  rownames(mean_varframe) <- rownames(filcpm_counts)
 
write.csv(mean_varframe,"data/mean_varframe.csv")


```



### by drug  

```{r manip mean across indv, eval=FALSE,echo=FALSE }
filcpm_counts <- read.csv("data/filtered_cpm_counts.csv", row.names = 1)

mean_vardrug <- filcpm_counts %>% 
 select(c(starts_with("Da")&ends_with("24h")),
        c(starts_with("Do")&ends_with("24h")),
        c(starts_with("Ep")&ends_with("24h")),
        c(starts_with("Mi")&ends_with("24h")),
        c(starts_with("Tr")&ends_with("24h")),
        c(starts_with("Ve")&ends_with("24h")),
       c(starts_with("Da")&ends_with("3h")),
        c(starts_with("Do")&ends_with("3h")),
        c(starts_with("Ep")&ends_with("3h")),
        c(starts_with("Mi")&ends_with("3h")),
        c(starts_with("Tr")&ends_with("3h")),
        c(starts_with("Ve")&ends_with("3h")))
        
  rownames(mean_vardrug) <- rownames(filcpm_counts)  
 write.csv(mean_vardrug, "data/organized_drugframe.csv")
        
        
mean_vardrug1 <- mean_vardrug %>% 
rowwise() %>% 
  mutate(mean.Da.3=mean(c_across(Da.1.3h:Da.6.3h)),
         var.Da.3=var(c_across(Da.1.3h:Da.6.3h)),
         mean.Do.3=mean(c_across(Do.1.3h:Do.6.3h)),
         var.Do.3=var(c_across(Do.1.3h:Do.6.3h)),
         mean.Ep.3=mean(c_across(Ep.1.3h:Ep.6.3h)),
         var.Ep.3=var(c_across(Ep.1.3h:Ep.6.3h)),
         mean.Mi.3=mean(c_across(Mi.1.3h:Mi.6.3h)),
         var.Mi.3=var(c_across(Mi.1.3h:Mi.6.3h)),
         mean.Tr.3=mean(c_across(Tr.1.3h:Tr.6.3h)),
         var.Tr.3=var(c_across(Tr.1.3h:Tr.6.3h)),
         mean.Ve.3=mean(c_across(Ve.1.3h:Ve.6.3h)),
         var.Ve.3=var(c_across(Ve.1.3h:Ve.6.3h)),
         mean.Da.24=mean(c_across(Da.1.24h:Da.6.24h)),
         var.Da.24=var(c_across(Da.1.24h:Da.6.24h)),
         mean.Do.24=mean(c_across(Do.1.24h:Do.6.24h)),
         var.Do.24=var(c_across(Do.1.24h:Do.6.24h)),
         mean.Ep.24=mean(c_across(Ep.1.24h:Ep.6.24h)),
         var.Ep.24=var(c_across(Ep.1.24h:Ep.6.24h)),
         mean.Mi.24=mean(c_across(Mi.1.24h:Mi.6.24h)),
         var.Mi.24=var(c_across(Mi.1.24h:Mi.6.24h)),
         mean.Tr.24=mean(c_across(Tr.1.24h:Tr.6.24h)),
         var.Tr.24=var(c_across(Tr.1.24h:Tr.6.24h)),
         mean.Ve.24=mean(c_across(Ve.1.24h:Ve.6.24h)),
         var.Ve.24=var(c_across(Ve.1.24h:Ve.6.24h))) %>% 
         select(mean.Da.3:var.Ve.24)
rownames(mean_vardrug1) <- rownames(filcpm_counts)
write.csv(mean_vardrug1,"data/mean_vardrug1.csv")



```


###  plot by drug  

```{r graph of var by drug indv, fig.height=5, fig.width=5}
mean_vardrug1 <- read.csv("data/mean_vardrug1.csv", row.names = 1)


drug_frame<- mean_vardrug1 %>% 
  rownames_to_column(var = "entrezid") %>% 
  pivot_longer(cols = mean.Da.3:var.Ve.24, names_to = "short", values_to = "values") %>% 
  separate(short, into=c("calc","treatment","time")) %>% 
  mutate(treatment= factor(treatment, levels = c("Do","Ep","Da","Mi","Tr","Ve"),labels = c("DOX","EPI","DNR","MTX","TRZ","VEH"))) %>% 
  mutate(time= factor(time, levels = c("3","24"), labels= c("3 hours","24 hours"))) %>% 
  group_by(treatment, time, calc) %>% 
  as.data.frame



drug_frame %>% 
  filter(calc!="mean") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=FALSE,
              textsize =4,
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("var")+
  ylim(0,0.5)
drug_frame %>% 
  filter(calc!="mean") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=FALSE,
              textsize =4,
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("var")#+
  # ylim(0,0.5)

drug_frame %>% 
  filter(calc!="var") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("TRZ","VEH"),
                                c("MTX","VEH"),
                                c("DNR","VEH"),
                                c("EPI","VEH"),
                                c("DOX","VEH")),
              test= "t.test",
              map_signif_level=FALSE,
              textsize =4,
              step_increase = 0.05)+
  facet_wrap(.~time)+
  ggtitle("Means")+
  ylim(0,18)


```


```{r evaluate eGenes in var}
mean_vardrug1 <- read.csv("data/mean_vardrug1.csv",row.names = 1)
my_exp_genes <- read.csv("data/backGL.txt")
GTEx_genes <- read.csv("data/GTEx_gene_list.csv",row.names = 1)
GTEx <- intersect(GTEx_genes$entrezgene_id,my_exp_genes$ENTREZID)
knowles5 <-readRDS("output/knowles5.RDS")


drug_frame2<- mean_vardrug1 %>% 
  rownames_to_column(var = "entrezid") %>% 
  filter(entrezid %in%knowles5$entrezgene_id) %>% 
  pivot_longer(cols = mean.Da.3:var.Ve.24, names_to = "short", values_to = "values") %>% 
  separate(short, into=c("calc","treatment","time")) %>% 
  mutate(treatment= factor(treatment, levels = c("Do","Ep","Da","Mi","Tr","Ve"),labels = c("DOX","EPI","DNR","MTX","TRZ","VEH"))) %>% 
  mutate(time= factor(time, levels = c("3","24"), labels= c("3 hours","24 hours"))) %>% 
  group_by(treatment, time, calc) %>% 
  as.data.frame

ggplot(drug_frame2, aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.1)+
  # stat_compare_means(method= "anova", label.y=15, label.x =2)+
  facet_wrap(time~calc, scales = "free_y")

  drug_frame2 %>% 
  filter(calc!="mean") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("var using response eGenes")+
  ylim(0,1.0)

drug_frame2 %>% 
  filter(calc!="var") %>% 
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot()+
  geom_signif(comparisons =list(c("TRZ","VEH"),
                                c("MTX","VEH"),
                                c("DNR","VEH"),
                                c("EPI","VEH"),
                                c("DOX","VEH")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.05)+
  facet_wrap(.~time)+
  ggtitle("Means using response eGenes")+
  ylim(0,18)

  
```



```{r data wrangling-evalute variance, message=FALSE, warning=FALSE, eval=FALSE}

organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)

DNR.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Da")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Da")),c_across(starts_with("Ve"))))) 
DOX.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Do")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
 rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Do")),c_across(starts_with("Ve")))))

EPI.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Ep")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
 rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Ep")),c_across(starts_with("Ve")))))

MTX.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Mi")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Mi")),c_across(starts_with("Ve")))))
TRZ.VEH.24 <- organized_drugframe %>% 
  select(c(starts_with("Tr")&ends_with("24h")),
         c(starts_with("Ve")&ends_with("24h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Tr")),c_across(starts_with("Ve")))))

DNR.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Da")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Da")),c_across(starts_with("Ve")))))
DOX.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Do")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Do")),c_across(starts_with("Ve"))))) 
EPI.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Ep")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Ep")),c_across(starts_with("Ve")))))
MTX.VEH.3 <- organized_drugframe %>% 
  select(c(starts_with("Mi")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  rowwise() %>% 
  mutate(data=list(var.test(c_across(starts_with("Mi")),c_across(starts_with("Ve")))))


TRZ.VEH.3 <- organized_drugframe %>% 
  rownames_to_column(.id = "gene") %>% 
  rowwise() %>% 
  select(c(starts_with("Tr")&ends_with("3h")),
         c(starts_with("Ve")&ends_with("3h"))) %>%
  mutate(data=list(var.test(c_across(starts_with("Tr")),c_across(starts_with("Ve")))))

Var_test_list24 <- list(DNR.VEH.24,DOX.VEH.24,EPI.VEH.24,MTX.VEH.24,TRZ.VEH.24)
                      
names(Var_test_list24) <- c('DNR.VEH.24','DOX.VEH.24','EPI.VEH.24','MTX.VEH.24','TRZ.VEH.24')
                    
  
 saveRDS(Var_test_list24,"data/Var_test_list24.RDS")   
 
 
 Var_test_list3 <- list(DNR.VEH.3,DOX.VEH.3,EPI.VEH.3,MTX.VEH.3,TRZ.VEH.3)
                      
names(Var_test_list3) <- c('DNR.VEH.3','DOX.VEH.3','EPI.VEH.3','MTX.VEH.3','TRZ.VEH.3')
                     saveRDS(Var_test_list3,"data/Var_test_list3.RDS") 
```       

```{r extract pvalue list}

                 
organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)
Var_test_list3 <- readRDS("data/Var_test_list3.RDS")
set3 <- names(Var_test_list3)
shorterlist <- Var_test_list3[[1]][[13]]
names(shorterlist) <- rownames(organized_drugframe)

framefun <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set3)){
  a <- set3[i]
    s_list<- Var_test_list3[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$p.value), .id="ENTREZID")
   framefun[paste0(a)] <- hold$`.x$p.value`
 
}
Var_test_list24 <- readRDS("data/Var_test_list24.RDS")
set24 <- names(Var_test_list24) 

framefun24 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set24)){
  a <- set24[i]
    s_list<- Var_test_list24[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$p.value), .id="ENTREZID")
   framefun24[paste0(a)] <- hold$`.x$p.value`
 
}





```


```{r plot pvalue as histo}
framefun %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  ggplot(.,aes(x=p.value,col=drug,fill=drug))+
  geom_histogram()+
  facet_wrap(~drug)+
  ggtitle("3 hour var.test p.value")


framefun24 %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  ggplot(.,aes(x=p.value,col=drug,fill=drug))+
  geom_histogram()+
  facet_wrap(~drug)+
  ggtitle("24 hour var.test p.value")
  


```

```{r gene filtering}
backGL <-read_csv("data/backGL.txt", 
    col_types = cols(...1 = col_skip()))
var3 <- list <- framefun %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  filter(p.value<0.05)

var24 <- list <- framefun24 %>% 
  pivot_longer(col=!ENTREZID,names_to= "combo", values_to = "p.value") %>% 
  separate(combo, into= c("drug", NA,"time")) %>%
  mutate(drug = factor(drug, levels = c("DOX", "EPI", "DNR","MTX", "TRZ"))) %>% 
  filter(p.value<0.05)

DOX_24_var <- var24 %>% filter(drug=="DOX") %>% select(ENTREZID)#1089 
EPI_24_var <- var24 %>% filter(drug=="EPI")%>% select(ENTREZID)#2211
DNR_24_var <- var24 %>% filter(drug=="DNR")%>% select(ENTREZID)#928
MTX_24_var <- var24 %>% filter(drug=="MTX")%>% select(ENTREZID)#269
TRZ_24_var <- var24 %>% filter(drug=="TRZ")%>% select(ENTREZID)#157

geneset_24 <- list(DOX_24_var$ENTREZID, EPI_24_var$ENTREZID, DNR_24_var$ENTREZID, MTX_24_var$ENTREZID, TRZ_24_var$ENTREZID)
names(geneset_24) <- c("DOX_24_var","EPI_24_var","DNR_24_var" ,"MTX_24_var","TRZ_24_var")

DOX_3_var <- var3 %>% filter(drug=="DOX")%>% select(ENTREZID)#346
EPI_3_var <- var3 %>% filter(drug=="EPI")%>% select(ENTREZID)#332
DNR_3_var <- var3 %>% filter(drug=="DNR")%>% select(ENTREZID)#385
MTX_3_var <- var3 %>% filter(drug=="MTX")%>% select(ENTREZID)#277
TRZ_3_var <- var3 %>% filter(drug=="TRZ")%>% select(ENTREZID)#262

geneset_3 <- list(DOX_3_var$ENTREZID,EPI_3_var$ENTREZID,DNR_3_var$ENTREZID ,MTX_3_var$ENTREZID,TRZ_3_var$ENTREZID)
names(geneset_3) <- c("DOX_3_var","EPI_3_var","DNR_3_var" ,"MTX_3_var","TRZ_3_var")


```

### Venn


```{r venn of 24 hours}
library(paletteer)
library(ggVennDiagram)


ggVennDiagram::ggVennDiagram(geneset_24,
              category.names = c("DOX\nn = 1089 ",
                                 "EPI\nn = 2211\n",
                                 "DNR\nn = 928",
                                 "MTX\nn = 269", 
                                "TRZ\nn = 157"),
              show_intersect = FALSE,
              set_color = "black",
              category_size = c(6,6,6,6),
              label = "count",
              label_percent_digit = 1,
              label_size = 4,
              label_alpha = 0,
              label_color = "black",
              edge_lty = "solid", set_size = 4.5)+
  scale_x_continuous(expand = expansion(mult = .3))+
  scale_y_continuous(expand = expansion(mult = .2))+
  scale_color_paletteer_d(palette = "fishualize::Bodianus_pulchellus")+
  scale_fill_distiller(palette="Spectral", direction = -1)+
  labs(title = "24 hour var genes p. value <0.05",
       caption = paste("n =", length(unique(var24$ENTREZID)),"genes"))+
  
  theme(plot.title = element_text(size = rel(1.6), hjust = 0.5, vjust =1))



```
