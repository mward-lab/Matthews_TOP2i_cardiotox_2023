---
title: "Figure 7: AC treatments induce transcriptional variation across individuals over time."
author: "ERM"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: 'show'
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```
```{r packages loading}

library(tidyverse)
library(ggpubr)
library(ggsignif)
library(gprofiler2)
library(paletteer)
library(ggVennDiagram)
library(gridtext)
library(scales)
library(kableExtra)
library(qvalue)
library(data.table)
library(ComplexHeatmap)
```

```{r data loading, message=FALSE, warning=FALSE}
toplistall <- readRDS("data/toplistall.RDS")
siglist <- readRDS("data/siglist_final.RDS")
list2env(siglist, envir = .GlobalEnv)
cpmcounts <- readRDS("data/cpmcount.RDS")
DEG_cormotif <- readRDS("data/DEG_cormotif.RDS")
list2env(DEG_cormotif,envir=.GlobalEnv)
drug_pal_fact <- c("#8B006D" ,"#DF707E", "#F1B72B" ,"#3386DD", "#707031","#41B333")
col_fun5 = circlize::colorRamp2(c(0, 5), c("white", "purple"))
## supplement 1
chrom_reg_Seoane <- read_csv(file = "data/Seonane2019supp1.txt",col_types = cols(...1 = col_skip()))
Seoane_2019 <- chrom_reg_Seoane[,2]
names(Seoane_2019) <- "ENTREZID"
chrom_genes <- (unique(Seoane_2019$ENTREZID))

# supplement 4
Sup4seoane <- read.csv("output/Sup4seoane.csv", row.names = 1)
Sup4genes <- Sup4seoane  %>% 
  filter(pval.expAnth<0.05) %>% 
  distinct(entrez, .keep_all = TRUE) %>% 
  dplyr::select(entrez)

```

## Figure 7: AC treatments induce transcriptional variation across individuals over time.


### A) Mean gene expression
```{r meangene expr}
mean_vardrug1 <- read.csv("data/mean_vardrug1.csv", row.names = 1)


drug_frame<- mean_vardrug1 %>% 
  rownames_to_column(var = "entrezid") %>% 
  pivot_longer(cols = mean.Da.3:var.Ve.24, names_to = "short", values_to = "values") %>% 
  separate(short, into=c("calc","treatment","time")) %>% 
  mutate(treatment= factor(treatment, levels = c("Do","Ep","Da","Mi","Tr","Ve"),labels = c("DOX","EPI","DNR","MTX","TRZ","VEH"))) %>% 
  mutate(time= factor(time, levels = c("3","24"), labels= c("3 hours","24 hours"))) %>% 
  group_by(treatment, time, calc) %>% 
  as.data.frame



drug_frame %>% 
  filter(calc!="var") %>% 
  ggplot(., aes(x= treatment, y=values,fill=treatment))+
  geom_boxplot(outlier.shape=NA)+
  geom_signif(comparisons =list(c("TRZ","VEH"),
                                c("MTX","VEH"),
                                c("DNR","VEH"),
                                c("EPI","VEH"),
                                c("DOX","VEH")),
              test= "t.test",
              tip_length = 0.01,
              map_signif_level=FALSE,
              textsize =4,
              y_position=11,
              step_increase = 0.05)+
  facet_wrap(.~time)+
  ggtitle("Means")+
  ylim(0,18)+
 scale_fill_manual(values=drug_pal_fact)+
  theme_bw()+
  xlab(" ")+
  ylab(expression("counts log"[2]~"cpm "))+
  theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "mm"),face = "bold"))



```


### B) Variance in gene expression

```{r graph of var by drug indv, fig.height=5, fig.width=6}


drug_pal_fact <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")

drug_frame %>% 
  filter(calc!="mean") %>% 
  ggplot(., aes(x= treatment, y=values, fill=treatment))+
  geom_boxplot(outlier.shape=NA)+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              tip_length = 0.01,
              map_signif_level=FALSE,
              textsize =4,
              y_position=0.85,
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("Variance")+
  coord_cartesian(ylim = c(0,1))+
  # ylim(0,2)+
scale_fill_manual(values=drug_pal_fact)+
  theme_bw()+
  xlab(" ")+
  ylab(expression("variance of log "[2]~" cpm "))+
  theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "mm"),face = "bold"))

drug_frame %>% 
  filter(calc!="mean") %>%
  ggplot(., aes(x= treatment, y=values))+
  geom_boxplot(outlier.shape=NA)+
  geom_signif(comparisons =list(c("DOX","VEH"),
                                c("EPI","VEH"),
                                c("DNR","VEH"),
                                c("MTX","VEH"),
                                c("TRZ","VEH")),
              test= "t.test",
              map_signif_level=FALSE,
              textsize =4,
               y_position=(.5),
              step_increase = 0.1)+
  facet_wrap(~time)+
  ggtitle("var")#+
  # ylim(0,0.5)


```



### C) Pairwise correlation of drug response variance

```{r FSTAT corr, fig.height=7, fig.width=7}

organized_drugframe <- read.csv("data/organized_drugframe.csv",
                                row.names = 1)
Var_test_list3 <- readRDS("data/Var_test_list3.RDS")
#Is the data normally distributed?

set3 <- names(Var_test_list3)
shorterlist <- Var_test_list3[[1]][[13]]
names(shorterlist) <- rownames(organized_drugframe)

statfun3 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set3)){
  a <- set3[i]
    s_list<- Var_test_list3[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$statistic), .id="ENTREZID")
   statfun3[paste0(a)] <- hold$`.x$statistic`
 
}

Var_test_list24 <- readRDS("data/Var_test_list24.RDS")
set24 <- names(Var_test_list24) 

statfun24 <- data.frame(ENTREZID=rownames(organized_drugframe))
for (i in 1:length(set24)){
  a <- set24[i]
    s_list<- Var_test_list24[[i]][[13]]
  names(s_list) <- rownames(organized_drugframe)
  hold<- map_df(s_list, ~as.data.frame(.x$statistic), .id="ENTREZID")
   statfun24[paste0(a)] <- hold$`.x$statistic`
 
}


Fstatcor <- statfun24 %>% 
  full_join(., statfun3, by="ENTREZID") %>% 
   column_to_rownames('ENTREZID') %>% 
   # as.matrix(.) %>% 
   # rowwise() %>% 
   cor(., method="spearman")


 col_fun <- circlize::colorRamp2(c(-1,0, 1), c("blue","white", "red"))
 
mat_colF <- data.frame(time= c(rep("24 hours",5), rep("3 hours",5)), class= (c("AC","AC","AC","nAC","nAC","AC","AC","AC","nAC","nAC")),TOP2i=c(rep("yes",4), "no", rep("yes",4),"no"))

rownames(mat_colF) <- colnames(Fstatcor)



mat_colors <- list(time=c("chocolate4", "pink"), class=c("yellow1","lightgreen"), TOP2i =c("darkgreen","goldenrod"))

names(mat_colors$time) <- unique(mat_colF$time)
names(mat_colors$class) <- unique(mat_colF$class)
names(mat_colors$TOP2i) <- unique(mat_colF$TOP2i)
         
ha <- HeatmapAnnotation(df=mat_colF, col=mat_colors)

   Heatmap(Fstatcor, 
           column_title = "3 & 24 hr F stat corr", 
           col=col_fun,
          top_annotation = ha,
           cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%.2f", Fstatcor[i, j]), x, y, gp = gpar(fontsize = 10))})

   
 
```
More analysis of the variablity in gene expression can be found [at this link](https://mward-lab.github.io/Matthews_TOP2i_cardiotox_2023/variance_scrip.html).
