---
title: "Dose-Response analysis"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```

This is my Dose-Response curve analysis and data with summaries.\
I hope to explain what and how I did things for future analysis, so that the code and data are reproducible. All data was created by treating cardiomyocytes at \~day 27 of diff with 0.01-50 $\mu$M concentrations of the following drugs:\
Daunorubicin (DNR)\
Doxorubicin (DOX)\
Epirubicin (EPI)\
Mitoxantrone (MTX)\
Trastuzumab (TRZ)\
[ note: TRZ could only be used at concentrations of 10 $\mu$M and lower]\
Vehicle (VEH)

VEH is effectively the same media, however water is added in volumes equivalent to the volume used to dilute the drugs in a 10 mM stock concentration. This is why it has values at different concentrations and why I analyze the data this way.

Cell viability was assessed using Presto Blue reagent according to manufacturer's protocols.\
90 uL of Galactose media + 10 uL of Presto Blue reagent were added to each well of the 96 well DRC plate for one hour. The cell media was then extracted to a black, clear bottom plate and wrapped in foil and stored at 4 degrees overnight. A plate reader was used to measure florescence intensity and the relative fluorescent (RFLU) values were exported to an excel file.

Analysis was done as follows:

1.  The background wells containing media + reagent only were averaged and the average value was subtracted from every well on the plate. Because the wells on the plate were randomized, matching the treatment with the wells is critical and was done inefficiently in an excel file for each experiment.

2.  Percent Viability was calculated by averaging the RFLU from the vehicle at each concentration, and dividing each drug's RFLU at that concentration by the Vehicle control average RFLU to give a ratio. All values less than 0 were turned into zero in the excel document, and a final compilation for each differentiation and dose curve treatment was stored in an document called DRC_compilation.xlsx. ( note: I spelled incorrectly in my computer)

3.  For calculation to control for plate to plate variance, the "Empty_Blank" well RFLU2 values from each plate within an experiment were averaged.\
    eg:

    Step 1.  plate 1= empty average RFLU2 = 29000,

    Step 2.  plate 2 empty average RFLU2 =31000 normalized ratio plate 1/plate 2 or 29000/31000 =0.9355

    Step 3.  This normalization ratio then was divided into every RFLU2 value on plate 1. Plate 2 would be divided by 1 to keep the formulas consistent (31000/31000 or plate2/plate2) to create a column that contained the adjusted RFLU2 values, called "adj".

4.  Calculations then proceed as described originally. The first viability value is called "Percent". The adjusted value for intra-plate differences is called "Padj" although this use was later deprecated.

Part 2 of the analysis of data begins by entering data from the excel compilation to R. The data is stored as an excel file, which was then stored as an .RDS object for analysis retrieval.

Step 1 in R is loading the libraries needed for analysis:

```{r Libraries to load, echo=TRUE, message=FALSE, warning=FALSE}
library(car)
library(tidyverse)
library(tinytex)
library(BiocGenerics)
library(data.table)
library(drc)
library(Hmisc)
library(cowplot)
library(grid)
library(ggsignif)
library(RColorBrewer)
library(broom)

```

Step 2 is importing the data from the DRC_compilation.xlsx file. The data was imported and then stored as a data table in R.

Step 3:

The files have a list of similar names:Â 

-   'Drug' which is the short name of drug used

-   'Conc' which is the concentration of drug added (in microMolar);

-   'Sname' the abbreviated name of Drug and Conc;

-   'Well' letter with two number format 'Row' \# 1-8 for A-G 'Column' numbers 1-12;

-   'Plate' will vary between one and three;

-   'RFLU' the RFLU from the 0 hour reading with background subtracted (not all experiments have them);

-   'RFLU2' the RFLU from the 48 hour reading with background subtracted.

I streamlined the data into more simple formats:

-   Individual 1 is cell line 75-1 (D04_75_1,D05_75_1 )

-   Individual 2 is cell line 87-1 (D04_87_1, D05_87_1)

-   Individual 3 is cell line 77-1 (D02_77_1, D03_77_1)

-   Individual 4 is 79-1 (D04_79_1, D05_79_1)

-   Individual 5 is 78-1 (D01_78_1, D03_78_1)

-   Individual 6 is 71-1 (D02_71_1, DJAG_71_1)

    -   As of 6-2-22 I am implementing a new naming for R handles:\
        ind1a, ind1b etc, to make sure I process out the "empty_blanks"

        I am also converting 'Conc' column to numeric

Step 4: File cleanup first subsets each file imported by taking out the 'Empty' samples in the Drug column and then renaming the file to individual names and DRC a and b

A data-frame called DRC48hoursdata.csv is complied from each of the experiments above and is the "final" table stored in the data folder.

## Loading the data into R

```{r loading RDS data, message=FALSE, warning=FALSE}

drug_pal_fact <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")
full_list <- read.csv("data/DRC48hoursdata.csv", row.names = 1)

```

Once they are all in a data frame, a few thing need to be defined for other function like ggplot.

```{r list_holder, message=FALSE, warning=FALSE, include=TRUE}
daunls <- list() ###daunorubicin list
doxols <- list() ### doxorubicin list
epils <- list() ###epirubicin list
mitols <- list() ###mitoxantrone list
trasls <- list() ###trastuzmab list
vehls <- list() ###vehicle list
# name <- c( "Veh","Daun", "Doxo","Epi", "Mito", "Tras")### text list of drugs
```

## Viability

```{r Viability data, echo=TRUE, message=FALSE, warning=FALSE}
### to extract parameters for mapping

averageFL <-   full_list %>%
  na.omit()%>% 
    mutate(sDrug=Drug) %>% 
    mutate(sDrug=case_match(Drug,"Daun"~"DNR",
                            "Doxo"~"DOX",
                            "Epi"~"EPI",
                            "Mito"~"MTX",
                            "Tras"~"TRZ",
                            "Veh"~ "VEH", .default= Drug)) %>%
    group_by(SampleID, sDrug,Conc) %>%
    mutate(sDrug=factor(sDrug, levels = c('DOX','EPI','DNR','MTX','TRZ','VEH'))) %>% 
    dplyr::summarize(Mean = mean(Percent))
# saveRDS(averageFL,"data/averageviabilitytable.RDS")

  averageFL %>%
    ungroup() %>% 
    mutate(indv=substr(SampleID,4,4)) %>%
    mutate(indv=factor(indv, levels= c('1','2','3','4','5','6'))) %>% 
    filter(Conc <5) %>% 
    mutate(Conc= factor(as.numeric(Conc))) %>% 
    group_by(indv,sDrug,Conc) %>% 
    dplyr::summarize(Viability=mean(Mean)) %>%
    ungroup() %>% 
    ggplot(.,  aes(x=sDrug, y= Viability*100 )) +
    geom_boxplot(position="dodge", outlier.colour = "transparent",
                 aes(fill=sDrug))+
    geom_point(aes(color=indv))+
    guides(alpha = "none")+
    ylim(0,150.5)+
    scale_color_brewer(palette = "Dark2",
                       guide="legend",
                       name ="Individual", 
                       labels(c(1,2,3,4,5,6)))+
    scale_fill_manual(values=drug_pal_fact, name ="Treatment")+
    theme_classic() +
    # geom_hline(yintercept = 1,lty = 4)+
    ylab("Viability") +
    facet_wrap(~Conc)+ 
    ggtitle("Viablity across concentrations at 48 hours")+
    theme(axis.title=element_text(size=10),
          axis.ticks=element_line(size =2),
          axis.text=element_text(size=9, face = "bold"),
          panel.grid.major = element_line(colour = 'darkgrey'),
          panel.border=element_rect(fill = NA, size = 2),
          plot.title = element_text(hjust = 0.5, size =15, face = "bold"))
   
```

```{r viablity by drug, echo=TRUE, message=FALSE, warning=FALSE}

averageFL %>% 
  ungroup() %>% 
  mutate(indv=substr(SampleID,4,4)) %>%
  mutate(indv=factor(as.numeric(indv))) %>% 
  filter(Conc<5) %>% 
  group_by(indv,sDrug,Conc) %>% 
  dplyr::summarize(Viability=mean(Mean)) %>% ungroup() %>% 
  ggplot(.,  aes(x=as.factor(Conc), y= Viability*100 )) +
  geom_boxplot(position="dodge",outlier.colour="transparent", aes(fill=sDrug))+
  geom_point(aes(color=indv))+
  guides(alpha = "none")+
  ylim(0,150.5)+
  scale_color_brewer(palette = "Dark2",guide="legend",
                     name = "Individual",labels(c(1,2,3,4,5,6)))+
  scale_fill_manual(values=drug_pal_fact, name = "Treatment")+
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Viability") +
  facet_wrap(~sDrug)+ 
  ggtitle("Viablity across drugs at 48 hours")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=9, face = "bold"),
        panel.grid.major = element_line(colour = 'darkgrey'),
        panel.border=element_rect(fill = NA, size = 2),
        plot.title = element_text(hjust = 0.5, size =15, face = "bold"))
```
The above codes can be altered to include ALL concentrations.

## Ploting the DRC

Making the Dose-response curve involved averaging the quadruplicates at each concentration for each curve analyzed.  

I broke up the full list into treatments and replicates.
DA, DX, EP, MT, TR, and VE objects stored the mean viability tables, and \

DA2, DX2, EP2, MT2, TR2, and VE2 contain all the data points for generation of the confidence intervals later in the analysis.
```{r making filtered data, echo=TRUE}
avg_via <- averageFL %>%
    ungroup() %>% 
    mutate(indv=substr(SampleID,4,4)) %>%
    mutate(indv=factor(indv, levels= c('1','2','3','4','5','6'))) %>% 
    group_by(indv,sDrug,Conc) %>% 
    dplyr::summarize(Viability=mean(Mean))

updated_list <- full_list %>%
  na.omit()%>% 
  mutate(sDrug=Drug) %>% 
  mutate(sDrug=case_match(Drug,"Daun"~"DNR",
                            "Doxo"~"DOX",
                            "Epi"~"EPI",
                            "Mito"~"MTX",
                            "Tras"~"TRZ",
                            "Veh"~ "VEH", .default= Drug)) %>%
    group_by(SampleID, sDrug,Conc) %>%
    mutate(indv=substr(SampleID,4,4)) %>%
    mutate(indv=factor(as.numeric(indv))) %>% 
    mutate(sDrug=factor(sDrug, levels = c('DOX','EPI','DNR','MTX','TRZ','VEH'))) 



DA <- avg_via %>% filter(sDrug == "DNR")
DX <- avg_via %>% filter(sDrug =="DOX")
EP <- avg_via %>% filter(sDrug =="EPI")
MT <- avg_via %>% filter(sDrug =="MTX")
TR <- avg_via %>% filter(sDrug =="TRZ")
VE <- avg_via%>% filter(sDrug =="VEH")

DA2 <- updated_list %>% filter(sDrug == "DNR")
DX2 <- updated_list %>% filter(sDrug =="DOX")
EP2 <- updated_list %>% filter(sDrug =="EPI")
MT2 <- updated_list %>% filter(sDrug =="MTX")
TR2 <- updated_list %>% filter(sDrug =="TRZ")
VE2 <- updated_list%>% filter(sDrug =="VEH")

```


The code below is an explanation of the ggplot code I used to plot the DRC by individual.  This uses the two mean viability values from DRC1 and biological replicate DRC2, as input to generate the Dose-response curve for each treatment/individual combination.
```{r sample plot code, echo = TRUE, eval=FALSE, message=FALSE, warning=FALSE, include=TRUE}
ggplot(DA, 
       aes(x=Conc, y= Viability, color =indv,alpha =0.4)) +
  guides(color="none", alpha = "none")+  #guides turned off for group plotting
  stat_smooth(method = "drm", ## This code calls DRM inside ggplot2
              method.args = list(fct = L.4(c(NA,NA,1,NA))), se = FALSE)+  #note: fct means function, and L.4 stands for 4 parameter log-logistic curve  I have set at 1 for upper-limit and left the rest 'free'
  ylim(0,1.5)+ #setting the limits so everything with graph
  scale_color_brewer(palette = "Dark2")+ #adding color of choice
  scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +  # looks pretty
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Percent viability/100") +
  ggtitle("Daunorubicin")+
  theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"),
        axis.title=element_text(size=10),
        axis.ticks=element_line(linewidth =2),
        axis.text=element_text(size=10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border=element_rect(fill = NA, linewidth = 2),
        plot.background = element_rect(fill = "white", colour = NA))
      

```

The code above is used multiple times and output values are stored into an R object, so I can later combine the group into one full plot. 

```{r daunplot, echo=TRUE, message=FALSE, warning=FALSE}

daplot <-
  ggplot(DA,aes(x=Conc, y= Viability, 
                 color = indv)) +
  stat_smooth(method = "drm", 
                method.args = list(fct = L.4(c(NA,NA,1,NA))), 
              se = FALSE)+
  ylim(0,1.5)+
  scale_color_brewer(palette = "Dark2")+
  guides(color="none")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+#expression(paste("Concentration [", mu, "M]")))+
    ylab(NULL) +
    ggtitle("DNR")+
    theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"),
          axis.title=element_text(size=10),
          axis.ticks=element_line(linewidth =2),
          axis.text=element_text(size=10, face = "bold"),
          panel.grid.major = element_line(colour = 'lightgrey'),
          panel.border=element_rect(fill = NA, linewidth = 2),
          plot.background = element_rect(fill = "white", colour = NA))
      

```

```{r doxplot,  echo=TRUE, message=FALSE, warning=FALSE}

dxplot <-
  ggplot(DX,aes(x=Conc, y= Viability, 
                 color = indv)) +
  stat_smooth(method = "drm", 
                method.args = list(fct = L.4(c(NA,NA,1,NA))), 
              se = FALSE)+
  ylim(0,1.5)+
  scale_color_brewer(palette = "Dark2")+
  guides(color=guide_legend(title="Treatment"))+
  guides(color="none")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle("DOX")+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))

```

```{r epiplot, echo=TRUE, message=FALSE, warning=FALSE}

epplot <- 
  ggplot(EP, 
         aes(x=Conc, y= Viability, color = indv)) +
  stat_smooth(method = "drm",
              method.args = list(fct = L.4(c(NA,NA,1,NA))), se = FALSE)+
  ylim(0,1.5)+
  scale_color_brewer(palette = "Dark2")+
  guides(color="none")+
  scale_x_log10() +  
  theme_classic() +
  scale_color_brewer(palette = "Dark2")+
  xlab(NULL)+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
  ggtitle("EPI")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(linewidth = 2),
        axis.text=element_text(size=10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border=element_rect(fill = NA, linewidth = 2),
        plot.background = element_rect(fill = "white", colour = NA))

```

```{r Mitoplot,  echo=TRUE, message=FALSE, warning=FALSE}
  
mtplot <- 
  ggplot(MT, 
         aes(x=Conc, y= Viability, color = indv)) +
  stat_smooth(method = "drm",
              method.args = list(fct = L.4(c(NA,NA,1,NA))), se = FALSE)+
  ylim(0,1.5)+
  scale_color_brewer(palette = "Dark2")+
  guides(color="none")+
  scale_x_log10() +
  scale_color_brewer(palette = "Dark2")+
  theme_classic() +
  xlab(NULL)+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face="bold"))+
  ggtitle("MTX")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(linewidth = 2),
        axis.text=element_text(size=10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border=element_rect(fill = NA, linewidth =  2),
        plot.background = element_rect(fill = "white", colour = NA))
      
 
```

```{r trasplot,  echo=TRUE, message=FALSE, warning=FALSE}
##creating legend for full plot

leg <- ggplot(TR, aes(x=Conc, y= Viability, color = indv, alpha = 0.6)) +
          geom_line( size=2)+
          theme_classic() +
  guides(alpha = "none")+
      scale_color_brewer(palette = "Dark2",labels = c("1", "2", "3","4","5","6"))+
        labs(color = "Individual", linewidth=3)
    
trplot <-
  ggplot(TR, 
        aes(x=Conc, y= Viability, color = indv)) +
  stat_smooth(method = "drm", 
              method.args = list(fct = L.4(c(NA,1,NA,NA))), se = FALSE)+
  ylim(0,1.5)+
  scale_color_brewer(palette = "Dark2")+
  guides(color="none")+
  scale_x_log10() + 
  theme_classic() +
  scale_color_brewer(palette = "Dark2")+
  xlab(expression(paste("Concentration ", mu, "M")))+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"))+
  ggtitle("TRZ")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border=element_rect(fill = NA, size = 2),
        plot.background = element_rect(fill = "white", colour = NA))
 
```

```{r control plot, echo=TRUE, message=FALSE, warning=FALSE}

veplot <- 
  ggplot(VE,
         aes(x=Conc, y= Viability, color = indv)) +
  stat_smooth(method = "drm", 
              method.args = list(fct = L.4(c(NA,NA,NA,NA))), se = FALSE)+
  ylim(0,1.5)+
  scale_color_brewer(palette = "Dark2")+
  guides(color="none")+
  scale_x_log10() +  
  theme_classic() +
  xlab(expression(paste("Concentration ", mu, "M"))) +
  ylab(NULL) +
  ggtitle("VEH") +
  theme(plot.title = element_text(hjust = 0.5, size = 15, face = "bold"))+
  theme(axis.title = element_text(size = 10),
        axis.ticks = element_line(linewidth =  2),
        axis.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border = element_rect(fill = NA, linewidth = 2),
        panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white", colour = NA))

```

### plot all together!

```{r plot together, eval=TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.width=10}
## take a legend from a plot
legend_b <- ggpubr::get_legend(leg)

ggpubr::as_ggplot(legend_b)

plan2 <-  plot_grid(daplot,dxplot,epplot,mtplot, trplot,veplot,legend_b,ncol =4)

plan2
```



### LD50 and slope extraction (First try)

Now I want to extract from the model, the slope and LD50 calculated by the dose-response model.  I make several lists to store the info into.
```{r extracting with drm, echo=TRUE, message=FALSE, warning=FALSE}
daunls <- list() ###daunorubicin list
dnr_sl <- list() ##slope
doxols <- list() ### doxorubicin list
dox_sl <- list()
epils <- list() ###epirubicin list
epi_sl <- list()
mitols <- list() ###mitoxantrone list
mtx_sl <- list()
trasls <- list() ###trastuzmab list
trz_sl <- list()
vehls <- list() ###vehicle list
veh_sl <- list()
ID <- c("ind1a",
        "ind1b",
        "ind2a",
        "ind2b",
        "ind3a",
        "ind3b",
        "ind4a",
        "ind4b",
        "ind5a",
        "ind5b",
        "ind6a",
        "ind6b")

```

Then I run the complete samples without averaging, to get the LD50s from each replicate and individual. The values are stored in several files. Slope values are in the \*_sl dataframes, LD50 are in the \*ls dataframes and confidence intervals are in the \*_intv dataframes.
```{r daun stuff, message=FALSE, warning=FALSE, echo=TRUE}
da_confint <- list()
for(k in ID){
thingda <-  filter(DA2, SampleID==k)
  thingda.m <- drm(Percent~Conc, data = thingda, fct=LL.4(c(NA, NA,1, NA),names=c("Slope", "Lower Limit","Upper Limit","ED50")))
  dnr_sl[k] <- thingda.m$fit$par[1]
  daunls[k] <- thingda.m$fit$par[3]
  da_confint[paste0(k)]<-list(predict(thingda.m, interval="confidence"))
}
DNR_intv <- map_df(da_confint, ~as.data.frame(.x), .id="indv")
DNR_intv$Conc <- DA2$Conc
```

```{r DOX,  message=FALSE, warning=FALSE, echo=TRUE}

 dx_confint<-list()

for(k in ID){  
thingdx <-  filter(DX2, SampleID==k)
  thingdx.m <- drm(Percent~Conc, data = thingdx, fct=LL.4(c(NA, NA,1, NA),names=c("Slope","Lower Limit","Upper Limit","ED50")))
  dox_sl[k] <- thingdx.m$fit$par[1]
  doxols[k] <-thingdx.m$fit$par[3]
  dx_confint[paste0(k)]<-list(predict(thingdx.m,interval="confidence"))
}

DOX_intv <- map_df(dx_confint, ~as.data.frame(.x), .id="indv")
DOX_intv$Conc <- DX2$Conc


```

```{r EPI,  message=FALSE, warning=FALSE, echo=TRUE}
 ep_confint<-list()
 for(k in ID){ 
 thingep <-  filter(EP2, SampleID==k)
  thingep.m <- drm(Percent~Conc, data = thingep, fct=LL.4(c(NA, NA,1, NA),names=c("Slope", "Lower Limit","Upper Limit","ED50")))
  epi_sl[k] <- thingep.m$fit$par[1]
  # onione <- ED(thingep.m, c(50), interval = "delta")
  epils[k] <- thingep.m$fit$par[3]
  # print(paste0(k, " Epirubicin"))
  ep_confint[paste0(k)]<-list(predict(thingep.m,interval="confidence"))
 }

EPI_intv <- map_df(ep_confint, ~as.data.frame(.x), .id="indv")
EPI_intv$Conc <- EP2$Conc
```

```{r MTX,  message=FALSE, warning=FALSE, echo=TRUE}
 mt_confint<-list()
for(k in ID){
  thingmt <-  filter(MT2, SampleID==k)
  thingmt.m <- drm(Percent~Conc, data = thingmt, fct=LL.4(c(NA,NA,1, NA),names=c("Slope","Lower Limit","Upper Limit", "ED50")))
  mtx_sl[k] <- thingmt.m$fit$par[1]
  # onionm <- ED(thingmt.m, c(50), interval = "delta")
  mitols[k] <- thingmt.m$fit$par[3]
  # print(paste0(k, " Mitoxantrone"))
  mt_confint[paste0(k)]<-list(predict(thingmt.m,interval="confidence"))
}
MTX_intv <- map_df(mt_confint, ~as.data.frame(.x), .id="indv")
MTX_intv$Conc<- MT2$Conc 
  
  
```

Note:  Could not get numbers to plot for TRZ and VEH
```{r TRZ,  message=FALSE, warning=FALSE, echo=TRUE}
 tr_confint<-list()
for(k in ID){
  thingtr <-  filter(TR2, SampleID==k)
  try(thingtr.m <- drm(Percent~Conc, 
                       data = thingtr, fct=L.4(c(NA, NA,1,NA), names=c("Slope","Lower Limit","Upper Limit", "ED50")))) 
  try(trz_sl[k] <- thingtr.m$fit$par[1])
  try(trasls[k] <- thingtr.m$fit$par[3])
  try(tr_confint[paste0(k)]<-list(predict(thingtr.m,interval="confidence")))
         }
 
TRZ_intv <- map_df(tr_confint, ~as.data.frame(.x), .id="indv")
TRZ_intv$Conc <- TR2$Conc
```

```{r VEH, message=FALSE, warning=FALSE}
 ve_confint<-list()
for(k in ID){
  thingve <-  filter(VE2, SampleID==k)
  try(thingve.m <- tryCatch(drm(Percent~Conc, data = thingve, fct=L.4(c(0, NA,NA,NA),names=c("Slope","Lower Limit","Upper Limit", "ED50")))))
  try(veh_sl[k] <- thingve.m$fit$par[1])
  try(vehls[k] <- thingve.m$fit$par[3])
  try(ve_confint[paste0(k)]<-list(predict(thingve.m,interval="confidence")))
}
VEH_intv <- map_df(ve_confint, ~as.data.frame(.x), .id="indv")
VEH_intv$Conc <- VE2$Conc

```

## DRC replicates

How reproducible are each of the DRCs?  here I plot several to see how the overlap is working.  Each replicate for each Treatment set is ploted
```{r pulldrc individuals, echo= TRUE,message=FALSE, warning=FALSE}
pull_drc <- data.frame(individual=c('ind1','ind2','ind3','ind4','ind5','ind6'))
pull_drc2 <- data.frame("ind1", "ind2","ind3","ind4","ind5","ind6")
doubl_plot <- data.frame("ind3a", "ind3b", "ind5a", "ind5b")

for (each in 1:6){
  newdata <- DNR_intv %>% 
   filter(indv==paste0(pull_drc2[[each]],'a')|
                         indv==paste0(pull_drc2[[each]],'b')) %>% 
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))
     f <- DA2 %>% filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>% 
   ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
  guides(color="none", alpha = "none")+
      geom_ribbon(data = newdata, aes(x = Conc, y = Prediction, ymin = Lower, ymax = Upper, fill=indv),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.4,1.5)+
      scale_color_brewer(palette = "Dark2")+
       scale_fill_brewer(palette = "Dark2")+
       scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
        # scale_y_continuous( expand = expansion(mult = .1)) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Daunorubicin individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(f)
} 
```

```{r DXpulls, echo=FALSE, message=FALSE, warning=FALSE}

for (each in 1:6){

  newdata <- DOX_intv %>%
    filter(indv==paste0(pull_drc2[[each]],'a')|
                         indv==paste0(pull_drc2[[each]],'b')) %>% 
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))
  
  g <- DX2 %>% filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>%
    
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))%>% 
   ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
 
      geom_ribbon(data = newdata, aes(x = Conc, y = Prediction, ymin = Lower, ymax = Upper, fill=factor(indv)),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.2,1.5)+
     guides(color="none", alpha = "none", fill="none")+
      # scale_y_continuous( expand = expansion(mult = .1)) +
      scale_color_brewer(palette = "Dark2")+
    scale_fill_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Doxorubicin individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(g)
} 

```

```{r epi plots, message=FALSE, warning=FALSE}
for (each in 1:6){
  
  newdata <- EPI_intv %>%
    filter(indv==paste0(pull_drc2[[each]],'a')|
                         indv==paste0(pull_drc2[[each]],'b')) %>% 
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))
  
  ep<- EP2 %>% 
    filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>% 
    ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
    geom_ribbon(data = newdata, aes(x = Conc, y = Prediction, ymin = Lower, ymax = Upper, fill=indv),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.4,1.5)+
    guides(color="none", alpha = "none", fill="none")+
      scale_color_brewer(palette = "Dark2")+
     scale_fill_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Epirubicin individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(ep)
} 
```

```{r mtrep, message=FALSE, warning=FALSE}
for (each in 1:6){
  
  newdata <- MTX_intv %>%
    filter(indv==paste0(pull_drc2[[each]],'a')|
                         indv==paste0(pull_drc2[[each]],'b')) %>% 
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))
  
  mt<-MT2 %>% 
    filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>% 
    ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
    geom_ribbon(data = newdata, aes(x = Conc, y = Prediction, ymin = Lower, ymax = Upper, fill=indv),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.4,1.5)+
    guides(color="none", alpha = "none", fill="none")+
      scale_color_brewer(palette = "Dark2")+
     scale_fill_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Mitoxantrone individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(mt)
} 
```

```{r tras rep, message=FALSE, warning=FALSE}

for (each in 1:6){
   newdata <- TRZ_intv %>%
    filter(indv==paste0(pull_drc2[[each]],'a')|
                         indv==paste0(pull_drc2[[each]],'b'))%>% 
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))
  
  tr<-TR2 %>% 
    filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>% 
    ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
    geom_ribbon(data = newdata, aes( y = Prediction, ymin = Lower, ymax = Upper, fill=indv),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.4,1.5)+
    guides(color="none", alpha = "none", fill="none")+
      scale_color_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Trastuzumab individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(tr)
} 
```

```{r veh rep}

for (each in 1:6){
  newdata <- VEH_intv %>%
    filter(indv==paste0(pull_drc2[[each]],'a')|
                         indv==paste0(pull_drc2[[each]],'b'))%>% 
    mutate(indv=factor(indv,levels=c(paste0(pull_drc2[[each]],'a'),paste0(pull_drc2[[each]],'b'))))
  
  ve<-VE2 %>% 
    filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>% 
    ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
    geom_ribbon(data = newdata, aes( y = Prediction, ymin = Lower, ymax = Upper, fill=indv),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.4,1.5)+
    guides(color="none", alpha = "none", fill="none")+
      scale_color_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Vehicle individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(ve)
 } 
```

```{r boxplot of slope, message=FALSE, warning=FALSE, include= FALSE}
library(ggsignif)

slope_table <- read.csv("data/slope_table.csv",row.names = 1)
avg_slope <- slope_table %>% 
  rownames_to_column() %>% 
  as.tibble()%>% 
  mutate(rowname=case_match(rowname,'1'~'DNR','2'~'DOX','3'~'EPI','4'~'MTX', .default = rowname))%>% 
  pivot_longer(!rowname,names_to = 'indv', values_to = 'slope') %>% 
  mutate(indv=str_sub(indv, 4,4)) %>% 
  group_by(rowname,indv) %>% 
  mutate(rowname=factor(rowname, levels = c('DOX','EPI','DNR','MTX','TRZ','VEH'))) %>% 
  summarise_at(vars(slope),list(name = mean))



ggplot(avg_slope, aes(x=rowname, y=name))+
  geom_boxplot(position="dodge", aes(fill=rowname))+
    geom_point(aes(color=indv))+
    guides(alpha = "none")+
    scale_color_brewer(palette = "Dark2",guide="legend",name = "Individual",labels(c(1,2,3,4,5,6)))+
    scale_fill_manual(values=drug_pal_fact)+
    theme_classic() +
    ylab("average slope") +
  xlab("")+
    geom_signif(comparisons =list(c("MTX","DOX"),
                                  c("EPI","DOX"),
                                  c("DNR","DOX")),
                test= "t.test",
                map_signif_level=TRUE,
                textsize =4,
                step_increase = 0.1)+
    ggtitle("Average slope between treatments")+
    theme(axis.title=element_text(size=10),
          axis.ticks=element_line(size =2),
          axis.text=element_text(size=9, face = "bold"),
          panel.grid.major = element_line(colour = 'darkgrey'),
          panel.border=element_rect(fill = NA, size = 2),
          plot.title = element_text(hjust = 0.5, size =15, face = "bold"))
```

## LD50 correlation
```{r LD50 correlation, fig.keep='all',eval=TRUE, message=FALSE, warning=FALSE, include=FALSE}
  
LD50_table <- read.csv("data/ld50_table.csv",row.names = 1)


saveup <- LD50_table %>% 
  rownames_to_column() %>% 
  as.tibble()%>% 
  mutate(rowname=case_match(rowname,'1'~'DNR','2'~'DOX','3'~'EPI','4'~'MTX', .default = rowname))%>% 
  pivot_longer(!rowname,names_to = 'indv', values_to = 'ld50') %>% 
  mutate(indv=str_sub(indv, 4,4)) %>% 
  group_by(rowname,indv) %>% 
  summarise_at(vars(ld50),list(name = mean)) %>% 
  as.data.frame()

extractframe <- saveup %>% 
  pivot_wider(id_cols=indv, 
              names_from = rowname, 
              values_from = name) %>% as.data.frame

saveup %>% 
  pivot_wider(id_cols=indv, 
              names_from = rowname, 
              values_from = name) %>% 
  ggplot(., aes(x=DOX,y=DNR))+
  geom_point(aes(color=indv, size=4))+
  geom_smooth(method="lm")+
  theme_bw()+
  scale_color_brewer(palette = "Dark2",name = "Individual", label = c("1","2","3","4","5","6"))+
  ggpubr::stat_cor(method="pearson",
                   # cor.coef.name="rho",
                   aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
                   color = "red")+
  theme(axis.title = element_text(size = 15, 
                                  color = "black"),
        axis.ticks = element_line(size = 1.5),
        axis.text = element_text(size = 8, 
                                 color = "black"),
        strip.text.x = element_text(size = 15,
                                    color = "black",
                                    face = "bold"))

saveup %>% 
  pivot_wider(id_cols=indv, names_from = rowname, values_from = name) %>% 
  ggplot(., aes(x=DOX,y=EPI))+
  geom_point(aes(color=indv, size=4))+
  geom_smooth(method="lm")+
  theme_bw()+
  scale_color_brewer(palette = "Dark2",name = "Individual", label = c("1","2","3","4","5","6"))+
  ggpubr::stat_cor(method="pearson",
                   # cor.coef.name="rho",
                   aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
                   color = "red")+
  theme(axis.title = element_text(size = 15, 
                                  color = "black"),
        axis.ticks = element_line(size = 1.5),
        axis.text = element_text(size = 8, 
                                 color = "black"),
        strip.text.x = element_text(size = 15,
                                    color = "black",
                                    face = "bold"))

 saveup %>% 
  pivot_wider(id_cols=indv, 
              names_from = rowname, 
              values_from = name) %>% 
  ggplot(., aes(x=DOX,y=MTX))+
  geom_point(aes(color=indv, size=4))+
  geom_smooth(method="lm")+
  theme_bw()+
  scale_color_brewer(palette = "Dark2",name = "Individual", label = c("1","2","3","4","5","6"))+
  ggpubr::stat_cor(method="pearson",
                   aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
                   color = "red")+
  theme(axis.title = element_text(size = 15, 
                                  color = "black"),
        axis.ticks = element_line(size = 1.5),
        axis.text = element_text(size = 8, 
                                 color = "black"),
        strip.text.x = element_text(size = 15,
                                    color = "black",
                                    face = "bold"))

```

##EC50 of breast cancer cell lines

```{r combine LD50 values, echo=TRUE}
###combining all values into a larger dataframe

library(RColorBrewer)
drug_palc <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")

BC_cell_lines <- read.csv("data/BC_cell_lines.csv",row.names = 1)

  
graphBC <- BC_cell_lines %>%
    mutate(Cell_line= factor(Cell_line)) %>% 
  pivot_longer(.,col=!Cell_line,names_to = 'Treatment',values_to = 'LD50') %>% 
  ggplot(., (aes(x = (Treatment), y = log10(LD50)))) +
  geom_boxplot(position = "identity",aes(fill=Treatment))+
  geom_point(aes(color = Cell_line,
                 size = 5,alpha = 0.5)) +
  ggtitle(expression("Breast cancer cell line reported  LD"[50]*"s"))+
  xlab("")+
  ylab(bquote('Log'[10]~ 'LD'[50]~'in '*mu*M))+
  scale_color_brewer(palette = "Spectral",
                     name = "Cell lines")+
          scale_fill_manual(values=drug_palc)+
  ylim(-2,2)+
  theme_bw() + 
  theme(plot.title = element_text(hjust =0.5, size = 18))+
  guides(alpha ="none", size = "none", fill= "none")+
  #theme(strip.background = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        legend.position = "none",
         axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))   
  graphBC
  
```



## LD50 by avg of viability:

This is calculating the avg viability for each replicate first, then using those two points to model the dose-response curve on for the final values.

```{r daunavg stuff, echo=TRUE,message=FALSE, warning=FALSE, include=FALSE}

daunls_avg <- list()
for(k in 1:6){
thingda <-  dplyr::filter(DA, indv==k)
  thingda.m <- drm(Viability~Conc, data = thingda, fct=LL.4(c(NA, NA,1, NA),names=c("Slope", "Lower Limit","Upper Limit","ED50")))
  # dnr_sl[k] <- thingda.m$fit$par[1]
  daunls_avg[paste0(k)] <- broom::tidy(ED(thingda.m, respLev = 50))
}
DNR_50_avg <- map_df(daunls_avg, ~as.data.frame(.x), .id="indv")

```

```{r DOXavg, echo=TRUE,message=FALSE, warning=FALSE, include=FALSE}

 doxls_avg<-list()

for(k in 1:6){
thingdx <-  dplyr::filter(DX, indv==k)
  thingdx.m <- drm(Viability~Conc, data = thingdx, fct=LL.4(c(NA, NA,1, NA),names=c("Slope","Lower Limit","Upper Limit","ED50")))
   doxls_avg[paste0(k)] <- broom::tidy(ED(thingdx.m, respLev = 50))
}

DOX_50_avg<- map_df(doxls_avg, ~as.data.frame(.x), .id="indv")



```

```{r EPIavg,echo=TRUE,message=FALSE, warning=FALSE, include=FALSE}
epls_avg<- list()
 for(k in 1:6){
thingep <-  dplyr::filter(EP, indv==k)
  thingep.m <- drm(Viability~Conc, data = thingep, fct=LL.4(c(NA, NA,1, NA),names=c("Slope","Lower Limit","Upper Limit","ED50")))
   epls_avg[paste0(k)] <- broom::tidy(ED(thingep.m, respLev = 50))
}

EPI_50_avg <- map_df(epls_avg, ~as.data.frame(.x), .id="indv")

```

```{r MTXavg, echo=TRUE,message=FALSE, warning=FALSE, include=FALSE}
mtls_avg <- list()
 for(k in 1:6){
thingmt <-  dplyr::filter(MT, indv==k)
  thingmt.m <- drm(Viability~Conc, data = thingmt, fct=LL.4(c(NA, NA,1, NA),names=c("Slope","Lower Limit","Upper Limit","ED50")))
   mtls_avg[paste0(k)] <- broom::tidy(ED(thingmt.m, respLev = 50))
}

MTX_50_avg <- map_df(mtls_avg, ~as.data.frame(.x), .id="indv")
```

```{r disply new ld50 avg}

coll_avg_ld50 <- list(DOX_50_avg,EPI_50_avg,DNR_50_avg,MTX_50_avg)
names(coll_avg_ld50) <- c("DOX","EPI","DNR","MTX")
 new_ld50avg <- map_df(coll_avg_ld50, ~as.data.frame(.x), .id="Treatment")
  # saveRDS(new_ld50avg, "data/new_ld50avg.RDS")

  new_ld50avg %>%   
  mutate(Treatment= factor(Treatment, levels = c("DOX","EPI","DNR","MTX"))) %>% 
  mutate(indv= factor(indv, levels = c('1','2','3','4','5','6'))) %>% 
  ggplot(., (aes(x = (Treatment), y = log10(Estimate)))) +
  geom_boxplot(position = "identity",aes(fill=Treatment))+
  geom_point(aes(color = indv,
                 size = 5,alpha = 0.5)) +
  ggtitle(expression("Experimentally-derived LD"[50]*"s from treated cardiomyocytes"))+
  xlab("Treatment")+
  ylab(bquote('Log'[10]~ 'LD'[50]~'in '*mu*M))+
  scale_color_brewer(palette = "Dark2",
                     name = "Individual")+
  ylim(-2,2)+
  scale_fill_manual(values=drug_pal_fact)+
  theme_bw() + 
  theme(plot.title = element_text(hjust =0.5, size = 18))+
  guides(alpha ="none", size = "none")+
  #theme(strip.background = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        # legend.position = "none",
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))   


```

## Replication of DRC in two individuals

This code is to test plotting two individuals on one plot with VE2 code  (tried to loop but did not get to work yet)
```{r double plot, echo=TRUE, eval=TRUE}
doubl_plot <- data.frame("ind3a", "ind3b", "ind5a", "ind5b")
trt <- data.frame("DOX","EPI", "DNR", "MTX", "TRZ", "VEH")
plotloop_list <- list("DOX_intv","EPI_intv","DNR_intv", "MTX_intv","TRZ_intv","VEH_intv")

for (each in 1:6){
  newdata <- VEH_intv %>%
    filter(indv%in% doubl_plot)
  
  ve<-VE2 %>% 
    filter(SampleID==paste0(pull_drc2[[each]],'a')|
                         SampleID==paste0(pull_drc2[[each]],'b')) %>% 
    ggplot(., aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
    geom_ribbon(data = newdata, aes( y = Prediction, ymin = Lower, ymax = Upper, fill=indv),
              alpha = 0.1, color = "white")+
     stat_smooth(method = "drm",
                  method.args = list(fct = L.4(c(NA,NA,1,NA))),
                 se = FALSE)+
      ylim(-.4,1.5)+
    guides(color="none", alpha = "none", fill="none")+
      scale_color_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle(paste0("Vehicle individual ",each))+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "white", colour = NA))
  print(ve)
 } 

```


