---
title: "Renee_DRC_Code"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE }
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

This is my Dose Response Curve Code and data with summaries.\
I hope to explain what and how I did things for future analysis, so that the code and data are reproducible. All data was created by treating cardiomyocytes at \~day 26 of diff with 0.01-50 $\mu$M concentrations of the drugs: Daunorubicin (DNR) Doxorubicin (DOX) Epirubicin (EPI) Mitoxantrone (MTX) Trastuzumab (TRZ) [ note: Trastuzumab could only be used at concentrations of 10 $\mu$M and lower] Vehicle (VEH)

Vehicle is the control and is effectively treated by water in volumes equivalent to the volume used to dilute the drugs in a 10 mM stock concentration. This is why it has values at different concentrations and why I analyze the data this way.

Cell viability was assessed using Presto Blue reagent according to manufacturer's protocols.\
90 uL of Galactose media + 10 uL of Presto Blue reagent were added to each well of the 96 well DRC plate for one hour. The cell media was then extracted to a black, clear bottom plate and wrapped in foil and stored at 4 degrees overnight (to allow bubbles to go away). A plate reader was used to measure florescence and the RFLU values were exported to an excel file.

Analysis was done as follows: The background wells were averaged and the average value was subtracted from every well on the plate. Because the wells on the plate were randomized, Matching the treatment with the wells is critical and was done inefficiently in an excel file for each experiment.\
Percent Viability was calculated by averaging the RFLU from the vehicle at each concentration, and dividing each drug's RFLU at that concentration by the Vehicle control average RFLU to give a ratio. All values less than 0 were turned into zero in the excel document, and a final compilation for each differentiation and dose curve treatment was stored in an document called DRC_compilation.xlsx. ( note: I spelled incorrectly in my computer) For calculation to control for plate to plate variance, the "Empty_Blank" well RFLU2 values from each plate within an experiment were averaged.\
eg:\
plate 1= empty average RFLU2 = 29000, plate 2 empty average RFLU2 =31000 normalized ratio plate 1/plate 2 or 29000/31000 =0.9355 this normalization ratio then was divided into every RFLU2 value on plate 1. Plate 2 would be divided by 1 to keep the formulas consistent (31000/31000 or plate2/plate2) to create a column that contained the adjusted RFLU2 values, called "adj"

Calculations then proceed as described originally.
The first viability value is called "Percent". The adjusted value for intra-plate differences is called "Padj" although this use was deprecated.

Part 2 of the analysis of data begins by entering data from the excel compilation to R.
The data is stored as an excel file, which was then stored as an .RDS object for analysis retrieval.

Step one in R is loading the libraries needed for analysis:

```{r Libraries to load, echo=TRUE, message=FALSE, warning=FALSE}
library(car)
#library(dr4pl) no longer used
library(tidyverse)
library(tinytex)
library(readxl)
library(BiocGenerics)
library(data.table)
library(drc)
library(Hmisc)
library(cowplot)
library(grid)
library(ggsignif)
library(RColorBrewer)
library(broom)

```

Step 2 is importing the data from the DRC_compilation.xlsx file. 
The data was imported and then stored as a data table in R.

```{r data import, eval=FALSE, warning=FALSE, include=FALSE}

D04_75_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD04_75-1n")
D05_75_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD05_75-1n")
D04_87_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD04_87-1n")
D05_87_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD05_87-1n")
    
D02_77_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD02_77-1")
D03_77_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD03_77-1")
D01_78_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD01_78-1")
D04_79_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD04_79-1")
D05_79_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD05_79-1")

D03_78_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD03_78-1")

D02_71_1 <-read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD02_71-1")

DJAG_71_1 <-read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMDJAG_71-1")



```

Step 3:

The files have a list of similar names:\  

'Drug' which is the short name of drug used 'Conc' which is the concentration of drug added (in microMolar); 'Sname' the abbreviated name of Drug and Conc; 'Well' letter with two number format 'Row' \# 1-8 for A-G 'Column' numbers 1-12; 'Plate' will vary between one and three; 'RFLU' the RFLU from the 0 hour reading with background subtracted (not all experiments have them); 'RFLU2' the RFLU from the 48 hour reading with background subtracted.

I will first streamline the data into more simple formats: 
Individual 1 is cell line 75-1 (D04_75_1,D05_75_1 )

Individual 2 is cell line 87-1 (D04_87_1, D05_87_1)

Individual 3 is cell line 77-1 (D02_77_1, D03_77_1)

Individual 4 is 79-1 (D04_79_1, D05_79_1)

Individual 5 is 78-1 (D01_78_1, D03_78_1)

Individual 6 is 71-1 (D02_71_1, DJAG_71_1)

As of 6-2-22 I am implementing a new naming for R handles:\
ind1a, ind1b etc, to make sure I process out the "empty_blanks"

I am also converting Conc column to numeric Part 4: ###file cleanup###

```{r File Cleanup, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ind1a <- as.data.frame(subset(D04_75_1, !(Drug %in% 'Empty')))
ind1b <- as.data.frame(subset(D05_75_1, !(Drug %in% 'Empty')))
ind2a <- as.data.frame(subset(D04_87_1, !(Drug %in% 'Empty')))
ind2b <- as.data.frame(subset(D05_87_1, !(Drug %in% 'Empty')))
ind3a <- as.data.frame(subset(D02_77_1, !(Drug %in% 'Empty')))
ind3b <- as.data.frame(subset(D03_77_1, !(Drug %in% 'Empty')))
ind4a <- as.data.frame(subset(D04_79_1, !(Drug %in% 'Empty')))
ind4b <- as.data.frame(subset(D05_79_1, !(Drug %in% 'Empty')))
ind5a <- as.data.frame(subset(D01_78_1, !(Drug %in% 'Empty')))
ind5b <- as.data.frame(subset(D03_78_1, !(Drug %in% 'Empty')))
ind6a <- as.data.frame(subset(D02_71_1, !(Drug %in% 'Empty')))
ind6b <- as.data.frame(subset(DJAG_71_1, !(Drug %in% 'Empty')))


ind1a <- ind1a %>%  mutate_at("Conc", as.numeric) %>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind1b <- ind1b %>%  mutate_at("Conc", as.numeric) %>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)

ind2a <- ind2a %>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind2b <- ind2b%>%  mutate_at("Conc", as.numeric)%>% 
  dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind3a <- ind3a%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind3b <- ind3b%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind4a <- ind4a %>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind4b <- ind4b%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind5a <- ind5a%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind5b <- ind5b%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind6a <- ind6a%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)
ind6b <- ind6b %>%  mutate_at("Conc", as.numeric) %>% dplyr::select(Drug,Conc,Percent,Name) %>% drop_na(Percent)




```

File cleanup first subsets each file imported by taking out the 'Empty' samples in the Drug column and then renaming the file to individual names and DRC a and b

I then need to convert the concentrations to as.numeric and select the 5 columns that I really need for analysis, followed by dropping any wells that were NA in the Percent column.\
The next part of the code is to make analysis files and groups and things for the iterations.

The data-frame called individuals is complied from each of the dataframes wrangled above and will be the "final" R object stored in the project folder.

## Loading the data into R

```{r combine list, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
###compile the separate data frames into a list of data frames
individuals <- list(ind1a,  
                    ind1b,
                    ind2a,
                    ind2b,
                    ind3a,
                    ind3b,
                    ind4a,
                    ind4b,
                    ind5a,
                    ind5b,
                    ind6a,
                    ind6b)

###First way to label data in the list with its' name
####adds the names to dataframe list
names(individuals) <- c("ind1a",
                          'ind1b',
                          'ind2a',
                          'ind2b',
                          "ind3a",
                          "ind3b",
                          "ind4a",
                          "ind4b",
                          "ind5a",
                          "ind5b",
                          "ind6a",
                          "ind6b")
###creates a list called ID which holds the names if needed
ID <- c("ind1a",
        'ind1b',
        'ind2a',
        'ind2b',
        "ind3a",
        "ind3b",
        "ind4a",
        "ind4b",
        "ind5a",
        "ind5b",
        "ind6a",
        "ind6b")
names(individuals)
saveRDS(individuals,"data/individual_LDH48.RDS")
full_list <- data.table::rbindlist(individuals, idcol = "SampleID")
 write.csv(full_list,"data/LDH48hoursdata.csv")
```
 
 
```{r loading RDS data, message=FALSE, warning=FALSE, include=FALSE}
individuals <- readRDS("data/individual_LDH48.RDS")
 ##make a smaller data frame###
 spec_ind <-  c("ind1a", "ind2b", "ind3b", "ind4b", "ind5b", "ind6a")### used to genrate ldh poster data in Dec 2022
 spec2_ind <-  c("ind1a", "ind2b", "ind3b", "ind4b", "ind5a", "ind6a")
 smaller <- individuals[c(1,4,6,7,9,11)]
 smaller2 <- individuals[c(1,3,6,7,9,11)]
 
smaller <- bind_rows(smaller,.id="SampleID")
smaller2 <- bind_rows(smaller2,.id="SampleID")

```


Once they are all in a data frame, a few functions need to be defined for ggplot.



```{r empty list holder, message=FALSE, warning=FALSE, include=FALSE}

#### making lists to put stuff in###
daunls <- list() ###daunorubicin list
doxols <- list() ### doxorubicin list
epils <- list() ###epirubicin list
mitols <- list() ###mitoxantrone list
trasls <- list() ###trastuzmab list
vehls <- list() ###vehicle list
name <- c( "Veh","Daun", "Doxo","Epi", "Mito", "Tras")### text list of drugs
```


```{r individual plots, eval=FALSE, include=FALSE}

for (i in name){
  thing <- subset(rbind(ind5a), Drug == i)
    label.1 <- thing$Name[1]
    thing.m <- dr4pl(Percent ~ Conc, data = thing, method.init = "logistic",init.parm = dr4pl_theta(NA,NA,NA,0))
    #doxols[[i]] <- summary(thing.m)
    pl <- plot(thing.m,
              ylim = c(0,1.2),
      text.x ="Concentration",
      text.y = "Percent Viable",
      text.title = label.1)
    
  pl$i
    
    print(summary(thing.m))
    pl <- pl  + ylim(0, 1.2)+ geom_point(size = 0.01)
    plot(pl)
    
    ###how I change the limits and colors of dots?)
} 
 
pl$i

```

## Viability

I wanted to graph viability across all samples. Below are the results from a sample of concentrations.

```{r Viablitiy plots, eval=FALSE, include=FALSE,warning=FALSE}
### to extract parameters for mapping
DAvia <- full_list %>% filter(Drug == "Daun") %>% filter(Conc ==0.5)# %>% mutate(SampleID=substr(SampleID,1,4))
DXvia <- full_list %>% filter(Drug == "Doxo")%>% filter(Conc ==0.5) %>% mutate(SampleID=substr(SampleID,1,4))
EPvia <- full_list %>% filter(Drug =="Epi")%>% filter(Conc ==0.5) %>% mutate(SampleID=substr(SampleID,1,4))
MTvia <- full_list %>% filter(Drug =="Mito")%>% filter(Conc ==0.5) %>% mutate(SampleID=substr(SampleID,1,4))
TRvia <- full_list %>% filter(Drug =="Tras")%>% filter(Conc ==0.5) %>% mutate(SampleID=substr(SampleID,1,4))
VEvia <- full_list %>% filter(Drug == "Veh")%>% filter(Conc ==0.5) %>% mutate(SampleID=substr(SampleID,1,4))
values_48_list <- full_list %>% na.omit()%>% filter(Conc == 0.5) %>% mutate(SampleID=substr(SampleID,1,4)) 

       
# ggplot(VE, aes(x= as.factor(Conc), y= Percent)) +
#      guides(alpha = "none")+ 
#       geom_boxplot(position ="dodge")+
#       ylim(0,1.5)+
#   facet_wrap(~SampleID)
```

```{r Viability data, echo=TRUE, warning=FALSE}
### to extract parameters for mapping
drug_pal_fact <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")
full_list <- read.csv("data/LDH48hoursdata.csv", row.names = 1)

averageFL <-  full_list %>% 
  na.omit()%>% 
  #filter(Conc <1) %>%
  group_by(SampleID, Drug,Conc) %>%
  mutate(indv=substr(SampleID,4,4)) %>%
  mutate(indv=factor(as.numeric(indv))) %>% 
  mutate(Drug = factor(Drug, levels = c("Veh","Daun",
                                        "Doxo",
                                        "Epi",
                                        "Mito",
                                        "Tras"))) %>%
  mutate(Drug=case_match(Drug,"Daun"~"Daunorubicin",
                         "Doxo"~"Doxorubicin",
                         "Epi"~"Epirubicin",
                         "Mito"~"Mitoxantrone",
                         "Tras"~"Trastuzumab",
                         "Veh"~ "Vehicle", .default= Drug)) %>%
  dplyr::summarize(Mean = mean(Percent))

  averageFL %>% 
    ungroup() %>% 
    mutate(indv=substr(SampleID,4,4)) %>% 
    mutate(indv=factor(as.numeric(indv))) %>% 
    filter(Conc<5) %>% 
    group_by(indv,Drug,Conc) %>% 
    dplyr::summarize(Viability=mean(Mean)) %>%
    ungroup() %>% 
    ggplot(.,  aes(x=Drug, y= Viability*100 )) +
    geom_boxplot(position="dodge",outlier.colour="transparent", aes(fill=Drug))+
    geom_point(aes(color=indv))+
    guides(alpha = "none")+
    ylim(0,150.5)+
    scale_color_brewer(palette = "Dark2",guide="legend",name = "Individual",labels(c(1,2,3,4,5,6)))+
    scale_fill_manual(values=drug_pal_fact)+
    theme_classic() +
    #xlab(expression(paste("Concentration [", mu, "M]")))+
    geom_hline(yintercept = 1,lty = 4)+
    ylab("Viability") +
    facet_wrap(~Conc)+ 
    geom_signif(comparisons =list(c("Daunorubicin","Vehicle"),
                                  c("Doxorubicin","Vehicle"),
                                  c("Epirubicin","Vehicle"),
                                  c("Mitoxantrone","Vehicle"),
                                  c("Trastuzumab","Vehicle")),
                test= "t.test",
                map_signif_level=TRUE,
                textsize =4,
                step_increase = 0.1)+
    ggtitle("Viablity across concentrations at 48 hours")+
    theme(axis.title=element_text(size=10),
          axis.ticks=element_line(size =2),
          axis.text=element_text(size=9, face = "bold"),
          panel.grid.major = element_line(colour = 'darkgrey'),
          panel.border=element_rect(fill = NA, size = 2),
          plot.title = element_text(hjust = 0.5, size =15, face = "bold"))
   
```

```{r viablity by drug, echo=FALSE, message=FALSE, warning=FALSE}


averageFL %>% 
  ungroup() %>% 
  mutate(indv=substr(SampleID,4,4)) %>%
  mutate(indv=factor(as.numeric(indv))) %>% 
  filter(Conc<5) %>% 
  group_by(indv,Drug,Conc) %>% 
  dplyr::summarize(Viability=mean(Mean)) %>% ungroup() %>% 
  ggplot(.,  aes(x=as.factor(Conc), y= Viability*100 )) +
  geom_boxplot(position="dodge",outlier.colour="transparent", aes(fill=Drug))+
  geom_point(aes(color=indv))+
  guides(alpha = "none")+
  ylim(0,150.5)+
  scale_color_brewer(palette = "Dark2",guide="legend",name = "Individual",labels(c(1,2,3,4,5,6)))+
  scale_fill_manual(values=drug_pal_fact)+
  theme_classic() +
  #xlab(expression(paste("Concentration [", mu, "M]")))+
  geom_hline(yintercept = 1,lty = 4)+
  ylab("Viability") +
  facet_wrap(~Drug)+ 
  geom_signif(comparisons =list(c("Daunorubicin","Vehicle"),
                                c("Doxorubicin","Vehicle"),
                                c("Epirubicin","Vehicle"),
                                c("Mitoxantrone","Vehicle"),
                                c("Trastuzumab","Vehicle")),
              test= "t.test",
              map_signif_level=TRUE,
              textsize =4,
              step_increase = 0.1)+
  ggtitle("Viablity across drugs at 48 hours")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=9, face = "bold"),
        panel.grid.major = element_line(colour = 'darkgrey'),
        panel.border=element_rect(fill = NA, size = 2),
        plot.title = element_text(hjust = 0.5, size =15, face = "bold"))
```


The above codes can be altered to include ALL concentrations.

## Ploting the DRC

```{r making filtered data, echo=FALSE}

### sort drug out and store as drug name from smaller list
#unique(smaller$SampleID)
#returns "ind1a" "ind2b" "ind3b" "ind4b" "ind5a" "ind6a"
DA <- full_list %>% filter(Drug == "Daun")
DX <- full_list %>% filter(Drug =="Doxo")
EP <- full_list %>% filter(Drug =="Epi")
MT <- full_list %>% filter(Drug =="Mito")
TR <- full_list %>% filter(Drug =="Tras")
VE <- full_list %>% filter(Drug =="Veh")
DA2 <- smaller2 %>% na.omit %>%dplyr::filter(Drug == "Daun")
DX2 <- smaller2 %>% na.omit %>%dplyr::filter(Drug == "Doxo")
EP2 <- smaller2 %>% na.omit %>%dplyr::filter(Drug =="Epi")
MT2 <- smaller2 %>% na.omit %>%dplyr::filter(Drug =="Mito")
TR2 <- smaller2 %>% na.omit %>%dplyr::filter(Drug =="Tras")
VE2 <- smaller2 %>% na.omit %>%dplyr::filter(Drug == "Veh")
#####Then add names!
```


```{r sample plot code, echo = TRUE, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggplot(DNR_viability, aes(x=Conc, y= Percent, color = SampleID,alpha =0.4)) +
  guides(color="none", alpha = "none")+  #guides turned off for group plotting
  stat_summary(fun.data=mean_se, ##this shows the error bar for me
               fun.args = list(mult=1),
               geom = "errorbar",
               size =.5, 
               width = .1)+
  stat_smooth(method = "drm", ## This code is how one can call DRM inside ggplot2
              method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+  #note: the fct mean function, and the L.4 stands for 4 parameter log-logistic curve
  ylim(0,1.5)+ #setting the limits so everything with graph
  scale_color_brewer(palette = "Dark2")+ #adding color of choice
  scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +  #looks pretting
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Percent viability/100") +
  ggtitle("Daunorubicin")+
  theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"),
        axis.title=element_text(size=10),
        axis.ticks=element_line(linewidth =2),
        axis.text=element_text(size=10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border=element_rect(fill = NA, linewidth = 2),
        plot.background = element_rect(fill = "#d7657e", colour = NA))
      

```
The code above is used multiple times and stored into an R object, so I can later combine the group into one full plot.  This keeps the graphs in the same proportion to each other.  I do alter each individual graph to either add axis titles or remove repitition.

```{r daunplot, echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(DA2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
#      guides(color =  "none", alpha = "none")+
#       stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
#     stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1.0,0,NA))), se = FALSE)+
#       ylim(0,1.5)+
#       scale_x_log10() +  # Change the x-axis scale to log 10 scale
#   theme_classic() +
#   xlab(expression(paste("Concentration [", mu, "M]")))+
#   ylab("Normalized Cell Viability")


daplot <- ggplot(DA2, aes(x=Conc, y= Percent, color = SampleID,alpha =0.4)) +
     guides(color="none", alpha = "none")+
      stat_summary(fun.data=mean_se, 
                   fun.args = list(mult=1), 
                   geom = "errorbar", 
                   size =.5, 
                   width = .1)+
    stat_smooth(method = "drm", 
                method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+
    ylim(0,1.5)+
    scale_color_brewer(palette = "Dark2")+
    scale_x_log10() +  # Change the x-axis scale to log 10 scale
    theme_classic() +
    xlab(NULL)+#expression(paste("Concentration [", mu, "M]")))+
    ylab(NULL) +
    ggtitle("Daunorubicin")+
    theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"),
          axis.title=element_text(size=10),
          axis.ticks=element_line(linewidth =2),
          axis.text=element_text(size=10, face = "bold"),
          panel.grid.major = element_line(colour = 'lightgrey'),
          panel.border=element_rect(fill = NA, linewidth = 2),
          plot.background = element_rect(fill = "#d7657e", colour = NA))
      
  #daplot
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    
```

```{r doxplot, echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(DX2, aes(x=Conc, y= Percent, colour = SampleID,alpha =0.6)) +
#   guides( alpha = "none")+
#       stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
#     stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1.0,0,NA))), se = FALSE)+
#       ylim(0,1.5)+
#       scale_x_log10() +  # Change the x-axis scale to log 10 scale
#   theme_classic() +
#   xlab(expression(paste("Concentration [", mu, "M]")))+
#   ylab("Normalized Cell Viability")

dxplot <-
  ggplot(DX2, aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
  guides(color="none", alpha = "none")+
      stat_summary(fun.data=mean_se, 
                   fun.args = list(mult=1), 
                   geom = "errorbar", 
                   size =.5, 
                   width = .1)+
      stat_smooth(method = "drm", 
                  method.args = list(fct = L.4(c(NA,1,0,NA))), 
                  se = FALSE)+
      ylim(0,1.5)+
      scale_color_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(NULL)+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle("Doxorubicin")+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth = 2),
            plot.background = element_rect(fill = "#d7657e", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    
   # dxplot
    
```

```{r epiplot,echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(EP2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
#   guides(color =  "none", alpha = "none")+
#   stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
#     stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,NA,NA,NA))), se = FALSE)+
#       ylim(0,1.5)+
#       scale_x_log10() +  # Change the x-axis scale to log 10 scale
#   theme_classic() +
#   xlab(expression(paste("Concentration [", mu, "M]")))+
#   ylab("Normalized Cell Viability")

epplot <- 
  ggplot(EP2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
  guides(color="none", alpha = "none")+
  stat_summary(fun.data=mean_se, 
                   fun.args = list(mult=1), 
                   geom = "errorbar", 
                   size =.5, 
                   width = .1)+
  stat_smooth(method = "drm", 
                method.args = list(fct = L.4(c(NA,0,1,NA))), 
                se = FALSE)+
  ylim(0,1.5)+
  scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  scale_color_brewer(palette = "Dark2")+
  xlab(NULL)+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
  ggtitle("Epirubicin")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(linewidth = 2),
        axis.text=element_text(size=10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border=element_rect(fill = NA, linewidth = 2),
        plot.background = element_rect(fill = "#d7657e", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
 # epplot  
    
    
```

```{r Mitoplot, echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(MT2, aes(x=Conc, y= Percent, color = SampleID, alpha= 0.6)) +
#      guides(color =  guide_legend(overide.aes =list(size=4)), alpha = "none")+
#       stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
#     stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,0,NA,NA))), se = FALSE)+
#       ylim(0,1.5)+
#       scale_x_log10() +  # Change the x-axis scale to log 10 scale
#   theme_classic() +
#   xlab(expression(paste("Concentration [", mu, "M]")))+
#   ylab()
      
    
mtplot <- 
  ggplot(MT2, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
      guides(color="none", alpha = "none")+
      stat_summary(fun.data=mean_se, 
                   fun.args = list(mult=1), 
                   geom = "errorbar", 
                   size =.5, 
                   width = .1)+
      stat_smooth(method = "drm", 
                  method.args = list(fct = L.4(c(NA,0,1,NA))), 
                  se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() + 
      scale_color_brewer(palette = "Dark2")+# Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(expression(paste("Concentration ", mu, "M")))+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face="bold"))+
      ggtitle("Mitoxantrone")+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(linewidth = 2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, linewidth =  2),
            plot.background = element_rect(fill = "#00c5cb", colour = NA))
      
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
  mtplot  
    
    
```

```{r  trasplot}
 leg <- ggplot(TR2, aes(x=Conc, y= Percent, color = SampleID, alpha = 0.6)) +
          geom_line()+
          theme_classic() +
      scale_color_brewer(palette = "Dark2",labels = c("1", "2", "3","4","5","6"))+
        labs(color = "Individual", linewidth=3)
        
          
trplot <- 
  ggplot(TR2, aes(x=Conc, y= Percent, color = SampleID, alpha = 0.6)) +
      guides(color="none", alpha = "none")+
      stat_summary(fun.data=mean_se, 
                   fun.args = list(mult=1), 
                   geom = "errorbar", 
                   size =.5, 
                   width = .1)+
      stat_smooth(method = "drm", 
                  method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      scale_color_brewer(palette = "Dark2")+
      xlab(expression(paste("Concentration ", mu, "M")))+
      ylab(NULL) +
      theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"))+
      ggtitle("Trastuzumab")+
      theme(axis.title=element_text(size=10),
            axis.ticks=element_line(size =2),
            axis.text=element_text(size=10, face = "bold"),
            panel.grid.major = element_line(colour = 'lightgrey'),
            panel.border=element_rect(fill = NA, size = 2),
            plot.background = element_rect(fill = "#00c5cb", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
  #trplot  

    
    
```

```{r control plot, echo=FALSE, message=FALSE, warning=FALSE}
# ggplot(VE2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
#       guides(color =  "none", alpha = "none")+
#           stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "errorbar", size =1, width = .1)+
#     stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+
#       ylim(0,1.5)+
#       scale_x_log10() +  # Change the x-axis scale to log 10 scale
#   theme_classic() +
#   xlab(expression(paste("Concentration [", mu, "M]")))+
#   ylab("Normalized Cell Viability")+
#       theme(plot.title = element_text(hjust = 0.5, size =20))+
#       ggtitle("Control")
veplot <- 
  ggplot(VE2, aes(x = Conc,y = Percent,color = SampleID,alpha = 0.6)) +
      guides(color="none", alpha = "none")+
      stat_summary(fun.data=mean_se, 
                   fun.args = list(mult=1), 
                   geom = "errorbar", 
                   size =.5, 
                   width = .1)+
      stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_color_brewer(palette = "Dark2")+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
      theme_classic() +
      xlab(expression(paste("Concentration ", mu, "M"))) +
      ylab(NULL) +
      ggtitle("Vehicle") +
      theme(plot.title = element_text(hjust = 0.5, size = 15, face = "bold")) +
      theme(
        axis.title = element_text(size = 10),
        axis.ticks = element_line(linewidth =  2),
        axis.text = element_text(size = 10, face = "bold"),
        panel.grid.major = element_line(colour = 'lightgrey'),
        panel.border = element_rect(fill = NA, linewidth = 2),
        panel.background = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent", colour = NA))
    
#veplot
# theme(plot.title = element_text(hjust = 0.5, size =20))
     #####plot all together!#####   


    
```

###plot all together!#####

```{r plot together not good, eval=TRUE, message=FALSE, warning=FALSE, include=FALSE}
    library(cowplot)
## take a legend from a plot
legend_b <- ggpubr::get_legend(leg)

ggpubr::as_ggplot(legend_b)
legend_b

# plan1 <- plot_grid(daplot,dxplot,epplot,NULL,mtplot, trplot,veplot,legend_b,ncol =4)
plan2 <-  plot_grid(daplot,dxplot,epplot,mtplot, trplot,veplot,ncol =3)
  
#drcfinal<- plot_grid(plan1, ncol =1, rel_heights = c(1,0.1))
save_plot('output/plan2plot.png', plan2)
save_plot('individual-legenddark2.png',ggpubr::as_ggplot(legend_b))
print(plan2)
plan2
```

### LD50 extract
Now to extract all the data from drm.
```{r LD50 extraction make the list, include=FALSE}

DAi <- full_list %>% dplyr::filter(Drug == "Daun")
DXi <- full_list %>% dplyr::filter(Drug == "Doxo")
EPi <- full_list %>% dplyr::filter(Drug =="Epi")
MTi <- full_list %>% filter(Drug =="Mito")
TRi <- full_list %>% filter(Drug =="Tras")
VEi <- full_list %>% filter(Drug == "Veh")
###extracting ggplot colors:
```

```{r extract the stuff via dr4pl, eval=FALSE, include=FALSE}

param_holder <- c()
for (i in ID) {
  thing <- filter(DAi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
daLD <- sapply(param_holder, "[[", 1) 

param_holder <- c()
for (i in ID) {
  thing <- filter(DXi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
dxLD <- sapply(param_holder, "[[", 1) 

param_holder <- c()
for (i in ID) {
  thing <- filter(EPi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
    param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
epLD <- sapply(param_holder, "[[", 1) 



param_holder <- c()
for (i in ID) {
  thing <- filter(MTi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
    param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
mtLD <- sapply(param_holder, "[[", 1) 


param_holder <- c()
for (i in ID) {
  thing <- filter(TRi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
    param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
trLD <- sapply(param_holder, "[[", 1) 


```


```{r extracting with drm, echo=TRUE, message=FALSE, warning=FALSE}
daunls <- list() ###daunorubicin list
dnr_sl <- list()
doxols <- list() ### doxorubicin list
dox_sl <- list()
epils <- list() ###epirubicin list
epi_sl <- list()
mitols <- list() ###mitoxantrone list
mtx_sl <- list()
trasls <- list() ###trastuzmab list
trx_sl <- list()
vehls <- list() ###vehicle list
veh_sl <- list()
ID <- c("ind1a",
        'ind1b',
        'ind2a',
        'ind2b',
        "ind3a",
        "ind3b",
        "ind4a",
        "ind4b",
        "ind5a",
        "ind5b",
        "ind6a",
        "ind6b")

for(k in ID){
thingda <-  filter(DAi, SampleID==k)
  thingda.m <- drm(Percent~Conc, data = thingda, fct=LL.4(c(NA, 0, 1, NA)))
  dnr_sl[k] <- thingda.m$fit$par[1]
  onion <- ED(thingda.m, c(50), interval = "delta")
  daunls[k] <- onion[1]
  
  print(paste0(k, " Daunorubicin"))
  
thingdx <-  filter(DXi, SampleID==k)
  thingdx.m <- drm(Percent~Conc, data = thingdx, fct=LL.4(c(NA, 0, 1, NA)))
  dox_sl[k] <- thingdx.m$fit$par[1]
  onionx <- ED(thingdx.m, c(50), interval = "delta")
  doxols[k] <- onionx[1]
  print(paste0(k, " Doxorubicin"))
  
 thingep <-  filter(EPi, SampleID==k)
  thingep.m <- drm(Percent~Conc, data = thingep, fct=LL.4(c(NA, 0, 1, NA)))
  epi_sl[k] <- thingep.m$fit$par[1]
  onione <- ED(thingep.m, c(50), interval = "delta")
  epils[k] <- onione[1] 
  print(paste0(k, " Epirubicin"))
  
  thingmt <-  filter(MTi, SampleID==k)
  thingmt.m <- drm(Percent~Conc, data = thingmt, fct=LL.4(c(NA, 0, 1, NA)))
  mtx_sl[k] <- thingmt.m$fit$par[1]
  # onionm <- ED(thingmt.m, c(50), interval = "delta")
  mitols[k] <- thingmt.m$fit$par[2]
  print(paste0(k, " Mitoxantrone"))
  
}



```


```{r boxplot of slope}
slope_table <- bind_rows(dnr_sl,dox_sl,epi_sl,mtx_sl)
avg_slope <- slope_table %>% 
  rownames_to_column() %>% 
  as.tibble()%>% 
  mutate(rowname=case_match(rowname,'1'~'DNR','2'~'DOX','3'~'EPI','4'~'MTX', .default = rowname))%>% 
  pivot_longer(!rowname,names_to = 'indv', values_to = 'slope') %>% 
  mutate(indv=str_sub(indv, 4,4)) %>% 
  group_by(rowname,indv) %>% 
  summarise_at(vars(slope),list(name = mean))

ggplot(avg_slope, aes(x=rowname, y=name))+
  geom_boxplot(position="dodge", aes(fill=rowname))+
    geom_point(aes(color=indv))+
    guides(alpha = "none")+
    scale_color_brewer(palette = "Dark2",guide="legend",name = "Individual",labels(c(1,2,3,4,5,6)))+
    scale_fill_manual(values=drug_pal_fact)+
    theme_classic() +
    ylab("average slope") +
    # geom_signif(comparisons =list(c("Daunorubicin","Vehicle"),
    #                               c("Doxorubicin","Vehicle"),
    #                               c("Epirubicin","Vehicle"),
    #                               c("Mitoxantrone","Vehicle"),
    #                               c("Trastuzumab","Vehicle")),
    #             test= "t.test",
    #             map_signif_level=TRUE,
    #             textsize =4,
    #             step_increase = 0.1)+
    ggtitle("Average slope between treatments")+
    theme(axis.title=element_text(size=10),
          axis.ticks=element_line(size =2),
          axis.text=element_text(size=9, face = "bold"),
          panel.grid.major = element_line(colour = 'darkgrey'),
          panel.border=element_rect(fill = NA, size = 2),
          plot.title = element_text(hjust = 0.5, size =15, face = "bold"))
```
### extracting slope
```{r slope extraction, message=FALSE, warning=FALSE, include=FALSE}
#
# library(RColorBrewer)
# drug_palc <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")
# daunls <- plyr::quickdf(daunls) %>%
#   pivot_longer(everything(),names_to = 'indv', values_to = "Daun")
# 
# doxols <- plyr::quickdf(doxols) %>%
#   pivot_longer(everything(),names_to = 'indv', values_to = "Doxo")
# epils <- plyr::quickdf(epils)%>%
#   pivot_longer(everything(),names_to = 'indv', values_to = "Epi")
# mitols <- plyr::quickdf(mitols)%>%
#   pivot_longer(everything(), names_to = 'indv', values_to = "Mito")
# 
# LDfull <- right_join(daunls,doxols,by = 'indv') %>% right_join(.,epils,by = 'indv') %>% right_join(., mitols, by= 'indv')
# 
# avgLD <- LDfull%>% 
#   pivot_longer(!indv,names_to = 'treatment', values_to = 'LD50') %>% 
#   mutate(indv=str_sub(indv, 4,4)) %>% 
#   group_by(treatment,indv) %>% 
#   summarise_at(vars(LD50),list(avg = mean))
# ggplot(avgLD, aes(x))geom_boxplot(position="dodge", aes(fill=rowname))+
#     geom_point(aes(color=indv))+
#     guides(alpha = "none")+
#     scale_color_brewer(palette = "Dark2",guide="legend",name = "Individual",labels(c(1,2,3,4,5,6)))+
#     scale_fill_manual(values=drug_pal_fact)+
#     theme_classic() +
# 
# # meanLDfull <- LDfull %>% mutate(indv = c('1','1','2','2','3','3','4','4','5','5','6','6')) %>% 
# # pivot_longer(.,col=!indv,names_to = 'Treatment',values_to = 'LD50') 
# # 
# # 
# # avgLD50 <- aggregate(LD50~Treatment+indv, data= meanLDfull, mean)
# #saveRDS(avgLD50,"data/avgLD50.RDS")
# 
# # LDfull <- right_join(daunls,doxols,by = 'indv') %>% right_join(.,epils,by = 'indv') %>% right_join(., mitols, by= 'indv')
# # colnames(LDfull) <- c("indv","Daunorubicin", "Doxorubicin", "Epirubicin", "Mitoxantrone")
# # summary(LDfull)
# # BC_cell_lines <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/BC_cell_lines.xlsx", sheet = "BC_sample_set")
# #write.csv(BC_cell_lines ,"data/BC_cell_lines.csv")
# 
# 
# 
# 
# ____________________________________
# # 
# # mtiplot <- ggplot(MTi, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
#             stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,0,1,NA))),se = FALSE)+
#         scale_x_log10() 
# 
# daiplot <- ggplot(DAi, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
#             stat_smooth(method = "drm",method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+
#         scale_x_log10() 
# 
# dxiplot <- ggplot(DXi, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
#             stat_smooth(method = "drm", 
#                   method.args = list(fct = L.4(c(NA,0,1,NA))), 
#                   se = FALSE)+
#         scale_x_log10() 
# epiplot <- ggplot(EPi, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
#             stat_smooth(method = "drm", 
#                   method.args = list(fct = L.4(c(NA,0,1,NA))), 
#                   se = FALSE)+
#         scale_x_log10() 
# triplot <- ggplot(TRi, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
#             stat_smooth(method = "drm", 
#                   method.args = list(fct = L.4(c(NA,0,1,NA))), 
#                   se = FALSE)+
#         scale_x_log10() 
# vehplot <- ggplot(VEi, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
#             stat_smooth(method = "drm", 
#                   method.args = list(fct = L.4(c(NA,0,1,NA))), 
#                   se = FALSE)+
#         scale_x_log10() 
# 
# 
# 
# summary(mtiplot)
# extracted_daun <- ggplot_build(daiplot)$data[[1]]
# extracted_doxo <- ggplot_build(dxiplot)$data[[1]]
# extracted_epi <- ggplot_build(epiplot)$data[[1]]
# extracted_mito <- ggplot_build(mtiplot)$data[[1]]
# extracted_tras <- ggplot_build(triplot)$data[[1]]
# extracted_veh <- ggplot_build(veiplot)$data[[1]]
# 
# 
# daun_slope <- extracted_daun %>% nest(data = -group) %>% 
#   mutate(model = map(data,~lm(y~x,data=.)), tidied = map(model,tidy))%>% 
#   unnest(tidied) #%>% 
#   dplyr::select(group,term,estimate) %>% 
#   pivot_wider(id_cols= group, names_from= term, values_from= estimate)# %>% 
#   rename(y='(Intercept)') %>% 
#   mutate(da_slope = y/x) %>% 
#   dplyr::select(group,da_slope)
# 
# 
# 
# doxo_slope <- extracted_doxo %>% nest(data = -group) %>% 
#   mutate(model = map(data,~lm(y~x,data=.)), tidied = map(model,tidy)) %>% 
#   unnest(tidied)%>% 
#   dplyr::select(group,term,estimate) %>% 
#   pivot_wider(id_cols= group, names_from= term, values_from= estimate) %>% 
#   rename(y='(Intercept)') %>% 
#   mutate(dx_slope = y/x) %>% 
#   dplyr::select(group,dx_slope)
# 
# epi_slope <- extracted_epi %>% nest(data = -group) %>% 
#   mutate(model = map(data,~lm(y~x,data=.)), tidied = map(model,tidy)) %>% 
#   unnest(tidied)%>% 
#   dplyr::select(group,term,estimate) %>% 
#   pivot_wider(id_cols= group, names_from= term, values_from= estimate) %>% 
#   rename(y='(Intercept)') %>% 
#   mutate(ep_slope = y/x) %>% 
#   dplyr::select(group,ep_slope)
# 
# mito_slope <- extracted_mito %>% nest(data = -group) %>% 
#   mutate(model = map(data,~lm(y~x,data=.)), tidied = map(model,tidy)) %>% 
#   unnest(tidied)#%>% 
#   dplyr::select(group,term,estimate) %>% 
#   pivot_wider(id_cols= group, names_from= term, values_from= estimate) %>% 
#   rename(y='(Intercept)') #%>% 
#   mutate(mt_slope = y/x) %>% 
#   dplyr::select(group,mt_slope)
# tras_slope <- extracted_tras %>% nest(data = -group) %>% 
#   mutate(model = map(data,~lm(y~x,data=.)), tidied = map(model,tidy)) %>% 
#   unnest(tidied)%>% 
#   dplyr::select(group,term,estimate) %>% 
#   pivot_wider(id_cols= group, names_from= term, values_from= estimate) %>% 
#   rename(y='(Intercept)') %>% 
#   mutate(tr_slope = y/x) %>% 
#   dplyr::select(group,tr_slope)
# 
# veh_slope <- extracted_veh %>% nest(data = -group) %>% 
#   mutate(model = map(data,~lm(y~x,data=.)), tidied = map(model,tidy)) %>% 
#   unnest(tidied)%>% 
#   dplyr::select(group,term,estimate) %>% 
#   pivot_wider(id_cols= group, names_from= term, values_from= estimate) %>% 
#   rename(y='(Intercept)') %>% 
#   mutate(ve_slope = y/x) %>% 
#   dplyr::select(group,ve_slope)


```




```{r DA try with drc, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
for(k in ID){

  thing <-  filter(DA, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  # plot(thing.m, 
  #      type ="bars" ,
  #      main = paste(thing$Name[1], " ", k),
  #      col= 2,
  #      xlab = expression(paste("Concentration [",mu,"M]")),
  #      ylab = "Percent Viable",
  #      ylim=c(0,1.5))
  # 
  
  a[1] <- ED(thing.m, c(50), interval = "delta")
  a[2] <- summary(thing.m)
  #legend("topright", legend = paste(round(a[1],2)))
  daunls[k] <- a[c(1,2)]


 }

#daunls
```

```{r DX try with drc, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
for(k in ID){

  thing <-  filter(DX, SampleID==k)  
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m,
       type ="bars",
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  doxols[k] <- a[1]


 }

#doxols
```

```{r EP try with drc, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
for(k in ID){

  thing <-  filter(EP, SampleID==k)  
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m,
       type ="bars",
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  epils[[k]] <- a[[1]]


 }

#epils
```

```{r MT try with drc, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

for(k in ID){

  thing <-  filter(MT, SampleID==k)  
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m,
       type ="bars",
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  mitols[[k]] <- a[[1]]


 }

#mitols
```

```{r TR try with drc, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ID2 <- ID[c(-4,-9,-12)]

for(k in ID2){

  thing <-  filter(TR, SampleID==k)  
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, NA, NA, NA)))
  plot(thing.m,
       type ="bars",
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  trasls[[k]] <- a[[1]]


 }

#trasls
```

```{r VE try with drc, eval=FALSE, include=FALSE}
for(k in ID){

  thing <-  filter(VE, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 1, NA, NA)))
  # plot(thing.m, 
  #      type ="bars" ,
  #      main = paste(thing$Name[1], " ", k),
  #      col= 2,
  #      xlab = expression(paste("Concentration [",mu,"M]")),
  #      ylab = "Percent Viable",
  #      ylim=c(0,1.5))
  # plot(thing.m,  type="bars", col= 2, add=TRUE )
  # 
  # a <- ED(thing.m, c(50), interval = "delta")
  # legend("topright", legend = paste(round(a[1],2)))
  # vehls[k] <- a[[1]]
tidy(thing.m)

 }

#vehls
```

##ld50 condensed

```{r combine LD50 values, echo=FALSE}
###combining all values into a larger dataframe

library(RColorBrewer)
drug_palc <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")
# daunls <- plyr::quickdf(daunls) %>% 
#   pivot_longer(everything(),names_to = 'indv', values_to = "Daun")
#                         
# doxols <- plyr::quickdf(doxols) %>% 
#   pivot_longer(everything(),names_to = 'indv', values_to = "Doxo")
# epils <- plyr::quickdf(epils)%>% 
#   pivot_longer(everything(),names_to = 'indv', values_to = "Epi")
# mitols <- plyr::quickdf(mitols)%>% 
#   pivot_longer(everything(), names_to = 'indv', values_to = "Mito")
# 
# LDfull <- right_join(daunls,doxols,by = 'indv') %>% right_join(.,epils,by = 'indv') %>% right_join(., mitols, by= 'indv')
# 
# meanLDfull <- LDfull %>% mutate(indv = c('1','1','2','2','3','3','4','4','5','5','6','6')) %>% 
# pivot_longer(.,col=!indv,names_to = 'Treatment',values_to = 'LD50') 
# 
# 
# avgLD50 <- aggregate(LD50~Treatment+indv, data= meanLDfull, mean)
#saveRDS(avgLD50,"data/avgLD50.RDS")

# LDfull <- right_join(daunls,doxols,by = 'indv') %>% right_join(.,epils,by = 'indv') %>% right_join(., mitols, by= 'indv')
# colnames(LDfull) <- c("indv","Daunorubicin", "Doxorubicin", "Epirubicin", "Mitoxantrone")
# summary(LDfull)
# BC_cell_lines <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/BC_cell_lines.xlsx", sheet = "BC_sample_set")
#write.csv(BC_cell_lines ,"data/BC_cell_lines.csv")
BC_cell_lines <- read.csv("data/BC_cell_lines.csv",row.names = 1)
avgLD50 <- readRDS("data/avgLD50.RDS")
  
graphLD50 <- avgLD50 %>%     mutate(Treatment=case_match(Treatment,"Daun"~"Daunorubicin",
                                        "Doxo"~"Doxorubicin",
                                        "Epi"~"Epirubicin",
                                        "Mito"~"Mitoxantrone",
                                        "Tras"~"Trastuzumab",
                                        "Veh"~ "Vehicle", .default= Treatment)) %>% 
  mutate(indv= factor(indv)) %>% 
  ggplot(., (aes(x = (Treatment), y = log10(LD50)))) +
  geom_boxplot(position = "identity",aes(fill=Treatment))+
  geom_point(aes(color = indv,
                 size = 5,alpha = 0.5)) +
  ggtitle(expression("Experimentlly-derived LD"[50]*"s from treated cardiomyocytes"))+
  xlab("Treatment")+
  ylab(bquote('Log'[10]~ 'LD'[50]~'in '*mu*M))+
  scale_color_brewer(palette = "Dark2",
                     name = "Individual", 
                     labels = c("1","2","3","4","5","6"))+
  ylim(-2,2)+
  scale_fill_manual(values=drug_palc)+
  theme_bw() + 
  theme(plot.title = element_text(hjust =0.5, size = 18))+
  guides(alpha ="none", size = "none", fill= "none")+
  #theme(strip.background = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        legend.position = "none",
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))   

graphLD50
avgLD50 %>% dplyr::group_by(Treatment) %>% summarize_at(vars(LD50), list(median = median))


graphBC <- BC_cell_lines %>%
    mutate(Cell_line= factor(Cell_line)) %>% 
  pivot_longer(.,col=!Cell_line,names_to = 'Treatment',values_to = 'LD50') %>% 
  ggplot(., (aes(x = (Treatment), y = log10(LD50)))) +
  geom_boxplot(position = "identity",aes(fill=Treatment))+
  geom_point(aes(color = Cell_line,
                 size = 5,alpha = 0.5)) +
  ggtitle(expression("Breast cancer cell line reported  LD"[50]*"s"))+
  xlab("")+
  ylab(bquote('Log'[10]~ 'LD'[50]~'in '*mu*M))+
  scale_color_brewer(palette = "Spectral",
                     name = "Cell lines")+
          scale_fill_manual(values=drug_palc)+
  ylim(-2,2)+
  theme_bw() + 
  theme(plot.title = element_text(hjust =0.5, size = 18))+
  guides(alpha ="none", size = "none", fill= "none")+
  #theme(strip.background = element_rect(fill = "transparent")) +
  theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        legend.position = "none",
         axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))   
  graphBC
  
```
#testdata
```{r }
library(drc)
dat <- subset(spinach, HERBICIDE=='bentazon')  # we don't need all the curves
names(dat)[names(dat)=='SLOPE'] <- 'RESPONSE'  # to prevent confusion :)
dat <- transform(dat, CURVE=factor(CURVE))     # get ready for modelling
m1 <- drm(RESPONSE~DOSE, curveid=CURVE, data=dat, 
  pmodels=list(~1, ~CURVE, ~CURVE, ~1), fct=LL.4())



dat  <- dat[order(dat$DOSE), ]
dose <- dat[which(dat$CURVE==3), 'DOSE']
dat[which(dat$CURVE==3), 'DOSE'] <- rev(dose)
m2 <- update(m1, data=dat)

```


```{r barplot, eval=FALSE, include=FALSE}

#mean_values <-  abc_df %>% mutate("Indiv" = substr(SampleID,4,4)) %>% 
 # dplyr::group_by(SampleID, Drug, Conc)  
  
in78 <- abc_df %>% 
  dplyr::filter(Drug=="Veh"|Drug =="Doxo") %>%
  filter(SampleID=="ind5a") %>%  
  filter(Conc ==1|Conc==0.5)


veh78 <- in78 %>% filter(Drug =="Veh") %>% mutate(Conc = 0*Conc)
dox78 <- in78 %>% filter(Drug =="Doxo")
in78 <- rbind(veh78,dox78)
in78a <- in78 %>% dplyr::select (Percent, Conc) %>% mutate(as.factor(Conc))


ggplot(Test, aes(y=Percent, x=factor(Conc),fill =factor(Conc)))+ 
  stat_summary(fun.data=mean_sdl, geom="bar")+
  stat_summary(fun.data=mean_sdl, fun.args= list(mult =1), 
               geom="errorbar", width=0.3)+
    theme_bw() +ylim(c(0, 1.5))+
  scale_fill_manual(values= c( "orange","red","purple")) +
  #scale_fill_discrete(values =c("red","purple",))+
  labs(title = "Doxorubicin")+ 
  xlab(expression(paste("Drug concentration [", mu, "M]")))+
  ylab("Average Viability")+
  theme(plot.title = element_text(hjust =0.5, size = 18, face="bold"))+
  guides(fill ="none")+
    theme(axis.title=element_text(size=15, color ="black"),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=15, face = "bold", color ="black"),
        panel.border=element_rect(fill = NA, size = 3))




in78$Percent
in78$Conc

barplot()

summarise(in78)
Test <- c()
Test$Conc <- c(0.0, 0.0, 0.0, 0.0 ,0.0 ,0.0 ,0.0 ,0.0, 1.0, 1.0, 1.0, 0.5, 1.0 ,0.5, 0.5 ,0.5, 0.5)

Test$Percent <- c(0.8613429, 0.9125987 ,0.9434696, 0.9939936 ,1.0131610, 1.0171015, 1.1307707, 1.1275620 ,0.4203752 ,0.5095490 ,0.5525790,0.6806332, 0.6934852, 0.8022452,
0.8758142, 1.0392211,1.0847938)
Test <- as.data.frame(Test)


```



```{r eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# ###make data frame
dn <- c('Vehicle', 'Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab','Vehicle', 'Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab')
# 
# ng <- c(9615.9,7800.61,3454.27,6171.64,4276.96,11619.86,5237.35,19541.6,16257.39,21097.08,21774.27,26494.72)
# relng <- c(1.003,0.814,0.359,0.628,0.433,1.211,0.921,3.437,2.808,3.712,3.831,4.658)
# relstdv <- c(0.005,0.035,0.097,0.401,0.301,0.129,0.112,0.233,1.547,0.084,0.123,0.533)
# stdv <- c(43,339,930,3845,2886,1241,638,1327,8791,480,698,3027)
# hrs <- c((rep(3,6)), (rep(24,6)))
# 
tidata <- data.frame(dn, relng, relstdv, hrs)
# 
# 
# ##make the plot##

tropimage <- ggplot(tidata, aes(factor (dn, level = c('Vehicle', 'Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab')), y = relng, group = hrs, fill = as.factor(hrs)))+ 
  geom_bar(position = "dodge", stat = "identity")+
  scale_fill_manual(values= c( "dark green","purple4")) +
  ggtitle("Levels of Troponin I release in cell media")+
  theme_bw() +
   xlab("Treatment at 0.5 uM")+
  ylab("Relative Units")+
  scale_y_continuous(
    # don't expand y scale at the lower end
    expand = expansion(mult = c(0, 0.05)))+
  labs(fill = "Hours")+
  theme(axis.title=element_text(size=15, color ="black"),
        plot.title = element_text(hjust =0.5, size = 18),
        axis.ticks=element_line(size =1.5),
        axis.text=element_text(size=9, color ="black"),
        panel.border=element_rect(fill = NA, size = 2))+ 
      #axis.text.y = element_text(angle=45, vjust=1.1, hjust=0.5))+
  geom_errorbar(aes(ymin=relng, ymax=relng+relstdv), width=.2,
                 position=position_dodge(.9))

tropimage 
save_plot("tropimage.png",tropimage)

```

## DRC replicates
```{r drc overlaps by individual treatment}




```
