---
title: "Renee_DRC_Code"
author: "ERM"
date: '2022-07-12'
output: html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is my Dose Response Curve Code and data with summaries.  
I hope to explain what and how I did things for future analysis, so that the code and data are reproducible.
All data was created by treating cardiomyocytes at \~day 26 of diff with 0.01-50 \muM concentrations of the drugs:
Daunorubicin (daun)
Doxorubicin (doxo)
Epirubicin (epi)
Mitoxantrone (mito)
Trastuzumab (tras)  [ note:  Trastuzumab could only be used at concentrations of 10 uM and lower]
Vehicle (veh)


Vehicle is the control and is effectively treated by water in volumes equivalent to the volume used to dilute the drugs in a 10 mM stock concentration.   This is why it has values at different concentrations and why I analyze the data this way.


Cell viability was assessed using Presto Blue reagent according to manufacturer's protocols.  
90 uL of Galactose media + 10 uL of Presto Blue reagent were added to each well of the 96 well DRC plate for one hour.  The cell media was then extracted to a black, clear bottom plate and wrapped in foil and stored at 4 degrees overnight (to allow bubbles to go away).  A plate reader was used to measure florescence and the RFLU values were exported to an excel file.


Analysis was done as follows:  The background wells were averaged and the average value was subtracted from every well on the plate.  Because the wells on the plate were randomized, Matching the treatment with the wells is critical and was done inefficiently in an excel file for each experiment.  
Percent Viability was calculated by averaging the RFLU from the vehicle at each concentration, and dividing each drug's RFLU at that concentration by the Vehicle control average RFLU to give a ratio.  All values less than 0 were turned into zero in the excel document, and a final compilation for each differentiation and dose curve treatment was stored in an document called DRC_compilation.xlsx. ( note: I spelled incorrectly in my computer)
For calculation to control for plate to plate variance, the "Empty_Blank" well RFLU2 values from each plate within an experiment were averaged.  
eg:  
plate 1= empty average RFLU2 = 29000,  plate 2 empty average RFLU2 =31000
normalized ratio  plate 1/plate 2
or 29000/31000 =0.9355
this normalization ratio then was divided into every RFLU2 value on plate 1.  Plate 2 would be divided by 1 to keep the formulas consistent (31000/31000 or plate2/plate2) to create a column that contained the adjusted RFLU2 values, called "adj"

Calculations then proceed as described originally.

the first viability value is called "Percent".  The adjusted value for intra-plate differences is called "Padj"  

Part 2 of the analysis of data begins by entering data from the excel compilation to R.

Step one in R is loading the libraries needed for analysis:

```{r Libraries to load, echo=TRUE, message=FALSE, warning=FALSE}
library(car)
library(dr4pl)
library(tidyverse)
library(tinytex)
library(readxl)
library(BiocGenerics)
library(data.table)
library(drc)
library(Hmisc)
library(cowplot)
library(grid)
library(ggsignif)

```

Step 2 is importing the data from the DRC_complilation.xlsx file.  

```{r data import, echo=FALSE, warning=FALSE}


D04_75_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD04_75-1n")
D05_75_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD05_75-1n")
D04_87_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD04_87-1n")
D05_87_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD05_87-1n")
    
D02_77_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD02_77-1")
D03_77_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD03_77-1")
D01_78_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD01_78-1")
D04_79_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD04_79-1")
D05_79_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD05_79-1")

D03_78_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD03_78-1")

D02_71_1 <-read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMD02_71-1")

DJAG_71_1 <-read_excel("~/Ward Lab/Cardiotoxicity/Data/Cell viability/DRC_compilation.xlsx", 
    sheet = "PB CMDJAG_71-1")



```

Step 3:

The files "should" have a list of similar names:\
'Drug' which is the short name of drug used
'Conc' which is the concentration of drug added (in microMolar)
'Sname' the abbreviated name of Drug and Conc
'Well' letter with two number format
'Row' \# 1-8 for A-G 
'Column' numbers 1-12 
'Plate' will vary between two and three
'RFLU' the RFLU from the 0 hour reading with background subtracted (not all experiments have them)
'RFLU2'  the  RFLU from the 48 hour reading with background subtracted 

I will first streamline the data into more simple formats: 
Individual 1 is cell line 75-1 (D04_75_1,D05_75_1 )

Individual 2 is cell line 87-1 (D04_87_1, D05_87_1)

Individual 3 is cell line 77-1 (D02_77_1, D03_77_1)

Individual 4 is 79-1 (D04_79_1, D05_79_1)

Individual 5 is 78-1 (D01_78_1, D03_78_1)

Individual 6 is 71-1 (D02_71_1, DJAG_71_1)

As of 6-2-22 I am implementing a new naming for R handles:\
ind1a, ind1b etc, to make sure I process out the "empty_blanks"

I am also converting Conc column to numeric
Part 4: 
###file cleanup###

```{r File Cleanup, message=FALSE, warning=FALSE, include=FALSE}

ind1a <- as.data.frame(subset(D04_75_1, !(Drug %in% 'Empty')))
ind1b <- as.data.frame(subset(D05_75_1, !(Drug %in% 'Empty')))
ind2a <- as.data.frame(subset(D04_87_1, !(Drug %in% 'Empty')))
ind2b <- as.data.frame(subset(D05_87_1, !(Drug %in% 'Empty')))
ind3a <- as.data.frame(subset(D02_77_1, !(Drug %in% 'Empty')))
ind3b <- as.data.frame(subset(D03_77_1, !(Drug %in% 'Empty')))
ind4a <- as.data.frame(subset(D04_79_1, !(Drug %in% 'Empty')))
ind4b <- as.data.frame(subset(D05_79_1, !(Drug %in% 'Empty')))
ind5a <- as.data.frame(subset(D01_78_1, !(Drug %in% 'Empty')))
ind5b <- as.data.frame(subset(D03_78_1, !(Drug %in% 'Empty')))
ind6a <- as.data.frame(subset(D02_71_1, !(Drug %in% 'Empty')))
ind6b <- as.data.frame(subset(DJAG_71_1, !(Drug %in% 'Empty')))


ind1a <- ind1a %>%  mutate_at("Conc", as.numeric) %>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind1b <- ind1b %>%  mutate_at("Conc", as.numeric) %>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)

ind2a <- ind2a %>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind2b <- ind2b%>%  mutate_at("Conc", as.numeric)%>% 
  dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind3a <- ind3a%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind3b <- ind3b%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind4a <- ind4a %>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind4b <- ind4b%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind5a <- ind5a%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind5b <- ind5b%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind6a <- ind6a%>%  mutate_at("Conc", as.numeric)%>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)
ind6b <- ind6b %>%  mutate_at("Conc", as.numeric) %>% dplyr::select(Drug,Conc,Percent,Padj,Name) %>% drop_na(Percent)

for (i in ID){
  
  write
  
  
}


write.table()
```

File cleanup first subsets each file imported by taking out the 'Empty' samples in the Drug column and then renaming the file to individual names and DRC a and b

I then need to convert the concentrations to as.numeric and select the 5 columns that I really need for analysis, followed by dropping any wells that were NA in the Percent column.  
The next part of the code is to make analysis files and groups and things for the iterations.

The data-frame called individuals is complied from each of the dataframes wrangled above.

###lists
```{r combine list, echo=FALSE, message=FALSE, warning=FALSE}
###compile the separate data frames into a list of data frames
individuals <- list(ind1a,  
                    ind1b,
                    ind2a,
                    ind2b,
                    ind3a,
                    ind3b,
                    ind4a ,
                    ind4b ,
                    ind5a ,
                    ind5b ,
                    ind6a ,
                    ind6b)

###First way to label data in the list with its' name
####adds the names to dataframe list
names(individuals) <- c("ind1a",
                          'ind1b',
                          'ind2a',
                          'ind2b',
                          "ind3a",
                          "ind3b",
                          "ind4a",
                          "ind4b",
                          "ind5a",
                          "ind5b",
                          "ind6a",
                          "ind6b")
###creates a list called ID which holds the names if needed
ID <- c("ind1a",  
        'ind1b',
        'ind2a',
        'ind2b',
        "ind3a",
        "ind3b",
        "ind4a",
        "ind4b",
        "ind5a",
        "ind5b",
        "ind6a",
        "ind6b")
names(individuals)### check to make sure they are labled.
 #### this is to add the names of individuals to each dataframe in list

## way number 2!
### this is to add an new element called SampleID across each dataframe to  combine
### "label" the frame before we flatten it
  for( i in seq_along(individuals)){
    
    individuals[[i]]$SampleID <- rep(ID[i],nrow(individuals[[i]]))
    
  }
  ### now we transform that list of data frames into a larger dataframe with a new column called "SampleID"
###making a dataframe to transform the individuals into a long large data frame##3
 full_list <- bind_rows(individuals, .id = "SampleID")
 
 ##make a smaller data frame###
 spec_ind <-  c("ind1a", "ind2b", "ind3b", "ind4b", "ind5b", "ind6a")### used to genrate ldh poster data in Dec 2022
 spec2_ind <-  c("ind1a", "ind2b", "ind3b", "ind4b", "ind5a", "ind6a")
 smaller <- individuals[c(1,4,6,8,10,11)]
 smaller2 <- individuals[c(1,4,6,8,9,11)]
 
smaller <- bind_rows(smaller)
smaller2 <- bind_rows(smaller2)

```

Once they are all in a data from, a few functions need to be defined for ggplot:

##functions
```{r functions, eval= FALSE,message=FALSE, warning=FALSE}

#####adding functions

predict.dr4pl <- function (object, newdata=NULL, se.fit=FALSE, level, interval) {
  xseq <- if (is.null(newdata)) object$data$Dose else newdata$x
  pred <- dr4pl::MeanResponse(xseq, object$parameters)
  if (!se.fit) {
    return(pred)
  }
  qq <- qnorm((1+level)/2)
  se <- sapply(xseq,
               function(x) car::deltaMethod(object, 
                                            "UpperLimit + (LowerLimit - UpperLimit)/(1 + (x/IC50)^Slope)")[["Estimate"]])
  return(list(fit=data.frame(fit=pred,lwr=pred-qq*se,
                             upr=pred+qq*se), se.fit=se))
}

predictdf.dr4pl <- function (model, xseq, se, level, nboot=200) {
  pred <- dr4pl::MeanResponse(xseq, model$parameters)
  if (!se) {
    return(base::data.frame(x=xseq, y=pred))
  }
  ## bootstrap residuals
  pred0 <- dr4pl::MeanResponse(model$data$Dose, model$parameters)
  res <- pred0-model$data$Response
  bootres <- matrix(nrow=length(xseq), ncol=nboot)
  pb <- txtProgressBar(max=nboot,style=3)
  for (i in seq(nboot)) {
    setTxtProgressBar(pb,i)
    mboot <- dr4pl(model$data$Dose,
                   pred0 + sample(res, size=length(pred0),
                                  replace=TRUE))
    bootres[,i] <- MeanResponse(xseq, mboot$parameters)
  }
  fit <- data.frame(x = xseq,
                    y=pred,
                    ymin=apply(bootres,1,quantile,(1-level)/2),
                    ymax=apply(bootres,1,quantile,(1+level)/2))
  return(fit)
}


```


Containers for holding thingys:



```{r empty list holder}

#### making lists to put stuff in###
daunls <- list() ###daunorubicin list
doxols <- list() ### doxorubicin list
epils <- list() ###epirubicin list
mitols <- list() ###mitoxantrone list
trasls <- list() ###trastuzmab list
vehls <- list() ###vehicle list
name <- c( "Daun", "Doxo","Epi", "Mito", "Tras")### text list of drugs




```

##individual
```{r individual plots}

for (i in name){
  thing <- subset(rbind(ind5a,ind5b), Drug == i)
    label.1 <- thing$Name[1]
    thing.m <- dr4pl(Percent ~ Conc, data = thing, method.init = "logistic")
    doxols[[i]] <- summary(thing.m)
    pl <- plot(thing.m,
              ylim = c(0,1.2),
      text.x ="Concentration",
      text.y = "Percent Viable",
      text.title = label.1)
    
  pl$i
    
    print(summary(thing.m))
    plot(pl)  + ylim(0, 1.2) ###how I change the limits and colors of dots?)
} 
 


```
The problem with that package is the  dots.... and the fact I cannot graph lines on top of one another.  So I started to extract the information needed to generate the geom_ribbon and geom_line data needed.

Here I need to assign the drugs out by drug:

```{r making filtered data}

### sort durg out and store as drug name from smaller list
#unique(smaller$SampleID)
#returns "ind1a" "ind2b" "ind3b" "ind4b" "ind5a" "ind6a"
DA <- full_list %>% filter(Drug == "Daun")
DX <- full_list %>% filter(Drug == "Doxo")
EP <- full_list %>% filter(Drug =="Epi")
MT <- full_list %>% filter(Drug =="Mito")
TR <- full_list %>% filter(Drug =="Tras")
VE <- full_list %>% filter(Drug == "Veh")
DA2 <- smaller2 %>% filter(Drug == "Daun")
DX2 <- smaller2 %>% filter(Drug == "Doxo")
EP2 <- smaller2 %>% filter(Drug =="Epi")
MT2 <- smaller2 %>% filter(Drug =="Mito")
TR2 <- smaller2 %>% filter(Drug =="Tras")
VE2 <- smaller2 %>% filter(Drug == "Veh")
#####Then add names!
```


```{r Daunorubicin}
### to extract parameters for mapping
param_holder <- c()
for (i in ID) {
  thing <- filter(DA, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- thing.m$parameters[2]
  
   
}
DA_parm <- param_holder
    ```
    
```{r Doxorubicin}
### to extract parameters for mapping
param_holder <- c()
for (i in ID) {
  thing <- filter(DX, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- thing.m$parameters[2]
  
   
}
DX_parm <- as.data.frame(param_holder)
    ```
    
   
   
```{r Epirubicin}
### to extract parameters for mapping
param_holder <- c()
for (i in ID) {
  thing <- filter(EP, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- thing.m$parameters[2]
  
   
}
EP_parm <- as.data.frame(param_holder)
    ```
    
    
    
```{r Mitoxantrone}
### to extract parameters for mapping
param_holder <- c()
for (i in ID) {
  thing <- filter(MT, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- thing.m$parameters[2]
  
   
}
MT_parm <- as.data.frame(param_holder)
    ```
    
    
```{r Trastuzumab}
### to extract parameters for mapping
param_holder <- c()
for (i in ID) {
  thing <- filter(TR, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
  #group.m <- drm(Percent ~Conc, data =thing)
   param_holder[[i]] <- thing.m$parameters[2]
  
   
}
TR_parm <- as.data.frame(param_holder)
    ```
    
    
```{r Vehicle, warning=FALSE}
### to extract parameters for mapping

param_holder <- c()
for (i in spec_ind) {
  thing <- filter(VE, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- thing.m$parameters
  
   
}
VE_parm <- as.data.frame(param_holder)
    ```
    Getting an error, but It does not affect the result
I can use bind_rows to get a pretty output in tibble

    
     
    
    
```{r daunplot}
ggplot(DA2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
     guides(color =  "none", alpha = "none")+ 
  stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1,0,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Normalized Cell Viability")

daplot <- 
  ggplot(DA2, aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
     guides(color =  "none", alpha = "none")+ 
  stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.5)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1,0,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"))+
      ggtitle("Daunorubicin")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 2),
       panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    
    ```
    This little tidbit can be added might need to specificy dr4pl data
     stat_function(formula y~x, fun = dr4pl::MeanResponse, args = list(theta = dr4pl_obj$parameters), color= 3,size =1.2)+
    
```{r doxplot}
ggplot(DX2, aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
  guides(color =  "none", alpha = "none")+
      stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1.0,0,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Normalized Cell Viability")

dxplot <-
  ggplot(DX2, aes(x=Conc, y= Percent, color = SampleID,alpha =0.6)) +
  guides(color =  "none", alpha = "none")+
      stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.5)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1,0,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
 ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle("Doxorubicin")+
    theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 2),
       panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    
    dxplot
    
    ```
    
    
    
    
    
```{r epiplot}
ggplot(EP2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
  guides(color =  "none", alpha = "none")+
  stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,NA,NA,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Normalized Cell Viability")

epplot <- 
  ggplot(EP2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
  guides(color =  "none", alpha = "none")+
  stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.5)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1,0,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face ="bold"))+
      ggtitle("Epirubicin")+
    theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 2),
       panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    
    
    
    ```
    
    
    ```{r mitoplot}
ggplot(MT2, aes(x=Conc, y= Percent, color = SampleID, alpha= 0.6)) +
     guides(color =  "none", alpha = "none")+
      stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,0,NA,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab()
      
    
mtplot <- 
  ggplot(MT2, aes(x=Conc, y= Percent, color = SampleID, alpha=0.6))+
      guides(color =  "none", alpha = "none")+
      stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.5)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,0,1,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
   xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face="bold"))+
      ggtitle("Mitoxantrone")+
  theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 2),
       panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    
    
    
    ```
    
    
    
    ```{r  trasplot}
leg <- 
      ggplot(TR2, aes(x=Conc, y= Percent, color = SampleID, alpha = 0.6)) +
      guides(alpha = "none")+
      stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.8)+
      scale_color_discrete(labels = c("Individual 1","Individual 2", "Individual 3", "Individual 4","Individual 5","Individual 6"))+labs(color="")+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,1,0,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Normalized Cell Viability")
    
                          
                          
                          
trplot <- 
  ggplot(TR2, aes(x=Conc, y= Percent, color = SampleID, alpha = 0.6)) +
      guides(color =  "none", alpha = "none")+
      stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.5)+
    stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,NA,NA,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() + 
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab(NULL) +
  theme(plot.title = element_text(hjust = 0.5, size =15, face = "bold"))+
      ggtitle("Trastuzumab")+theme(axis.title=element_text(size=10),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 2),
       panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", colour = NA))
      
  # theme(plot.title = element_text(hjust = 0.5, size =20))
    

    
    
    ```
    
    
    ```{r  control}
ggplot(VE2, aes(x=Conc, y= Percent, color = SampleID, alpha =0.6)) +
      guides(color =  "none", alpha = "none")+
          stat_summary(fun.data=mean_se, fun.args = list(mult=1), geom = "pointrange", size =0.5)+
    geom_smooth(method = drm, method.args = list(fct = L.4()), se = FALSE)+
      stat_smooth(method = "drm", method.args = list(fct = L.4(c(NA,NA,NA,NA))), se = FALSE)+
      ylim(0,1.5)+
      scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]")))+
  ylab("Normalized Cell Viability")+
      theme(plot.title = element_text(hjust = 0.5, size =20))+
      ggtitle("Control")
veplot <-     
  ggplot(VE, aes(
    x = Conc,
    y = Percent,
    color = SampleID,
    alpha = 0.6
  )) +
  guides(color =  "none", alpha = "none") +
  stat_summary(
    fun.data = mean_se,
    fun.args = list(mult = 1),
    geom = "pointrange",
    size = 0.5
  ) +
  geom_smooth(method = drm,
              method.args = list(fct = L.4()),
              se = TRUE) +
  stat_smooth(method = "drm",
              method.args = list(fct = L.4(c(NA, NA, NA, NA))),
              se = FALSE) +
  ylim(0, 1.5) +
  scale_x_log10() +  # Change the x-axis scale to log 10 scale
  theme_classic() +
  xlab(expression(paste("Concentration [", mu, "M]"))) +
  ylab(NULL) +
  ggtitle("Control") +
  theme(plot.title = element_text(hjust = 0.5, size = 15, face = "bold")) +
  theme(
    axis.title = element_text(size = 10),
    axis.ticks = element_line(size = 2),
    axis.text = element_text(size = 10, face = "bold"),
    panel.grid.major = element_line(colour = 'lightgrey'),
    panel.border = element_rect(fill = NA, size = 2),
       panel.background = element_rect(fill = "transparent"),
      plot.background = element_rect(fill = "transparent", colour = NA))






      

# theme(plot.title = element_text(hjust = 0.5, size =20))
     #####plot all together!#####   
    
    
    ```
###plot all together!#####
    
```{r plot together not good}
    library(cowplot)
### take a legend from a plot
legend_b <- get_legend(
  leg + 
    guides(color = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom")
)

legend_b
plan1 <- plot_grid(daplot,dxplot,epplot,mtplot, trplot,veplot,ncol =3)

#drcfinal<- plot_grid(plan1, ncol =1, rel_heights = c(1,0.1))
save_plot('plan1plot.png', plan1)
plan1

```



```{r  LD50 extraction make the list}

DAi <- abc_df %>% dplyr::filter(Drug == "Daun")
DXi <- abc_df %>% dplyr::filter(Drug == "Doxo")
EPi <- abc_df %>% dplyr::filter(Drug =="Epi")
MTi <- abc_df %>% filter(Drug =="Mito")
TRi <- abc_df %>% filter(Drug =="Tras")
VEi <- abc_df %>% filter(Drug == "Veh")

```


```{r extract the stuff}

param_holder <- c()
for (i in ID) {
  thing <- filter(DAi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
daLD <- sapply(param_holder, "[[", 1) 

param_holder <- c()
for (i in ID) {
  thing <- filter(DXi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
   param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
dxLD <- sapply(param_holder, "[[", 1) 

param_holder <- c()
for (i in ID) {
  thing <- filter(EPi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
    param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
epLD <- sapply(param_holder, "[[", 1) 



param_holder <- c()
for (i in ID) {
  thing <- filter(MTi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
    param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
mtLD <- sapply(param_holder, "[[", 1) 


param_holder <- c()
for (i in ID) {
  thing <- filter(TRi, SampleID== i)
  thing.m <- dr4pl(Percent ~ Conc, 
                   data = thing, method.init = "logistic")
    param_holder[[i]] <- IC(thing.m, inhib.percent = c(50))
  
}  
trLD <- sapply(param_holder, "[[", 1) 


```

```{r MT try with drc}
for(k in ID){

  thing <-  filter(MT, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m, 
       type ="bars" ,
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  plot(thing.m,  type="bars", col= 2, add=TRUE )
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  mitols[k] <- a[1]


 }

mitols
```
```{r DA try with drc}
for(k in ID){

  thing <-  filter(DA, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m, 
       type ="bars" ,
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  plot(thing.m,  type="bars", col= 2, add=TRUE )
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  daunls[k] <- a[1]


 }

daunls
```



```{r DX try with drc}
for(k in ID){

  thing <-  filter(DX, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m, 
       type ="bars" ,
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  plot(thing.m,  type="bars", col= 2, add=TRUE )
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  doxols[k] <- a[1]


 }

doxols
```


```{r EP try with drc}
for(k in ID){

  thing <-  filter(EP, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  # plot(thing.m, 
  #      type ="bars" ,
  #      main = paste(thing$Name[1], " ", k),
  #      col= 2,
  #      xlab = expression(paste("Concentration [",mu,"M]")),
  #      ylab = "Percent Viable",
  #      ylim=c(0,1.5))
  # plot(thing.m,  type="bars", col= 2, add=TRUE )
  # 
  a <- ED(thing.m, c(50), interval = "delta")
  # legend("topright", legend = paste(round(a[1],2)))
  epils[[k]] <- a[[1]]


 }

epils
```


```{r TR try with drc}
for(k in ID){

  thing <-  filter(TR, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  # plot(thing.m, 
  #      type ="bars" ,
  #      main = paste(thing$Name[1], " ", k),
  #      col= 2,
  #      xlab = expression(paste("Concentration [",mu,"M]")),
  #      ylab = "Percent Viable",
  #      ylim=c(0,1.5))
  # plot(thing.m,  type="bars", col= 2, add=TRUE )
  # 
  a <- ED(thing.m, c(50), interval = "delta")
  # legend("topright", legend = paste(round(a[1],2)))
  trasls[[k]] <- a[[1]]


 }

trasls
```



```{r VE try with drc}
for(k in ID){

  thing <-  filter(VE, SampleID==k)
  na.omit= TRUE
  thing.m <- drm(Percent~Conc, data = thing, fct=LL.4(c(NA, 0, NA, NA)))
  plot(thing.m, 
       type ="bars" ,
       main = paste(thing$Name[1], " ", k),
       col= 2,
       xlab = expression(paste("Concentration [",mu,"M]")),
       ylab = "Percent Viable",
       ylim=c(0,1.5))
  plot(thing.m,  type="bars", col= 2, add=TRUE )
  
  a <- ED(thing.m, c(50), interval = "delta")
  legend("topright", legend = paste(round(a[1],2)))
  vehls[k] <- a[[1]]


 }

vehls
```














```{r}
###combining all values into a larger dataframe
LDfull <- list(daunls,doxols,epils,mitols)
#renaming the column names
 # for( i in seq_along(LDfull)){
 #    
 #    LD50[[i]]$SampleID <- rep(ID[i],nrow(LDfull[[i]]))
 #    
 #  }

names(LDfull) <- c("Daunorubicin", "Doxorubicin", "Epirubicin", "Mitoxantrone")

# LD50full <-
  LDfull %>% mutate("Individual" = substr(name,4,4))
meanLD <- LD50full %>% dplyr::select(-Sample) %>% group_by(Individual) %>%  dplyr::summarise_each(.,funs(mean))
  

#lmLD <- 
  
  logLD <- meanLD %>% pivot_longer(!Individual, names_to ="Treatment", values_to = "ld50") %>% mutate("log10" = log10(ld50))median(LDfull, col)


ab <- LD50 %>% 
  ggplot(., mapping = (aes(x = (Treatment), y = log10))) +
  geom_point(aes(
    color = Individual,
    size = 5,
    shape = Individual,
    alpha = 0.4)) +
  # labs(title= expression("Mean observed LD"[50]~ "per individual"))+
       xlab("Treatment")+
    ylab(bquote('Log'[10]~ 'LD'[50]~'in '*mu~mol))+
  scale_shape_manual(values = c(15, 16, 17, 15, 18, 16))+
    theme_bw() + 
  theme(plot.title = element_text(hjust =0.5, size = 18))+
  guides(alpha ="none", size = "none") %>% print()  #: to change point shapes
# 
#   geom_line() +
#   facet_wrap( ~ Name) +
#   theme_bw() +
#   labs(title = "Average Viability of Individual Cardiomyocytes After Treatment")+
#        xlab(expression(paste("Concentration [", mu, "M]")))+
#        ylab("Percent Viability")+
#   theme(plot.title = element_text(hjust =0.5, size = 18))+
#   guides(alpha ="none", size = "none")
# 
#   
  ab
  
  
```

LD50full


```{r media ld50 not log}
# 
# 
# daun
# 
#  ind1a      ind1b      ind2a      ind2b      ind3a      ind3b      ind4a      ind4b      ind5a      ind5b 
# 1.00926065 0.03856139 2.38602966 1.90880497 0.69230676 1.04783175 0.49544232 0.53783813 1.41129883 0.49939489 
#      ind6a      ind6b 
# 1.04888989 1.03736364 
# doxo
#  doxols1    doxols2    doxols3    doxols4    doxols5    doxols6    doxols7    doxols8    doxols9   doxols10   doxols11 
#  2.2906076  0.9773591 14.8047803 49.9795646  4.8451495 13.7993338  1.4631495  0.4592608  7.0893006  0.1687517  2.7093847 
#   doxols12 
#  0.8002774 
#  epi
#  ind1a       ind1b       ind2a       ind2b       ind3a       ind3b       ind4a       ind4b       ind5a       ind5b 
#  6.11941804 35.19817394 12.87019412  5.97076382  0.02779486 10.88430888  1.65476958  0.29253173  3.05314644  0.43706259 
#       ind6a       ind6b 
#  1.60455969  0.53305728 
# 
# mito 
#  ind1a     ind1b     ind2a     ind2b     ind3a     ind3b     ind4a     ind4b     ind5a     ind5b     ind6a     ind6b 
# 1.1287081 0.3409535 1.6321703 1.1007397 1.0034770 0.9195866 1.0613525 0.7405098 0.9952677 0.7025685 1.0832924 0.9933416 
 shortld50 <- data.frame(ID)


 shortld50$Daunorubicin <- c(1.00926065, 0.03856139, 2.38602966, 1.90880497, 0.69230676, 1.04783175, 0.49544232, 0.53783813,
                        1.41129883, 0.49939489,1.04888989,1.03736364 )

 shortld50$Doxorubicin <- c(2.2906076,  0.9773591, 14.8047803, 49.9795646,  4.8451495, 13.7993338,  1.4631495,  0.4592608,
                       7.0893006,  0.1687517,  2.7093847,0.8002774)

 shortld50$Epirubicin <- c(6.11941804, 35.19817394, 12.87019412,  5.97076382,  0.02779486, 10.88430888,  1.65476958,
                      0.29253173,  3.05314644,  0.43706259,1.60455969,  0.53305728 )

 shortld50$Mitoxantrone <- c(1.1287081, 0.3409535, 1.6321703, 1.1007397, 1.0034770, 0.9195866, 1.0613525, 0.7405098, 0.9952677, 0.7025685, 1.0832924, 0.9933416)
 
 
 summary(shortld50)
 ld50$ID
 
 
ggplot(data=ld50, aes(y=ld50,x=Drug, color=Drug)) + 
  geom_pointrange(stat = "summary",
                  fun.min = function(z) {quantile(z,0.25)},
                  fun.max = function(z) {quantile(z,0.75)},
                  fun = median, size =3)+ 
  ylim(0, 10)+
  theme_classic()+
  ylab(expression("Median LD"[50]~"in ",mu ~"M"))+
  xlab("Treatment")+
     theme(axis.title=element_text(size=15),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 3))

  
             
plot(ld50)

pull(ld50)
names(ld50)
ld50 <- pivot_longer(ld50, 2:5, names_to ="Drug", values_to = "ld50")

longlf50 <- ld50### decided to rerun and save as a new file##

write_csv(ld50,"ld50calc.csv")
    
     
 
  
  theme(plot.title = element_text(hjust = 0.5, size =25, face ="bold"))+
      ggtitle("Control")+
   theme(axis.title=element_text(size=15),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=10, face = "bold"),
       panel.grid.major = element_line(colour = 'lightgrey'),
       panel.border=element_rect(fill = NA, size = 3))

# daunf <- as.data.frame(daunls)
# doxof <- as.data.frame(doxols)
# epif <- as.data.frame(epils)
# mitof <- as.data.frame(mitols)
# 
# 
# daunf$Drug <- "Daunorubicin"
# doxof$Drug <- "Doxorubicin"
# epif$Drug <- "Epirubicin"
# mitof$Drug <- "Mitoxatrone"
# 
# check <- NULL
# ld50 <- rbind(c(daunf,doxof,epif,mitof))
# check$Mitoxantrone <- do.call(rbind, lapply(mitols, as.data.frame))
# ld50
# clas

```




R###barplot for poster

```{r barplot}

#mean_values <-  abc_df %>% mutate("Indiv" = substr(SampleID,4,4)) %>% 
 # dplyr::group_by(SampleID, Drug, Conc)  
  
in78 <- abc_df %>% 
  dplyr::filter(Drug=="Veh"|Drug =="Doxo") %>%filter(SampleID=="ind5a") %>%  filter(Conc ==1|Conc==0.5)


veh78 <- in78 %>% filter(Drug =="Veh") %>% mutate(Conc = 0*Conc)
dox78 <- in78 %>% filter(Drug =="Doxo")
in78 <- rbind(veh78,dox78)
in78a <- in78 %>% dplyr::select (Percent, Conc) %>% mutate(as.factor(Conc))


ggplot(Test, aes(y=Percent, x=factor(Conc),fill =factor(Conc)))+ 
  stat_summary(fun.data=mean_sdl, geom="bar")+
  stat_summary(fun.data=mean_sdl, fun.args= list(mult =1), 
               geom="errorbar", width=0.3)+
    theme_bw() +ylim(c(0, 1.5))+
  scale_fill_manual(values= c( "orange","red","purple")) +
  #scale_fill_discrete(values =c("red","purple",))+
  labs(title = "Doxorubicin")+ 
  xlab(expression(paste("Drug concentration [", mu, "M]")))+
  ylab("Average Viability")+
  theme(plot.title = element_text(hjust =0.5, size = 18, face="bold"))+
  guides(fill ="none")+
    theme(axis.title=element_text(size=15, color ="black"),
        axis.ticks=element_line(size =2),
        axis.text=element_text(size=15, face = "bold", color ="black"),
        panel.border=element_rect(fill = NA, size = 3))




in78$Percent
in78$Conc

barlot()

summarise(in78)
Test <- c()
Test$Conc <- c(0.0, 0.0, 0.0, 0.0 ,0.0 ,0.0 ,0.0 ,0.0, 1.0, 1.0, 1.0, 0.5, 1.0 ,0.5, 0.5 ,0.5, 0.5)

Test$Percent <- c(0.8613429, 0.9125987 ,0.9434696, 0.9939936 ,1.0131610, 1.0171015, 1.1307707, 1.1275620 ,0.4203752 ,0.5095490 ,0.5525790,0.6806332, 0.6934852, 0.8022452,
0.8758142, 1.0392211,1.0847938)
Test <- as.data.frame(Test)


```

fsys got 
Data for Troponin I release after 0.5 uM treatment at 3 hours and 24 hours


```{r   Troponin i echo=FALSE, warnings = FALSE}
# ###make data frame
dn <- c('Vehicle', 'Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab','Vehicle', 'Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab')
# 
# ng <- c(9615.9,7800.61,3454.27,6171.64,4276.96,11619.86,5237.35,19541.6,16257.39,21097.08,21774.27,26494.72)
# relng <- c(1.003,0.814,0.359,0.628,0.433,1.211,0.921,3.437,2.808,3.712,3.831,4.658)
# relstdv <- c(0.005,0.035,0.097,0.401,0.301,0.129,0.112,0.233,1.547,0.084,0.123,0.533)
# stdv <- c(43,339,930,3845,2886,1241,638,1327,8791,480,698,3027)
# hrs <- c((rep(3,6)), (rep(24,6)))
# 
tidata <- data.frame(dn, relng, relstdv, hrs)
# 
# 
# ##make the plot##

tropimage <- ggplot(tidata, aes(factor (dn, level = c('Vehicle', 'Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab')), y = relng, group = hrs, fill = as.factor(hrs)))+ 
  geom_bar(position = "dodge", stat = "identity")+
  scale_fill_manual(values= c( "dark green","purple4")) +
  ggtitle("Levels of Troponin I release in cell media")+
  theme_bw() +
   xlab("Treatment at 0.5 uM")+
  ylab("Relative Units")+
  scale_y_continuous(
    # don't expand y scale at the lower end
    expand = expansion(mult = c(0, 0.05)))+
  labs(fill = "Hours")+
  theme(axis.title=element_text(size=15, color ="black"),
        plot.title = element_text(hjust =0.5, size = 18),
        axis.ticks=element_line(size =1.5),
        axis.text=element_text(size=9, color ="black"),
        panel.border=element_rect(fill = NA, size = 2))+ 
      #axis.text.y = element_text(angle=45, vjust=1.1, hjust=0.5))+
  geom_errorbar(aes(ymin=relng, ymax=relng+relstdv), width=.2,
                 position=position_dodge(.9))

tropimage 
save_plot("tropimage.png",tropimage)






```
###LDH DATA ###

LDH



```{r LDH,  echo=FALSE, warnings = FALSE}
###LDH levels from individuals###
library(readxl)
X20221115_LDH_75_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/20221115_LDH_75-1.xlsx", 
    sheet = "Sheet1")

#tidata <- data.frame(dn, relng, relstdv, hrs)

X20221110_LDH_87_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/20221110_LDH_87-1.xlsx", 
    sheet = "Sheet1")


X20221201_LDH_77_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/20221201_LDH_77-1.xlsx", 
    sheet = "Sheet1")
X20221201_LDH_78_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/20221201_LDH_78-1.xlsx", 
    sheet = "Sheet1")  #note the name problem 12-01 was not the date of experiment

X20230112_LDH_79_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/20230112_LDH_79-1.xlsx", 
    sheet = "Sheet1")
X20230126_LDH_71_1 <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/20230126_LDH_71-1.xlsx", 
    sheet = "Sheet1")
sig_analysis <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/LDH_analysis_sig.xlsx", col_types = c("text", "numeric", "numeric", 
        "numeric", "text", "numeric", "numeric", "numeric", 
        "numeric", "skip", "skip", "skip", 
        "skip", "skip", "skip", "skip", "skip","skip","skip","skip","skip","skip","skip",
        "skip", "skip"), sheet = "Sheet1")
     
# devtools::install_github("riatelab/cartography")
# CRAN version
install.packages("cartography")
library(cartography)
#### Bind all together and call ldh

ldhresults <- rbind(X20221110_LDH_87_1,X20221115_LDH_75_1,X20221201_LDH_77_1, X20221201_LDH_78_1, X20230112_LDH_79_1)
names(ldhresults)
unique(ldhresults
       )

library(readxl)
library(ggpubr)
library(rstatix)
# LDH_analysis_sig <- read_excel("~/Ward Lab/Cardiotoxicity/Kandace Planning LDH/LDH_analysis_sig.xlsx", 
#     

### take out control
#write_excel_csv(wideldh, "C:/Users/renee/Documents/R_Stuff/DRC_in_r/wideldhresults_full.csv",delim = ";")
ldhresultsf <- ldhresults %>% filter(Drug != 'Control')
##make the plot##
t(wideldh
  )

# (t(ldhresults))
# 
# daunanalysis <- sig_analysis %>% filter(Drug %in% c("Control","Daunorubicin")) %>% mutate(Conc=factor(Conc, levels = c("50","10","5","1","0.5","0.1","0.05","0.01"))) %>% group_by(Drug,Conc) %>%  summarise(mean_ldh = mean(norm_val))
# TukeyHSD(aovsig)
summarise((daunanalysis))
sig_analysis
buildsig <- ggplot_build(atest)
buildsig$data[[3]]
comp_data <- buildsig$data[3]
comp_data
atest$mapping
buildsig$data[[3]][["angle]]"]]

sig_analysis$Drug <- factor(sig_analysis$Drug, levels = c("Control", "Daunorubicin", "Doxorubicin", "Epirubicin", "Mitoxantrone", "Trastuzumab"))
```

```{r}
library(tidyverse)
#my_comparisons <- 
  
  
  
  #rstatix::df_group_by(sig_analysis,c(Drug, Conc))
#shortsig<- 
rLDHshort <-  sig_analysis %>% select(Drug, Conc,  norm_val) %>%  group_by(Drug,Conc) %>%  summarize(mean =mean(norm_val))#, mean(norm_val)))
  #%>% mutate(meanLDH= mean(rLDH))
                                                                       #mutate()nova_test(data=shortsig, norm_val~Drug+Conc)#, within = 'Conc', between = 'Drug')
bpt <- ggboxplot(rLDHshort,x= 'Conc', y='mean', group = "Drug")
bpt + facet_wrap("Drug")
#atest <-
  ggplot(sig_analysis, aes(x = as.factor(Conc), y = norm_val, group = Conc)) +
  geom_boxplot(aes(fill = as.factor(Conc))) +
  #geom_point(aes(color= indv))+
  stat_compare_means(method="t.test", ref.group=1, label="p",angle = 75,hide.ns = TRUE, label.y=c(4.5),label.x= c(1.5,2.5,3.5,4.5,5.5,6.5,7.5),aes(angle=90))+
    scale_fill_manual(values = c("#F3BABD","#EAA2A5","#E28A8E",
                "#DA7277","#CF5157","#C43138","#982124","#6B1210" ),
    aesthetics = c("Conc", "fill")) + 
      guides(fill = FALSE) +
      #geom_hline(yintercept = 1) +
      theme_bw() +
      xlab(expression(paste("Drug [", mu, "M]"
      ))) +
      ylab("LDH release") +
      labs(fill = "Individual") +
      facet_wrap("Drug") +
      theme(strip.background = element_blank()) +
      theme(
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(size = 1.5),
        axis.text = element_text(size = 9, color = "black", angle = 20),
        panel.border = element_rect(fill = NA, size = 2),
        panel.background = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent", colour = NA),
        strip.text.x = element_text(size = 15, color = "black", face = "bold")) 
      
```












 ylab("Relative to Control Cells") +
      # labs(fill = "Concentration") +
      # show.legend = FALSE +
      # facet_wrap("Drug") +
      # theme(
      #   legend.posistion = "none" ,
      #   strip.background = element_blank(),
      #   strip.placement = "outside",
      #   axis.title = element_text(size = 15, color = "black"),
      #   axis.ticks = element_line(size = 1.5),
      #   axis.text = element_text(size = 10, color = "black"),
        
    
png("tropimage.png")
print(tropimage)
 dev.off()
libarary(magrittir)
selecting and redoing analysis
ldhresults
ldhnew <- select(ldhresults, c(indv,Drug,Conc,rLDH)) 
colnames(ldhnew)
wideldh <- pivot_wider(ldhnew, -id_cols=c(Drug,indv),id_expand= TRUE,names_from =Conc, values_from = c(rLDH))

ave_ldh <- ldhnew %>%  group_by(Drug,Conc) %>%
  summarise_at(vars(rLDH), list(name = mean)) %>% filter(Drug=="Control")

atest 
 )save_plot('tranparentLDH.png', atest)
 atest 
 tag_facet(atest)
 atest
library(egg)
library(tidyverse)
library(dplyr)
```



*** calculated ld50 values

```{r ld50 bind echo=FALSE, warnings = FALSE}

ldall <- bind_rows(daunls,doxols, epils, mitols,trasls)
str(ldall
  )
row.names(ldall) <- c('Daunorubicin', 'Doxorubicin', 'Epirubicin', 'Mitoxantrone', 'Trastuzumab')

rowMeans(ldall)
summary(ldall)
ldall$row_median = apply(ldall[,-1], 1, median)

ldall1 <- ldall[, (names(ldall) %in% ID)]
ldall$group_1median = apply(ldall1[,2:7], 1, median)

```







