---
title: "Cormotifcluster_analysis"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Import libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(gprofiler2)
library(readr)
library(BiocGenerics)
library(gridExtra)
library(VennDiagram)
library(kableExtra)
library(scales)
library(ggVennDiagram)
library(Cormotif)
library(RColorBrewer)
library(ggpubr)
```

# Creation of the data set:
```{r echo=FALSE, r,file='corMotifcustom.R'}

```

```{r data import, echo=TRUE,eval=FALSE, message=FALSE, warning=FALSE}
library(edgeR)
library(Cormotif)
library(RColorBrewer)

library(BiocParallel)
## read in count file##
design <- read.csv("data/data_outline.txt", row.names = 1)
mymatrix <- readRDS("data/filtermatrix_x.RDS")#should be 14084
x_counts <- mymatrix$counts

indv <- as.factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12)))
time <- rep((rep(c("3h", "24h"), c(6,6))), 6)
time <- ordered(time, levels =c("3h", "24h"))
group <- as.factor(rep((c("1","2","3","4","5","6","7","8","9","10","11","12")),6))
drug <- rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Vehicle"),12)
group1 <- interaction(drug,time)
label <- (interaction(substring(drug, 0, 2), indv, time))
colnames(x_counts) <- label
group_fac <- group1
groupid <- as.numeric(group_fac)

compid <- data.frame(c1= c(1,2,3,4,5,7,8,9,10,11), c2 = c( 6,6,6,6,6,12,12,12,12,12))

y_TMM_cpm <- cpm(x_counts, log = TRUE)

colnames(y_TMM_cpm) <- label
y_TMM_cpm
set.seed(12345)
cormotif_initial <- cormotiffit(exprs = y_TMM_cpm,
                             groupid = groupid,
                             compid = compid,
                             K=1:8, max.iter = 500,runtype="logCPM")
gene_prob_tran <- cormotif_initial$bestmotif$p.post
rownames(gene_prob_tran) <- rownames(y_TMM_cpm)
motif_prob <- cormotif_initial$bestmotif$clustlike
rownames(motif_prob) <- rownames(y_TMM_cpm)
write.csv(motif_prob,"cormotif_probability_genelist.csv")

```

cormotif_initial was created after calling corMotif, then running the corMotifcustom.R script. The extra R script enabled me to generate a table containing the likelihood of each gene that belongs to the specific cluster.

After generating the Motifs from 1 to 8, the number of motifs that best fit the data was 4 using the BIC and AIC results below.

```{r plot motifs, echo=TRUE, message=FALSE, warning=FALSE}
cormotif_initial <- readRDS("data/cormotif_initialall.RDS")#
plotIC(cormotif_initial)
plotMotif(cormotif_initial)

```

Viewing the motifs, the following groups were named:

-   Motif 1: No Response (n=7409)

-   Motif 2: Top2$\beta$ inhibitor response, Time-independent     

    + (Time-independent response, n= 589)

-   Motif 3: Top2$\beta$ inhibitor response, Early 

    + (Early response, n= 487)
    
-   Motif 4: Top2$\beta$ inhibitor response, Late 

    + (Late response, n= 5596)
    
    


```{r cormotif_inital analysis, eval= FALSE,echo=TRUE, message=FALSE, warning=FALSE}
clust1 <- motif_prob %>%
  as.data.frame() %>%
  filter(V1>0.5) %>% 
  rownames
clust2 <- motif_prob %>%
  as.data.frame() %>%
  filter(V2>0.5) %>% 
  rownames
clust3 <- motif_prob %>%
  as.data.frame() %>%
  filter(V3>0.5) %>% 
  rownames
clust4 <- motif_prob %>%
  as.data.frame() %>%
  filter(V4>0.5) %>% 
  rownames
old_clust1  <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.45 &
                                          gene_prob_tran[,2] <0.45 &
                                          gene_prob_tran[,3] <0.45 &
                                          gene_prob_tran[,4] <0.45 &
                                          gene_prob_tran[,5] <0.45 &
                                          gene_prob_tran[,6] <0.45 &
                                          gene_prob_tran[,7] <0.45 &
                                          gene_prob_tran[,8] <0.45 &
                                          gene_prob_tran[,9] <0.45 &
                                         gene_prob_tran[,10] <0.45),])
length(intersect(old_clust1,clust1))##7358 out of 7362 oldclust1

old_clust2  <- rownames(gene_prob_tran[(gene_prob_tran[,1]> 0.10 &
                                         gene_prob_tran[,2] > 0.10 &
                                         gene_prob_tran[,3] > 0.10 &
                                         gene_prob_tran[,4] > 0.10 &
                                         # gene_prob_tran[,5] < 0.10 &
                                           gene_prob_tran[,6] > 0.10&
                                           gene_prob_tran[,7]> 0.10 &
                                           gene_prob_tran[,8]> 0.10 &
                                           gene_prob_tran[,9]> 0.10),])
# &                                      # gene_prob_tran[,10]< 0.10),])
                                                   
length(intersect(old_clust2,clust2))##251 out of 432 oldclust2

old_clust3 <- rownames(gene_prob_tran[(gene_prob_tran[,1]>0.55 &
                                           gene_prob_tran[,2] >0.55 &
                                           gene_prob_tran[,3] >0.55 &
                                           gene_prob_tran[,4] >0.25&
                                           gene_prob_tran[,5] <0.90 &
                                           gene_prob_tran[,6] <0.9 &
                                           gene_prob_tran[,7]<0.9&
                                           gene_prob_tran[,8]<0.9 &
                                          gene_prob_tran[,9]<0.9 &
                                           gene_prob_tran[,10]<0.90),])
length(intersect(old_clust3,clust3)) ##414 out of 481 oldclust3

old_clust4 <- rownames(gene_prob_tran[(gene_prob_tran[,1] <0.970 &
                                            gene_prob_tran[,2] <0.97 &
                                            gene_prob_tran[,3] <0.97 &
                                            gene_prob_tran[,4] <0.97 &
                                            gene_prob_tran[,5] <0.9&
                                            gene_prob_tran[,6] >0.55 &
                                            gene_prob_tran[,7] >0.55 &
                                            gene_prob_tran[,8] >0.55 &
                                            gene_prob_tran[,9] >0.05 &
                                            gene_prob_tran[,10] <0.9),])
length(intersect(old_clust4,clust4))##4675 out of 4850 oldclust4
backGL <- read.csv("data/backGL.txt")  ##14084
length(setdiff(backGL$ENTREZID,(union(clust1,union(clust2,union(clust3,clust4))))))
##63 genes not used overall  same as (14084-7504-528-444-5545)


```

### Pie Chart of overall numbers

```{r piechart and lollipop  }
#make data frame
Set <- c("Early Response set","Late Response set", "Time-Independent Response set", "No Response set")
gene_num <- c(444,5545,528,7504)
fills <- c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF")

pie_chartdata <- data.frame(Set, gene_num, fills)
 
    pie(gene_num,labels =Set )       



```
```{r barchart lolli chart}
library(stringr)
pie_chartdata %>% 
  ggplot(.,aes(x=as.factor(Set),y=gene_num))+
  geom_bar(stat="identity", fill=fills)+
  geom_text(aes(label = gene_num, vjust=-.2))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  ggtitle("Number of genes in each set")+
  ylab("Count")+
  xlab("Set")+
  
  theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
  


```
The genes belonging to each set were identified by the following:

motif 1-  No Response set: 7504 (gene list made by filtering likelihood of gene belonging to cluster 1 <0.5) 

motif 2-  Time-independent Top2$\beta$i response cluster: 528 (gene list made by filtering likelihood of gene belonging to cluster 2 <0.5) 

motif 3- Early Top2$\beta$i response cluster: 444 (gene list made by filtering likelihood of gene belonging to cluster 3 <0.5) 

motif 4-  Late Top2$\beta$i response cluster: 5545 (gene list made by filtering likelihood of gene belonging to cluster 4 <0.5) 


There was overlap between the previous sets and the new sets, so I moved on expecting similar responses in the GO analysis.  I did subset out the genes not used overall from the background gene list (rowmeans>0 from log(cpm(count matrix)))

```{r cormotif genelist analysis}
DEG_cormotif <- readRDS("data/DEG_cormotif.RDS")
motif_NR <- DEG_cormotif$motif_NR
motif_TI <- DEG_cormotif$motif_TI
motif_LR <- DEG_cormotif$motif_LR
motif_ER <- DEG_cormotif$motif_ER
  
backGL <- read.csv("data/backGL.txt")
#NRresp <- read_csv("data/cormotif_NRset.txt")

```

##  No response motif genes
GO:BP
```{r noresponse data motif1, echo=FALSE, message=FALSE, warning=FALSE}
# gostrescoNR <- gost(query = motif_NR ,
#                      organism = "hsapiens",
#                        ordered_query = FALSE,
#                        domain_scope = "custom",
#                        measure_underrepresentation = FALSE,
#                        evcodes = FALSE,
#                        user_threshold = 0.05,
#                        correction_method = c("fdr"),
#                        custom_bg = backGL$ENTREZID,
#                        sources=c("GO:BP", "KEGG"))

#saveRDS(gostrescoNR, "data/gostrescoNR.")
gostrescoNR <- readRDS("data/gostrescoNR")
cormotifNRcluster <- gostplot(gostrescoNR, capped = FALSE, interactive = TRUE)
cormotifNRcluster

# (gostres$result$p_value)
tableNR <- gostrescoNR$result %>%
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value)) 
tableNR%>% 
  mutate_at(.cols = 6, .funs= scientific_format()) %>% 
  kable(.,) %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")
  write.csv(tableNR,"output/tableNR.csv")
##GO:BP  
  tableNR %>% dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value),col=intersection_size)) +
    geom_point(aes(size = intersection_size)) +
    ggtitle('No response enriched GO:BP terms') +
   xlab(expression("-log"[10]~"(p-value)"))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ylab("GO: BP term")+
    scale_y_discrete(labels = wrap_format(30))+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
##kegg
  
  tableNR %>% 
    dplyr::filter(source!="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=15 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, 
                 y =reorder(term_name,p_value),
                 col=intersection_size)) +
    geom_point(aes(size = intersection_size, col="red")) +
    ggtitle('No response enriched KEGG terms') +
    scale_y_discrete(labels = wrap_format(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    xlab(expression("-log"[10]~"(p-value)"))+
    ylab("KEGG term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))

  
  
```

## Late response Top2$\beta$ inhibitor motif genes
GO:BP/KEGG
```{r Top2iLR motif set, echo=FALSE, message=FALSE, warning=FALSE}


# gostresTop2bi_LR <- gost(query = c(motif_LR),
#                       organism = "hsapiens",
#                       ordered_query = FALSE,
#                       domain_scope = "custom",
#                       measure_underrepresentation = FALSE,
#                       evcodes = FALSE,
#                       user_threshold = 0.05,
#                       correction_method = c("fdr"),
#                       custom_bg = backGL$ENTREZID,
#                       sources=c("GO:BP", "KEGG"))
# saveRDS(gostresTop2bi_LR,"data/gostresTop2bi_LR.RDS")
gostresTop2bi_LR <- readRDS("data/gostresTop2bi_LR.RDS")
cormotifrespTop2bi_LR <- gostplot(gostresTop2bi_LR, capped = FALSE, interactive = TRUE)
cormotifrespTop2bi_LR


tabletop2Bi_LR <- gostresTop2bi_LR$result %>%
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value)) 
  
tabletop2Bi_LR%>% 
  mutate_at(.cols = 6, .funs= scientific_format()) %>% 
  kable(.,) %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")
 write.csv(tabletop2Bi_LR,"output/tabletop2Bi_LR.csv") 
  
  tabletop2Bi_LR %>% dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,log_val), col= intersection_size)) +
    geom_point(aes(size = intersection_size)) +
    scale_y_discrete(labels = wrap_format(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Late Response enriched GO:BP terms') +
    xlab(expression("-log"[10]~"(p-value)"))+
    ylab("GO: BP term")+
      theme_bw()+
    theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))

  
 tabletop2Bi_LR %>% 
    dplyr::filter(source!="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=20 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value),col=intersection_size)) +
    geom_point(aes(size = intersection_size, col="red")) +
   scale_y_discrete(labels = wrap_format(30))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Late Response enriched KEGG terms') +
   xlab(expression("-log"[10]~"(p-value)"))+
    ylab("KEGG term")+
      theme_bw()+
 theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 10, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
  


```

##  Early Response Top2$\beta$ inhibitor motif genes
GO:BP/KEGG
```{r Top2iER set motif, echo=FALSE, message=FALSE, warning=FALSE}


# gostresTop2bi_ER <- gost(query = c(motif_ER),
#                       organism = "hsapiens",
#                       ordered_query = FALSE,
#                       domain_scope = "custom",
#                       measure_underrepresentation = FALSE,
#                       evcodes = FALSE,
#                       user_threshold = 0.05,
#                       correction_method = c("fdr"),
#                       custom_bg = backGL$ENTREZID,
#                       sources=c("GO:BP", "KEGG"))
 #saveRDS(gostresTop2bi_ER, "data/gostresTop2bi_ER.RDS")

gostresTop2bi_ER <- readRDS("data/gostresTop2bi_ER.RDS")
cormotifrespTop2bi_ER <- gostplot(gostresTop2bi_ER, capped = FALSE, interactive = TRUE)

gostresTop2bi_ER$result %>% 
  mutate_at(.cols = 6, .funs= scientific_format()) %>% 
  kable(.,) %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")
 
tabletop2Bi_ER <- gostresTop2bi_ER$result %>%
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value)) 
write.csv(tabletop2Bi_ER,"output/tabletop2Bi_ER.csv")
#%>% 
  # mutate_at(.cols = 6, .funs= scientific_format()) %>% 
  # kable(.,) %>% 
  # kable_paper("striped", full_width = FALSE) %>%  
  # kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover"))
tabletop2Bi_ER %>% 
  mutate_at(.cols = 6, .funs= scientific_format()) %>% 
  kable(.,) %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")
  
  tabletop2Bi_ER %>% 
    dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=13 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value),col=intersection_size)) +
    geom_point(aes(size = intersection_size)) +
    scale_y_discrete(labels = wrap_format(35))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Early Response enriched GO:BP terms') +
    xlab(expression("-log"[10]~"(p-value)"))+
    ylab("GO: BP term")+
      theme_bw()+
 theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 8, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
  
tabletop2Bi_ER %>% 
    dplyr::filter(source!="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=15 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   ggplot(., aes(x = log_val,y = reorder(term_name,p_value),
                 col=intersection_size)) +
  geom_point(aes(size = intersection_size, col="red")) +
  scale_y_discrete(labels = wrap_format(35))+
  guides(col="none", 
         size=guide_legend(title ="# of intersected \n terms"))+
  ggtitle('Early Response enriched KEGG terms') +
 xlab(expression("-log"[10]~"(p-value)"))+
  ylab("KEGG term")+
  theme_bw()+
  theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 9, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))


```

## Time-independent Top2$\beta$ inhibitor motif genes
GO:BP/KEGG
```{r time independent, echo=FALSE, message=FALSE, warning=FALSE  }

# gostresTop2bi_TI <- gost(query = c(motif_TI),
#                       organism = "hsapiens",
#                       ordered_query = FALSE,
#                       domain_scope = "custom",
#                       measure_underrepresentation = FALSE,
#                       evcodes = FALSE,
#                       user_threshold = 0.05,
#                       correction_method = c("fdr"),
#                       custom_bg = backGL$ENTREZID,
#                       sources=c("GO:BP", "KEGG"))
# 
#  saveRDS(gostresTop2bi_TI, "data/gostresTop2bi_TI.RDS")

gostresTop2bi_TI <- readRDS("data/gostresTop2bi_TI.RDS")
cormotifrespTop2bi_TI <- gostplot(gostresTop2bi_TI, capped = FALSE, interactive = TRUE)
cormotifrespTop2bi_TI


tabletop2Bi_TI <- gostresTop2bi_TI$result %>%
  dplyr::select(c(source, term_id, term_name,intersection_size, term_size, p_value)) 
write.csv(tabletop2Bi_TI,"output/tabletop2Bi_TI.csv")

tabletop2Bi_TI %>% 
  mutate_at(.cols = 6, .funs= scientific_format()) %>% 
  kable(.,) %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped","hover")) %>% 
  scroll_box(width = "100%", height = "400px")



  
  
  tabletop2Bi_TI %>% 
    dplyr::filter(source =="GO:BP") %>%
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=13 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value),col=intersection_size)) +
    geom_point(aes(size = intersection_size)) +
    scale_y_discrete(labels = wrap_format(35))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Time independent response enriched GO:BP terms') +
    xlab(expression("-log"[10]~"(p-value)"))+
    #scale_x_continuous(expand = expansion(mult = .2))+
    ylab("GO: BP term")+
     theme_bw()+
 theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 8, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
  
  
  
  tabletop2Bi_TI %>% 
    dplyr::filter(source =="KEGG") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=15 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%
   # slice_max(., n=10,order_by = p_value) %>%
   ggplot(., aes(x = log_val, y =reorder(term_name,p_value),col=intersection_size)) +
    geom_point(aes(size = intersection_size, col="red")) +
  scale_y_discrete(labels = wrap_format(35))+
    guides(col="none", size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Time independent response enriched KEGG terms') +
   xlab(expression("-log"[10]~"(p-value)"))+
    #scale_x_continuous(expand = expansion(mult = .2))+
    ylab("KEGG term")+
      theme_bw()+
 theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 9, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))


```

### long GO:BP frame

```{r all go in one loooooong frame, echo=FALSE, fig.height=15, fig.width=8, message=FALSE, warning=FALSE}

NR1f <- tableNR %>% dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) %>%mutate(order_val=rev(as.numeric(rownames(.))))

LR3f <- tabletop2Bi_LR %>% dplyr::filter(source=="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=9 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value))  %>%  mutate(order_val=rev(as.numeric(rownames(.))))


TI3f <- tabletop2Bi_TI %>% 
    dplyr::filter(source =="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value))  %>% mutate(order_val=rev(as.numeric(rownames(.))))

ER3f <- tabletop2Bi_ER %>% 
    dplyr::filter(source =="GO:BP") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value))  %>% mutate(order_val=rev(as.numeric(rownames(.))))

GOmotiflong <-list("Early Response"=ER3f,"Late Response"=LR3f,"Time-Independent\nResponse"=TI3f, "No Response"=NR1f)
GOBPlong <- data.table::rbindlist(GOmotiflong, idcol = "motif")
p <- GOBPlong %>% mutate(motif=fct_inorder(motif)) %>% 
  
ggplot(., aes(x = log_val, y=reorder(term_name, order_val, desc=FALSE),col=motif)) +
    geom_point(aes(size = intersection_size, col=motif)) +
  scale_y_discrete(labels = wrap_format(40))+
  facet_grid(motif~., scales = "free_y")+
  
    guides(col=guide_legend(title="Motif group"), size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Top 10 enriched GO:BP terms for each motif') +
     xlab(expression("-log"[10]~"(p-value)"))+
    #scale_x_continuous(expand = expansion(mult = .2))+
    ylab("GO:BP term")+
      theme_bw()+
 theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 8, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))


#https://stackoverflow.com/questions/41631806/change-facet-label-text-and-background-colour/60046113#60046113
g <- ggplot_gtable(ggplot_build(p))
stripr <- which(grepl('strip-r', g$layout$name))
fills <- c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF")
k <- 1
for (i in stripr) {
  j <- which(grepl('rect', g$grobs[[i]]$grobs[[1]]$childrenOrder))
  g$grobs[[i]]$grobs[[1]]$children[[j]]$gp$fill <- fills[k]
  k <- k+1
}
#print(grid::grid.draw(g))
grid.draw(g)
#hex <- hue_pal()(4)

#hex
#> hex (red/green/blue/purple default in ggplot)
#[1] "#F8766D" "#7CAE00" "#00BFC4" "#C77CFF"
#p

```

###long go KEGG frame

```{r kegg break, echo=FALSE, message=FALSE, warning=FALSE}



LR3fk <- tabletop2Bi_LR %>% dplyr::filter(source=="KEGG") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value))


TI3fk <- tabletop2Bi_TI %>% 
    dplyr::filter(source =="KEGG") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) 

ER3fk <- tabletop2Bi_ER %>% 
    dplyr::filter(source =="KEGG") %>% 
    dplyr::select(p_value,term_name,intersection_size) %>%
    slice_min(., n=10 ,order_by=p_value) %>%
    mutate(log_val = -log10(p_value)) 

KEGGmotiflong <-list("ER"=ER3fk,"LR"=LR3fk,"TI"=TI3fk)
KEGGlong <- data.table::rbindlist(KEGGmotiflong, idcol = "motif")
KEGGlong %>% group_by(motif) %>% 
ggplot(., aes(x = log_val, y =reorder(term_name,p_value,desc=FALSE),col=motif)) +
    geom_point(aes(size = intersection_size, col=motif)) +
  scale_y_discrete(limits=rev,labels = wrap_format(30))+
    guides(col=guide_legend(title="Motif group"), size=guide_legend(title = "# of intersected \n terms"))+
    ggtitle('Top enriched KEGG terms for each motif') +
    xlab(expression("-log"[10]~"(p-value)"))+
    #scale_x_continuous(expand = expansion(mult = .2))+
    ylab("KEGG term")+
      theme_bw()+
 theme(plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 9, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))

```
## Example of genes from each cluster

### Motif_NR
```{r clust1NR gene,echo=FALSE, message=FALSE, warning=FALSE}
time <- rep((rep(c("3h", "24h"), c(6,6))), 6)
time <- ordered(time, levels =c("3h", "24h"))
drug <- rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Control"),12)
indv <- as.factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12)))
labeltop <- (interaction(substring(drug, 0, 2), indv, time))
FCtoplistall <- read.csv("output/toplistall.csv", row.names = 1)
library(limma)
library(tidyverse)
library(biomaRt)
library(RColorBrewer)
library(ggpubr)
drug_palNoVeh <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")

drug_pal <- c("#41B333","#8B006D","#DF707E","#F1B72B", "#3386DD","#707031")
#fills <- c("#F8766D", "#7CAE00", "#00BFC4", "#C77CFF")

DEG_cormotif <- readRDS("data/DEG_cormotif.RDS")
motif_NR <- DEG_cormotif$motif_NR
motif_TI <- DEG_cormotif$motif_TI
motif_LR <- DEG_cormotif$motif_LR
motif_ER <- DEG_cormotif$motif_ER
write.csv(motif_ER,"motif_ER.txt")
write.csv(motif_TI,"motif_TI.txt")
write.csv(motif_LR,"motif_LR.txt")
write.csv(motif_NR,"motif_ER.txt")
set.seed(12345)
#geneexpressionsets <- c(sample(motif_NR,1),sample(motif_TI,1),sample(motif_LR,1),sample(motif_ER,1))
#[1] "27102"  "92312"  "10360"  "388558"  "newest sample set as of 04192023
#geneexpressionsets <- c( "27102" , "92312" , "10360",  "388558")
geneexpressionsets=c("2650","92312","27245","55588")# first number set (also in the previous example)

ensembl <- useMart("ensembl", dataset="hsapiens_gene_ensembl")
my_chr <- c(1:22, 'M', 'X', 'Y')  ## creates a filter for each database
#attributes <- listAttributes((ensembl))
my_attributes <- c('entrezgene_id', 'ensembl_gene_id', 'hgnc_symbol')


Motif_expr<- getBM(attributes=my_attributes,filters ='entrezgene_id',
         values = geneexpressionsets, mart = ensembl)
# toplistall %>% dplyr::filter(ENTREZID==Motif_expr[1,1])

#namelist <- c("1026"="CDKN1A","23411"= "SIRT1","27113"= "BBC3","4193"= "MDM2")
cpmcounts <- read.csv("data/filtered_cpm_counts.csv", row.names = 1)
length(cpmcounts)
colnames(cpmcounts) <- labeltop

cpmcounts %>% dplyr::filter(rownames(.)==geneexpressionsets[1]) %>%
  pivot_longer(everything(), names_to = "treatment",values_to = "counts") %>%
  mutate(drug=rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Control"),12)) %>%
  mutate(time = rep((rep(c("3h", "24h"), c(6,6))), 6)) %>%
  mutate(time=factor(time, levels =c("3h", "24h"))) %>%
  mutate(indv=factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12)))) %>%
  ggplot(., aes(x=drug, y=counts))+
    geom_boxplot(position="identity",aes(fill=drug))+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none", size= "none",  indv="none")+
  scale_color_brewer(palette = "Dark2",guide = "none")+
  scale_fill_manual(values=drug_pal)+
    facet_wrap("time",  nrow=1, ncol=2)+
  theme_bw()+
  ylab(expression(atop("No Response set",italic("GCNT1")~log[2]~"cpm ")))+
  xlab("")+
  xlab("")+
  theme(strip.background = element_rect(fill = "#C77CFF"),
        plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.x = element_text(size = 12, color = "white", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))

```

### Motif_TI
```{r clustTI,echo=FALSE, message=FALSE, warning=FALSE}

cpmcounts %>% dplyr::filter(rownames(.)==92312) %>%
  pivot_longer(everything(), names_to = "treatment",values_to = "counts") %>%
  mutate(drug=rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Control"),12)) %>%
  mutate(time = rep((rep(c("3h", "24h"), c(6,6))), 6)) %>% mutate(time=factor(time, levels =c("3h", "24h"))) %>%
  mutate(indv=factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12)))) %>%
  ggplot(., aes(x=drug, y=counts))+
  geom_boxplot(position="identity",aes(fill=drug))+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none", size= "none",  indv="none")+
  scale_color_brewer(palette = "Dark2",guide = "none")+
  scale_fill_manual(values=drug_pal)+
  facet_wrap("time", nrow=1, ncol=2)+
  theme_bw()+
  ylab(expression(atop("Time-Independent set",italic("MEX3A")~log[2]~"cpm ")))+
  xlab("")+
  theme(strip.background = element_rect(fill = "#00BFC4"),
        plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.x = element_text(size = 12, color = "white", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))

```

### Motif_LR
```{r motif_LR, echo=FALSE, message=FALSE, warning=FALSE}

cpmcounts %>% dplyr::filter(rownames(.)==55588) %>%
  pivot_longer(everything(), names_to = "treatment",values_to = "counts") %>%
  mutate(drug=rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Control"),12)) %>%
  mutate(time = rep((rep(c("3h", "24h"), c(6,6))), 6)) %>%
  mutate(time=factor(time, levels =c("3h", "24h"))) %>%
  mutate(indv=factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12)))) %>%
  ggplot(., aes(x=drug, y=counts))+
  geom_boxplot(position="identity",aes(fill=drug))+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none", size= "none",  indv="none")+
  scale_color_brewer(palette = "Dark2",guide = "none")+
  scale_fill_manual(values=drug_pal)+
  facet_wrap("time",  nrow=1, ncol=2)+
  theme_bw()+
  ylab(expression(atop("Late Response set",italic("MED29")~log[2]~"cpm ")))+
  xlab("")+
  xlab("")+
  theme(strip.background = element_rect(fill = "#7CAE00"),
        plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.x = element_text(size = 12, color = "white", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
```

### Motif_ER
```{r motif ER, echo=FALSE, message=FALSE, warning=FALSE}
cpmcounts %>% dplyr::filter(rownames(.)==27245) %>%
  pivot_longer(everything(), names_to = "treatment",values_to = "counts") %>%
  mutate(drug = rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Control"),12)) %>%
  mutate(time = rep((rep(c("3h", "24h"), c(6,6))), 6)) %>%
  mutate(time=factor(time, levels =c("3h", "24h"))) %>%
  mutate(indv=factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12)))) %>%
  ggplot(., aes(x=drug, y=counts))+
  geom_boxplot(position="identity",aes(fill=drug))+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none", size= "none",  indv="none")+
  scale_color_brewer(palette = "Dark2",guide = "none")+
  scale_fill_manual(values=drug_pal)+
  facet_wrap("time",nrow=1, ncol=2)+
  theme_bw()+
  ylab(expression(atop("Early Response set",italic("AHDC1")~log[2]~"cpm ")))+
  xlab("")+
  xlab("")+
  theme(strip.background = element_rect(fill = "#F8766D"),
        plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text.x = element_text(size = 12, color = "white", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))
```




