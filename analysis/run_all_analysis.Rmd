---
title: "Run_all_analysis"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document:
    toc: yes
    theme: flatly
editor_options: 
  markdown: 
    wrap: 72
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```

This starts the documentation of the RNA-seq cardiotoxicity analysis for my manuscript
```{r library loading, warning=FALSE, echo=TRUE, message=FALSE}

library(edgeR)#
library(limma)#
library(RColorBrewer)
library(mixOmics)
library(gridExtra)#
library(reshape2)#
library(devtools)
library(AnnotationHub)
library(tidyverse)
library(scales)
library(biomaRt)#
library(Homo.sapiens)
library(cowplot)#
library(ggrepel)#
library(corrplot)
library(Hmisc)


```


```{r functions for graphs, warning=FALSE, echo=FALSE, message=FALSE}}

x_axis_labels=function(labels,every_nth=1,...) {
    axis(side=1,at=seq_along(labels),labels=F)
    text(x=(seq_along(labels))[seq_len(every_nth)==1],
        y=par("usr")[3]-0.075*(par("usr")[4]-par("usr")[3]),
        labels=labels[seq_len(every_nth)==1],xpd=TRUE,...)
}
```



```{r file loading, eval=TRUE, include=FALSE}

design <- read.csv("data/data_outline.txt", row.names = 1)
mymatrix <- readRDS("data/allmatrix.RDS")

##below only done once
#myfiles <- list.files(path = "~/Ward Lab/Cardiotoxicity/Data/counts/counts", pattern ="*.txt")
# mymatrix <- readDGE(files = myfiles, path = "~/Ward Lab/Cardiotoxicity/Data/counts/counts/", group =as.factor(rep((c("1","2","3","4","5","6","7","8","9","10","11","12")),6)))
# 
# saveRDS(mymatrix, "data/allmatrix.RDS")

time <- rep((rep(c("3h", "24h"), c(6,6))), 6) 
time <- ordered(time, levels =c("3h", "24h"))
mymatrix$samples$time <- time

indv <- as.factor(rep(c(1,2,3,4,5,6), c(12,12,12,12,12,12))) 
mymatrix$samples$indv <- indv

group <- as.factor(rep((c("1","2","3","4","5","6","7","8","9","10","11","12")),6))

drug <- rep(c("Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab", "Vehicle"),12)
mymatrix$samples$drug <- drug

RIN <- c(9.3,9.8,  9.8, 10.0,  9.6,  9.9,  7.8,  8.7,  8.6,  9.1,  9.4,  9.3,  9.4,  9.6,  9.9,  9.4,  9.9,  9.8,9.5,  9.9,  9.6,  9.9,  8.8,  9.5,  9.3, 10.0,  9.3,  9.6,  9.7,  9.4,  8.9,  7.5,  8.6,  8.5,  8.6,  9.3,9.6,  9.6,  9.4,  9.7,  9.9, 10.0,  9.4,  9.6,  9.4,  9.5,  9.8,  9.5,  9.6,  9.7,  9.6,  9.9,  9.6, 10.0,8.3, 8.4,9.4,9.7, 10.0, 10.0,  9.6,  9.6,  9.7,  9.5,  9.8,  9.5,  9.8,  8.6,  8.9,  9.1,  9.3,9.6)
mymatrix$samples$RIN <- RIN

samplenames <- c("MCW_RM_R_11", "MCW_RM_R_12", "MCW_RM_R_13", "MCW_RM_R_14", "MCW_RM_R_15","MCW_RM_R_16", "MCW_RM_R_17", "MCW_RM_R_18", "MCW_RM_R_19", "MCW_RM_R_20","MCW_RM_R_21", "MCW_RM_R_22", "MCW_RM_R_23", "MCW_RM_R_24", "MCW_RM_R_25","MCW_RM_R_26", "MCW_RM_R_27", "MCW_RM_R_28", "MCW_RM_R_29", "MCW_RM_R_30","MCW_RM_R_31", "MCW_RM_R_32", "MCW_RM_R_33", "MCW_RM_R_34", "MCW_RM_R_35","MCW_RM_R_36", "MCW_RM_R_37", "MCW_RM_R_38", "MCW_RM_R_39", "MCW_RM_R_40","MCW_RM_R_41", "MCW_RM_R_42", "MCW_RM_R_43", "MCW_RM_R_44","MCW_RM_R_45","MCW_RM_R_46","MCW_RM_R_47","MCW_RM_R_48", "MCW_RM_R_49", "MCW_RM_R_50","MCW_RM_R_51", "MCW_RM_R_52", "MCW_RM_R_53", "MCW_RM_R_54", "MCW_RM_R_55","MCW_RM_R_56","MCW_RM_R_57", "MCW_RM_R_58", "MCW_RM_R_59", "MCW_RM_R_60","MCW_RM_R_61", "MCW_RM_R_62", "MCW_RM_R_63", "MCW_RM_R_64", "MCW_RM_R_65","MCW_RM_R_66", "MCW_RM_R_67", "MCW_RM_R_68", "MCW_RM_R_69", "MCW_RM_R_70","MCW_RM_R_71","MCW_RM_R_72", "MCW_RM_R_73", "MCW_RM_R_74", "MCW_RM_R_75","MCW_RM_R_76", "MCW_RM_R_77", "MCW_RM_R_78", "MCW_RM_R_79", "MCW_RM_R_80","MCW_RM_R_81","MCW_RM_R_82")
 
anno <- (cbind(samplenames, indv, drug, time, RIN, group))
anno <- as.data.frame(anno)


```

```{r gene id infromation, echo=TRUE, message=FALSE, warning=FALSE}
 
 ###now we add genenames to the geneid###
 
geneid <- rownames(mymatrix) ### pulls the names we have in the counts file
genes <- select(Homo.sapiens, keys=geneid, columns=c("SYMBOL"),
  keytype="ENTREZID")
genes <- genes[!duplicated(genes$ENTREZID),]
mymatrix$genes <- genes

```



```{r readinfo,echo=FALSE, message=FALSE, warning=FALSE}
cpm <- cpm(mymatrix)
lcpm <- cpm(mymatrix, log=TRUE)  ### for determining the basic cutoffs
dim(lcpm)
row_means <- rowMeans(lcpm)
x <- mymatrix[row_means > 0,]
dim(x)
write.csv(x$counts, "data/raw_counts.csv")
saveRDS(x,"data/filtermatrix_x.RDS")


filcpm_matrix <- subset(lcpm, (rowMeans(lcpm)>0))

hist(lcpm,  main = "Histogram of total counts (unfiltered)", 
     xlab =expression("Log"[10]*" counts-per-million"), col =4 )

hist(cpm(x$counts, log = TRUE), main = "Histogram of filtered counts using rowMeans > 0 method", 
     xlab =expression("Log"[10]*" counts-per-million"), col =2 ) 


boxplot(lcpm, main = "Boxplots of log cpm per sample",xaxt = "n", xlab= "")#, xlab=mymatrix$samples, srt =85,  adj=1, cex = 0.5)
x_axis_labels(labels = samplenames, every_nth = 1, adj=1, srt =90, cex =0.4)
boxplot(filcpm_matrix, main ="boxplots of log cpm per sample filtered",xaxt = "n", xlab="")
x_axis_labels(labels = samplenames, every_nth = 1, adj=1, srt =90, cex =0.4)

```








```{r individual PCA by drug and time steps, echo=FALSE, message=FALSE, warning=FALSE}
#readRDS("data/filtermatrix_x.RDS)
#saveRDS(dat_cpm,"data/dat_cpm.RDS")
#dat_cpm <- readRDS("data/dat_cpm.RDS")
label <- (interaction(substring(drug, 0, 2), indv, time))
smlabel <- (interaction(substring(drug, 0, 2), time))
x <- calcNormFactors(x, method = "TMM")
normalized_lib_size <- x$samples$lib.size * x$samples$norm.factors
dat_cpm <- cpm(x$counts, lib.size = normalized_lib_size)
colnames(dat_cpm) <- label
anno$time <- ordered(time, levels =c("3h", "24h"))
anno$group <- group
cpm_per_sample <- cbind(anno, t(dat_cpm)) 
treattype <-c("Vehicle","Daunorubicin","Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab")

for (b in treattype) { 
  dat <- dat_cpm[,anno$drug %in% c("none", b)] 
  cat("\n\n### ", b, "\n\n") 
  # PCA 
  pca <- calc_pca(t(dat))$x
  pca <- data.frame(anno[anno$drug %in% c("none", b), c("drug", "time","indv")], pca)
  pca <- droplevels(pca) 
  for (cat_var in c("drug", "time", "indv")) {
    assign(paste0(cat_var, "_pca"), arrangeGrob(pca_plot(pca, cat_var)))
  } 
  drug_time_pca <- pca_plot(pca, "drug", "time")
 
  grid.arrange(drug_time_pca, indv_pca, drug_pca, nrow =3, top =paste(b)) 
  }
write.csv(x$counts, "data/cpmnorm_counts.csv")




