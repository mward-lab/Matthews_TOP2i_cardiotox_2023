---
title: "GOI_plots"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = TRUE
)
```

```{r function,echo=TRUE}

cpm_boxplot <-function(cpmcounts, GOI,brewer_palette, fill_colors, ylab) {
    ##GOI needs to be ENTREZID
  df <- cpmcounts
  df_plot <- df %>% 
      dplyr::filter(rownames(.)== GOI) %>%
      pivot_longer(everything(),
                   names_to = "treatment",
                   values_to = "counts") %>%
      separate(treatment, c("drug","indv","time")) %>%
      mutate(time = factor(time, levels= c("3h","24h"), labels = c("3 hours","24 hours"))) %>% 
      mutate(indv=factor(indv, levels = c(1,2,3,4,5,6))) %>%
      mutate(drug =case_match(drug, "Da"~"DNR",
                            "Do"~"DOX",
                            "Ep"~"EPI",
                            "Mi"~"MTX",
                            "Tr"~"TRZ",
                            "Ve"~"VEH", .default = drug)) %>% 
      mutate(drug=factor(drug, levels = c('DOX','EPI','DNR','MTX','TRZ','VEH'))) 
  
    plot <- ggplot2::ggplot(df_plot, aes(x=drug, y=counts))+
      geom_boxplot(position="identity",aes(fill=drug))+
      geom_point(aes(col=indv, size=2, alpha=0.5))+
      guides(alpha= "none", size= "none")+
      scale_color_brewer(palette = brewer_palette, guide = "none")+
      scale_fill_manual(values=fill_colors)+
      facet_wrap(~time, nrow=1, ncol=2)+
      theme_bw()+
      ylab(ylab)+
      xlab("")+
      # ggtitle("24 hours")+
      theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "pt"),face = "bold"))
    print(plot)
}

pearson_extract <- function(corr_df,ENTREZID) {
  ld50_plot <- corr_df %>%
    dplyr::filter(entrezgene_id == ENTREZID) %>%
    ggplot(., aes(x=LD50, y=counts))+
    geom_point(aes(col=indv))+
    geom_smooth(method="lm")+
    facet_wrap(hgnc_symbol~Drug, scales="free")+
    theme_classic()+
    stat_cor(method="pearson",
             aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
             color = "red",
             label.x.npc = 0,
             label.y.npc=1,
             size = 3)

  tnni_plot <-  corr_df %>%
    dplyr::filter(entrezgene_id == ENTREZID) %>%
    ggplot(., aes(x=rtnni, y=counts))+
    geom_point(aes(col=indv))+
    geom_smooth(method="lm")+
    facet_wrap(hgnc_symbol~Drug, scales="free")+
    theme_classic()+
    stat_cor(method="pearson",
             aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
             color = "red",
             label.x.npc = 0,
             label.y.npc=1,
             size = 3)

  ldh_plot <-   corr_df %>%
    dplyr::filter(entrezgene_id == ENTREZID) %>%
    ggplot(., aes(x=rldh, y=counts))+
    geom_point(aes(col=indv))+
    geom_smooth(method="lm")+
    facet_wrap(hgnc_symbol~Drug, scales="free")+
    theme_classic()+
    stat_cor(method="pearson",
             aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
             color = "red",
             label.x.npc = 0,
             label.y.npc=1,
             size = 3)

  ##ggbuild to get model:
  ld50_build <- ggplot_build(ld50_plot)
  ld50_data <- data.frame('rho_LD50'= c(ld50_build$data[[3]]$r,NA,NA),
                          'sig_LD50'=c(ld50_build$data[[3]]$p.value,NA,NA),
                          'rowname'=c("DOX","EPI","DNR","MTX", "TRZ", "VEH"))

  tnni_build <- ggplot_build(tnni_plot)
  tnni_data <- data.frame('rho_tnni'= c(tnni_build$data[[3]]$r),
                          'sig_tnni'=c(tnni_build$data[[3]]$p.value),
                          'rowname'=c("DOX","EPI","DNR","MTX", "TRZ", "VEH"))
  ldh_build <- ggplot_build(ldh_plot)
  ldh_data <- data.frame('rho_ldh'= c(ldh_build$data[[3]]$r),
                         'sig_ldh'=c(ldh_build$data[[3]]$p.value),
                         'rowname'=c("DOX","EPI","DNR","MTX", "TRZ", "VEH"))

  results <- cbind(ldh_data,tnni_data[,1:2],ld50_data[,1:2])

  return(results)

}
```

```{r library loading, echo=TRUE, message=FALSE, warning=FALSE}
library(ComplexHeatmap)
library(tidyverse)
library(ggsignif)
library(RColorBrewer)
library(scales)
library(sjmisc)
library(kableExtra)
library(broom)
library(ggstats)
library(Hmisc)
library(ggpubr)
```


```{r data loading,echo=FALSE, message=FALSE, warning=FALSE}

siglist <- readRDS("data/siglist_final.RDS")
list2env(siglist,envir=.GlobalEnv)
DEG_cormotif <- readRDS("data/DEG_cormotif.RDS")
list2env(DEG_cormotif,envir=.GlobalEnv)
cpmcounts <- readRDS("data/cpmcount.RDS")
level_order2 <- c('75','87','77','79','78','71')
drug_pal_fact <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")
drug_pal_vehend <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")

toplistall <- readRDS("data/toplistall.RDS") 
# 
GOIcorr <-(genes = c("RARG", "ZNF740", "KAZN", "SLC28A3", "FRS2" ,"HDDC2","RMI1","KDM4B","KAT6B","TNS2", "EEF1B2"))
# library(biomaRt)
# ensembl <- useMart("ensembl", dataset="hsapiens_gene_ensembl")
# my_chr <- c(1:22, 'M', 'X', 'Y')  ## creates a filter for each
# #
# my_attributes <- c('entrezgene_id', 'ensembl_gene_id', 'hgnc_symbol')
# GOI_genelist<- getBM(attributes=my_attributes,filters ='hgnc_symbol',
#          values = GOIcorr, mart = ensembl)
# GOI_genelist <- GOI_genelist %>% distinct(entrezgene_id, .keep_all = TRUE)
# write.csv(GOI_genelist,"output/GOI_genelist.txt")
GOI_genelist <- read.csv("output/GOI_genelist.txt",row.names = 1)

RNAnormlist <- read.csv("output/TNNI_LDH_RNAnormlist.txt", row.names = 1)
# GOI_genelist <- GOI_genelist %>%
# add_row(.,entrezgene_id =23371,ensembl_gene_id ="ENSG00000111077", hgnc_symbol= "TNS2")

```
# Genes of Interest log2 cpm

### TOP2B

```{r GOI-top2b, echo=FALSE, message=FALSE, warning=FALSE, fig.height=3, fig.width =6}
cpm_boxplot(cpmcounts,GOI='7155',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("Top2"*beta)~log[2]~"cpm "))))
```

### Top2a

```{r GOI-top2a, echo=FALSE,fig.height=3, fig.width =6}

cpm_boxplot(cpmcounts,GOI='7153',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("Top2"*alpha)~log[2]~"cpm "))))

```


### CDKN1a

```{r GOI CDKN1a, echo=FALSE,fig.height=3, fig.width =6}


 cpm_boxplot(cpmcounts,GOI='1026',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("CDKN1"*alpha)~log[2]~"cpm "))))
   
```

### ATM

```{r GOI-atm, echo=FALSE,fig.height=3, fig.width =6}

cpm_boxplot(cpmcounts,GOI='472',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("ATM")~log[2]~"cpm "))))
```
### ATR
```{r GOI-atr, echo=FALSE,fig.height=3, fig.width =6}

cpm_boxplot(cpmcounts,GOI='545',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("ATR")~log[2]~"cpm "))))
```

### RARG
```{r GOI RARG, echo=FALSE, fig.height=3, fig.width =6}

cpm_boxplot(cpmcounts,GOI='5916',"Dark2",drug_pal_fact,
            ylab=(expression(atop(" ",italic("RARG")~log[2]~"cpm "))))

```

### KAT6b

```{r KAT6b logcpm,fig.height=3, fig.width =6}
cpm_boxplot(cpmcounts,GOI='23522',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("KAT6B")~log[2]~"cpm "))))
```

### KDM4b

```{r KDM4b logcpm,fig.height=3, fig.width =6}
cpm_boxplot(cpmcounts,GOI='23030',"Dark2",drug_pal_vehend,
  ylab=(expression(atop(" ",italic("KDM4B")~log[2]~"cpm "))))

```
## expression correlation:

first, will do expression the following GOIs:

`r print(GOI_genelist$hgnc_symbol)`



```{r expression correlation, echo=FALSE}

GOIsig <- toplistall %>%
  filter(ENTREZID %in% GOI_genelist$entrezgene_id) %>%
  filter(adj.P.Val < 0.05) %>% 
  dplyr::select(time,id,ENTREZID,SYMBOL,adj.P.Val) 
GOIsig%>% 
  kable(., caption= "Significant (adj. P value of <0.05) Genes of interest by treatment") %>% 
  kable_paper("striped", full_width = FALSE) %>%  
  kable_styling(full_width = FALSE, position = "left",bootstrap_options = c("striped"),font_size = 18) %>% 
  scroll_box(width = "60%", height = "400px")
# write.csv(GOIsig,"data/GOIsig.csv")
# saveRDS(avg_LD50,"data/avg_LD50.RDS")
avg_LD50 <- readRDS("data/avg_LD50.RDS")
# print(GOI_genelist)

GOI_join <- RNAnormlist %>%
  mutate(indv=factor(indv,levels = level_order2)) %>%
  mutate(indv=as.numeric(indv)) %>%
  mutate(indv=factor(indv)) %>%
  mutate(Drug = factor(Drug, levels = c(
                                       "DOX",
                                       "EPI",
                                       "DNR",
                                       "MTX",
                                       "TRZ",
                                       "VEH"))) %>%
  dplyr::select(indv, Drug,rldh,rtnni) %>%
  mutate(tox = rowMeans(across(rldh:rtnni))) %>% 
  full_join(.,avg_LD50,by=c("Drug"="sDrug","indv"="indv")) %>%
  rename("LD50"="name") 

# 
# #make a list of GOIs then individual info:
# 
# gene_corr_df <- cpmcounts %>%
#   rownames_to_column(var ="entrezgene_id") %>%
#   filter(entrezgene_id %in% GOI_genelist$entrezgene_id) %>% ##this works to only fileter
# # #   # inner_join(., GOI_genelist,by ="entrezgene_id") %>%  view()## this works to filter and append. just depends on the"when" I want to filter and join dataframes
#   mutate(entrezgene_id=as.numeric(entrezgene_id)) %>%
#   pivot_longer(!entrezgene_id, names_to="treatment", values_to = "counts") %>%
#   separate(treatment,c("Drug","indv","time")) %>%
#   filter(time =="24h") %>%
#   mutate(indv=factor(indv, levels = c(1,2,3,4,5,6))) %>%
#   mutate(Drug =case_match(Drug, "Da"~"DNR",
#                           "Do"~"DOX",
#                           "Ep"~"EPI",
#                           "Mi"~"MTX",
#                           "Tr"~"TRZ",
#                           "Ve"~"VEH", .default = Drug))

```

#### 24 hour TNNI to cpm


```{r correlation of TNNI}
# # now I have the long dataframe, time to combine with other data snf limit to just the GOIs
# gene_corr_frame <- gene_corr_df %>%
#     filter(entrezgene_id %in% GOI_genelist$entrezgene_id) %>%
#     left_join(., GOI_join, by=c("Drug","indv")) %>%
#     dplyr::select(indv, Drug,entrezgene_id,counts, rldh,rtnni,LD50,tox) %>%
#     mutate(Drug=factor(Drug)) %>%
#     full_join(.,GOI_genelist, by="entrezgene_id")
#
#   saveRDS(gene_corr_df,"data/gene_corr_df.RDS")
# saveRDS(gene_corr_frame,"data/gene_corr_frame.RDS")
gene_corr_frame <- readRDS("data/gene_corr_frame.RDS")
   gene_corr_df <- readRDS("data/gene_corr_df.RDS")
   
## remove nas!

   
for (gene in GOI_genelist$entrezgene_id){
    gene_plot <- gene_corr_frame %>% 
      dplyr::filter(entrezgene_id == gene) %>%
      ggplot(., aes(x=rtnni, y=counts))+
      geom_point(aes(col=indv))+
      geom_smooth(method="lm")+
      facet_wrap(hgnc_symbol~Drug, scales="free")+
      theme_classic()+
      xlab("troponin I expression") +
      ylab("Gene counts in log2 cpm") +
      ggtitle(expression(paste("Correlation between counts and troponin I by drug")))+
      scale_color_brewer(palette = "Dark2",name = "Individual", label = c("1","2","3","4","5","6"))+
     ggpubr:: stat_cor(method="pearson",
                       cor.coef.name="rho",
               aes(label = paste(..r.label.., ..p.label.., sep = "~`,\n`~")),
               color = "red",
               label.x.npc = 0.01,
               label.y.npc=0.01, 
               size = 3)+
      theme(plot.title = element_text(size = rel(1.5), hjust = 0.5,face = "bold"),
            axis.title = element_text(size = 15, color = "black"),
            axis.ticks = element_line(size = 1.5),
            axis.text = element_text(size = 8, color = "black", angle = 20),
            strip.text.x = element_text(size = 12, color = "black", face = "italic"))
   print(gene_plot)
   
  }
```

#### 24 hour LDH to cpm

```{r LDH 24 hour}

## ggplot by drug for ldh
 
  
  for (gene in GOI_genelist$entrezgene_id){
    gene_plot <- gene_corr_frame %>% 
      dplyr::filter(entrezgene_id == gene) %>%
      ggplot(., aes(x=rldh, y=counts))+
      geom_point(aes(col=indv))+
      geom_smooth(method="lm")+
      facet_wrap(hgnc_symbol~Drug, scales="free")+
      theme_classic()+
      xlab("troponin I expression") +
      ylab("Gene counts in log2 cpm") +
      ggtitle(expression(paste("Correlation between counts and LDH by drug")))+
      scale_color_brewer(palette = "Dark2",name = "Individual", label = c("1","2","3","4","5","6"))+
      stat_cor(method="pearson",
               cor.coef.name="rho",
               aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
               color = "red",
               label.x.npc = 0.01,
               label.y.npc=0.01, 
               size = 3)+
      theme(plot.title = element_text(size = rel(1.5), hjust = 0.5,face = "bold"),
            axis.title = element_text(size = 15, color = "black"),
            axis.ticks = element_line(size = 1.5),
            axis.text = element_text(size = 8, color = "black", angle = 20),
            strip.text.x = element_text(size = 12, color = "black", face = "italic"))
   print(gene_plot)
   
  }
```  

#### Toxicity for GOI

```{r toxicity corr}
 for (gene in GOI_genelist$entrezgene_id){
    gene_plot <- gene_corr_frame %>% 
      dplyr::filter(entrezgene_id == gene) %>%
      ggplot(., aes(x=tox, y=counts))+
      geom_point(aes(col=indv))+
      geom_smooth(method="lm")+
      facet_wrap(hgnc_symbol~Drug, scales="free")+
      theme_classic()+
      xlab("Toxicity score") +
      ylab("Gene counts in log2 cpm") +
      ggtitle(expression(paste("Correlation between counts and toxicity by drug")))+
      scale_color_brewer(palette = "Dark2",name = "Individual", label = c("1","2","3","4","5","6"))+
      stat_cor(method="pearson",
               cor.coef.name="rho",
               aes(label = paste(..r.label.., ..p.label.., sep = "~`,`~")),
               color = "red",
               label.x.npc = 0.01,
               label.y.npc=0.01, 
               size = 3)+
      theme(plot.title = element_text(size = rel(1.5), hjust = 0.5,face = "bold"),
            axis.title = element_text(size = 15, color = "black"),
            axis.ticks = element_line(size = 1.5),
            axis.text = element_text(size = 8, color = "black", angle = 20),
            strip.text.x = element_text(size = 12, color = "black", face = "italic"))
   print(gene_plot)
   
 }

```



#### Fig9 expression correlation


```{r fig9}
##add in list of ldh,tnni and ld50
avg_LD50 <- readRDS("data/avg_LD50.RDS")

gene_corr_frame <- readRDS("data/gene_corr_frame.RDS")
   gene_corr_df <- readRDS("data/gene_corr_df.RDS")



GOI_join <- RNAnormlist %>% 
  mutate(indv=factor(indv,levels = level_order2)) %>% 
  mutate(indv=as.numeric(indv)) %>%
  mutate(indv=factor(indv)) %>% 
  mutate(Drug = factor(Drug, levels = c("DNR", 
                                       "DOX",
                                       "EPI",
                                       "MTX",
                                       "TRZ",
                                       "VEH"))) %>% 
  dplyr::select(indv, Drug,rldh,rtnni) %>% 
  full_join(.,avg_LD50,by=c("Drug"="sDrug","indv"="indv")) %>% 
  rename("LD50"="name")
##now we have the frame, time to limit df of GOI_genelist to fig 9 genes
Fig9_genes <- GOI_genelist %>% 
  filter(hgnc_symbol %in% list("RARG", "ZNF740", "TNS2", "SLC28A3","RMI1"))
##joining to counts

gene_corr_fig9 <- gene_corr_df %>%
    filter(entrezgene_id %in% Fig9_genes$entrezgene_id) %>%
    left_join(., GOI_join, by=c("Drug","indv")) %>%
    mutate(Drug=factor(Drug, levels = c("DOX","EPI","DNR", "MTX", "TRZ", "VEH"))) %>%
    full_join(.,GOI_genelist, by="entrezgene_id")
  
  # saveRDS(gene_corr_fig9,"output/gene_corr_fig9.RDS")


```





## GOI from variance
### DOX examples
```{r GOIvar}
Vargenes <- readRDS("data/geneset_24.RDS")
expressedgenes <- read.csv("data/backGL.txt")
top_genes <- sapply(Vargenes,head,4)
top_genes_df<-  top_genes %>% as.data.frame() %>% 
pivot_longer(everything(),names_to="combo",values_to = "ENTREZID") %>% 
  separate(combo, into = c("drug",NA,NA)) %>% 
  mutate(ENTREZID=as.numeric(ENTREZID)) %>% 
  inner_join(., expressedgenes, by="ENTREZID") %>% as.data.frame()


for (g in seq(1:4)){
  datafilter <- top_genes_df %>% filter(drug=="DOX")
  a <- datafilter[g,3]
  # b <- datafilter[g,1]
  cpm_boxplot(cpmcounts,GOI=datafilter[g,2],
              "Dark2",
              drug_pal_fact,
              ylab=bquote(~italic(.(a))~log[2]~"cpm "))
  
}


```

### EPI examples

```{r EPI example}
for (g in seq(1:4)){
  datafilter <- top_genes_df %>% filter(drug =="EPI")
  a <- datafilter[g,3]
  # b <- datafilter[g,1]
  cpm_boxplot(cpmcounts,GOI=datafilter[g,2],
              "Dark2",
              drug_pal_fact,
              ylab=bquote(~italic(.(a))~log[2]~"cpm "))
  
}
```
### qvalue EPI
```{r EPI qvalues example}
cpm_boxplot_time <-function(cpmcounts,timex, GOI,brewer_palette, fill_colors, ylab) {
  ##GOI needs to be ENTREZID
  df <- cpmcounts
    df_plot <- df %>% 
      dplyr::filter(rownames(.)==GOI) %>%
      pivot_longer(everything(),
                   names_to = "treatment",
                   values_to = "counts") %>%
      separate(treatment, c("drug","indv","time")) %>%
      dplyr::filter(time == paste(timex)) %>% 
      mutate(time=factor(time, levels =c("3h", "24h"), labels=c("3 hours", "24 hours"))) %>%
      
      mutate(indv=factor(indv, levels = c(1,2,3,4,5,6))) %>%
      mutate(drug =case_match(drug, "Da"~"DNR",
                            "Do"~"DOX",
                            "Ep"~"EPI",
                            "Mi"~"MTX",
                            "Tr"~"TRZ",
                            "Ve"~"VEH", .default = drug)) %>% 
      mutate(drug=factor(drug, levels = c('DOX','EPI','DNR','MTX','TRZ','VEH')))
    plot <- ggplot2::ggplot(df_plot, aes(x=drug, y=counts))+
      geom_boxplot(position="identity",aes(fill=drug))+
      geom_point(aes(col=indv, size=1.5, alpha=0.5))+
      guides(alpha= "none", size= "none")+
      scale_color_brewer(palette = brewer_palette, guide = "none")+
      scale_fill_manual(values=fill_colors)+
      # try(facet_wrap("time", nrow=1, ncol=2))+
      theme_bw()+
      ylab(ylab)+
      xlab("")+
      theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=10,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          axis.line = element_line(linewidth = 1.0),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "pt"),face = "bold"))
    print(plot)
}

storeEPI <- readRDS("data/qvalueEPItemp.RDS")
EPIgoi <- getBM(attributes=my_attributes,filters ='entrezgene_id',
         values = storeEPI$ENTREZID, mart = ensembl)


set.seed(12345)

sampset <- EPIgoi %>% 
   sample_n(.,4)
for (g in seq(from=1, to=length(sampset$entrezgene_id))){
  a <- sampset$hgnc_symbol[g]
  cpm_boxplot_time(cpmcounts,'24h',GOI=sampset[g,1],"Dark2",drug_pal_fact,
                ylab=bquote(~italic(.(a))~log[2]~"cpm "))

}






```


### MTX examples
```{r MTX example}
for (g in seq(1:4)){
  datafilter <- top_genes_df %>% filter(drug =="MTX")
  a <- datafilter[g,3]
  # b <- datafilter[g,1]
  cpm_boxplot(cpmcounts,GOI=datafilter[g,2],
              "Dark2",
              drug_pal_fact,
              ylab=bquote(~italic(.(a))~log[2]~"cpm "))
  
}
```


### TRZ examples

```{r TRZ example}
for (g in seq(1:4)){
  datafilter <- top_genes_df %>% filter(drug =="TRZ")
  a <- datafilter[g,3]
  # b <- datafilter[g,1]
  cpm_boxplot(cpmcounts,GOI=datafilter[g,2],
              "Dark2",
              drug_pal_fact,
              ylab=bquote(~italic(.(a))~log[2]~"cpm "))
  
}
```
