---
title: "Figure 3"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r packages loading}
library(car)
library(tidyverse)
library(tinytex)
library(BiocGenerics)
library(data.table)
library(drc)
library(cowplot)
library(ggsignif)
library(RColorBrewer)
library(broom)
```
```{r loading dataframes}
clamp_summary <- read.csv("data/Clamp_Summary.csv", row.names=1)

calcium_data <- read_csv("data/DF_Plate_Peak.csv", col_types = cols(...1 = col_skip()))

drug_palexpand <- c("#41B333","#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","purple3","darkgreen", "darkblue")

drug_palc <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")
level_order2 <- c('75','87','77','79','78','71')
label_list <- readRDS("data/label_list.RDS")
list2env(label_list,envir =.GlobalEnv)

label <- (interaction(substring(drug, 0, 2), indv, time))
x <- readRDS("data/filtermatrix_x.RDS")

x <- calcNormFactors(x, method = "TMM")
normalized_lib_size <- x$samples$lib.size * x$samples$norm.factors
dat_cpm <- cpm(x$counts, lib.size = normalized_lib_size, log=TRUE)

colnames(dat_cpm) <- label

calcium_data <- calcium_data %>% 
  rename('Treatment'='Condition','indv'='Experiment') %>%
  mutate(Drug = case_match(Treatment, 
                           "Dau_0.5"~"Daunorubicin",
                           "Dau_1" ~"Daunorubicin",
                          "Dox_0.5"~"Doxorubicin",
                          "Dox_1" ~"Doxorubicin",
                          "Epi_0.5"~"Epirubicin",
                          "Epi_1" ~"Epirubicin", 
                          "Mito_0.5"~"Mitoxantrone",
                          "Mito_1"~"Mitoxantrone",
                          "Tras_0.5"~"Trastuzumab",
                          "Tras_1"~"Trastuzumab",
                          "Control" ~"Vehicle", 
                          .default = Treatment)) %>%
  mutate(Drug=factor(Drug, 
                     levels = c("Daunorubicin",      "Doxorubicin","Epirubicin","Mitoxantrone","Trastuzumab","Vehicle"))) %>%
  mutate(Conc =case_match(Treatment, "Dau_0.5"~"0.5",
                          "Dau_1" ~"1.0",
                          "Dox_0.5"~"0.5",
                          "Dox_1" ~"1.0",
                          "Epi_0.5"~"0.5",
                          "Epi_1" ~"1.0",
                          "Mito_0.5"~"0.5",
                          "Mito_1"~"1.0",
                          "Tras_0.5"~"0.5",
                          "Tras_1"~"1.0",
                          'Control'~'0',
                          .default = Treatment))

clamp_summary <- clamp_summary%>%
  rename('Treatment'='Cond','indv'='Exp') %>%
  mutate(Drug =case_match(Treatment, 
                          "Dau_0.5"~"Daunorubicin",
                          "Dau_1" ~"Daunorubicin",
                          "Dox_0.5"~"Doxorubicin",
                          "Dox_1" ~"Doxorubicin",
                          "Epi_0.5"~"Epirubicin",
                          "Epi_1" ~"Epirubicin",
                          "Mito_0.5"~"Mitoxantrone",
                          "Mito_1"~"Mitoxantrone",
                          "Tras_0.5"~"Trastuzumab",
                          "Tras_1"~"Trastuzumab",
                          "Control" ~"Vehicle" ,
                          .default = Treatment)) %>%
  mutate(Drug=factor(Drug, levels = c( "Daunorubicin",
                                      "Doxorubicin",
                                      "Epirubicin",
                                      "Mitoxantrone",
                                      "Trastuzumab","Vehicle"))) %>%
  mutate(Conc =case_match(Treatment, 
                          "Dau_0.5"~"0.5",
                          "Dau_1" ~"1.0",
                          "Dox_0.5"~"0.5",
                          "Dox_1" ~"1.0",
                          "Epi_0.5"~"0.5",
                          "Epi_1" ~"1.0",
                          "Mito_0.5"~"0.5",
                          "Mito_1"~"1.0",
                          "Tras_0.5"~"0.5",
                          "Tras_1"~"1.0",
                          'Control'~'0',
                          .default = Treatment)) %>%
  rename(c('Mean_Amplitude'='R1S1_Mean..a.u..',
           'Rise_Slope'='R1S1_Rise_Slope..a.u..ms.',
           'FWHM'='R1S1_Half_Width..ms.',
           'Decay_Slope'='R1S1_Decay_Slope..a.u..ms.',
           'Decay_Time'='Decay_Time..ms.',
           'Rise_Time'='R1S1_Rise_Time')) %>%
  mutate(indv=substr(indv,1,2)) %>%
  mutate(indv=factor(indv, levels = level_order2)) %>%
  filter(Conc==0| Conc==0.5) 

```




# Figure 3

Calcium dysregulation occurs at sub-lethal concentrations of TOP2i

## A. Representative line graph
```{r}


```


## B. Mean amplitude
```{r Man_amp}

clamp_summary %>% 
  dplyr::select(Drug,Conc,indv,Mean_Amplitude,FWHM,Rise_Slope,Decay_Slope) %>%
  ggplot(.,aes(Drug,Mean_Amplitude))+
  geom_boxplot(position = "identity", fill= drug_pal_fact)+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none",size="none")+
  scale_color_brewer(palette = "Dark2", name = "Individual",label=c("2","3","5"))+
  geom_signif(comparisons = list(c("Vehicle","Trastuzumab"),
                                 c("Vehicle","Mitoxantrone"),
                                 c("Vehicle","Epirubicin"),
                                 c( "Vehicle","Doxorubicin"),
                                 c( "Vehicle","Daunorubicin")),
              test = "t.test",
              map_signif_level = TRUE,
              step_increase = 0.1,
              textsize = 4)+
  labs(y = "a.u.")+
  ggtitle("Mean amplitude")+
  theme_classic()+
  theme(plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))


```


## C. Rising slope
```{r rising slope}

clamp_summary %>%
  dplyr::select(Drug,Conc,indv,Mean_Amplitude,FWHM,Rise_Slope,Decay_Slope) %>%
  ggplot(.,aes(Drug,Rise_Slope))+
  geom_boxplot(position = "identity", fill= drug_pal_fact)+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha="none", indv = "none", size = "none")+
   scale_color_brewer(palette = "Dark2", name = "Individual",label=c("2","3","5"))+
 geom_signif(comparisons = list(c("Vehicle","Trastuzumab"),
                                 c("Vehicle","Mitoxantrone"),
                                 c("Vehicle","Epirubicin"),
                                 c( "Vehicle","Doxorubicin"),
                                 c( "Vehicle","Daunorubicin")),
              test = "t.test",
              map_signif_level = TRUE,
              step_increase = 0.1,
              textsize = 4)+
  ggtitle(expression(paste("Rising slope")))+
  labs(y = "a.u./sec")+
  theme_classic()+
  theme(plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))




```

## D. Decay slope

```{r Decay slope}
clamp_summary %>%
  dplyr::select(Drug,Conc,indv,Mean_Amplitude,FWHM,Rise_Slope,Decay_Slope) %>%
  ggplot(.,aes(Drug,Decay_Slope))+
  geom_boxplot(position = "identity", fill= drug_pal_fact)+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha="none", indv = "none", size = "none")+
   scale_color_brewer(palette = "Dark2", name = "Individual",label=c("2","3","5"))+
  geom_signif(comparisons = list(c("Vehicle","Trastuzumab"),
                                 c("Vehicle","Mitoxantrone"),
                                 c("Vehicle","Epirubicin"),
                                 c( "Vehicle","Doxorubicin"),
                                 c( "Vehicle","Daunorubicin")),
              test = "t.test",
              map_signif_level = TRUE,
              step_increase = 0.1,
              textsize = 4)+
  ggtitle(expression(paste("Decay slope ")))+
  labs(y = "a.u.")+
  theme_classic()+
  theme(plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))

```



## E. Full-width at half-max
```{r FWHM}

clamp_summary %>%
  dplyr::select(Drug,Conc,indv,Mean_Amplitude,FWHM,Rise_Slope,Decay_Slope) %>%
  ggplot(.,aes(Drug,FWHM))+
  geom_boxplot(position = "identity", fill= drug_pal_fact)+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none",size="none")+
  scale_color_brewer(palette = "Dark2", name = "Individual",label=c("2","3","5"))+
  geom_signif(comparisons = list(c("Vehicle","Trastuzumab"),
                                 c("Vehicle","Mitoxantrone"),
                                 c("Vehicle","Epirubicin"),
                                 c( "Vehicle","Doxorubicin"),
                                 c( "Vehicle","Daunorubicin")),
              test = "t.test",
              map_signif_level = TRUE,
              step_increase = 0.1,
              textsize = 4)+
  ggtitle(expression(paste("Full-width at half-max")))+
  theme_bw()+
  guides(size = "none")+
  labs(y = "a.u.")+
  theme_classic()+
  theme(plot.title = element_text(size=18,hjust = 0.5),
        axis.title = element_text(size = 15, color = "black"),
        axis.ticks = element_line(linewidth = 1.5),
        axis.line = element_line(linewidth = 1.5),
        axis.text = element_text(size = 12, color = "black", angle = 0),
        strip.text.x = element_text(size = 15, color = "black", face = "bold"))


```



## F. Contraction rate
```{r  Contract_rate}

calcium_data %>% 
  dplyr::select(Drug,Conc,indv,Rate) %>%#Peak_variance,Ave_FF0,
  mutate(indv=substr(indv,1,2)) %>%
  mutate(indv=factor(indv, levels = level_order2)) %>%
  mutate(contrl= 0.383) %>%
  mutate(norm_rate=Rate/contrl) %>%
  filter(Conc==0| Conc==0.5) %>%
  ggplot(., aes(x=Drug, y=Rate))+
  geom_boxplot(position = "identity", fill= drug_pal_fact)+
  geom_point(aes(col=indv, size=2, alpha=0.5))+
  guides(alpha= "none")+
 geom_signif(comparisons = list(c("Vehicle","Trastuzumab"),
                                 c("Vehicle","Mitoxantrone"),
                                 c("Vehicle","Epirubicin"),
                                 c( "Vehicle","Doxorubicin"),
                                 c( "Vehicle","Daunorubicin")),
              test = "t.test",
              map_signif_level = TRUE,
              step_increase = 0.1,
              textsize = 4)+
  guides(alpha= "none",size="none")+
  scale_color_brewer(palette = "Dark2", name = "Individual",label=c("2","3","5"))+
  ggtitle("Contraction rate")+
  theme_classic()+
  guides(size = "none",colour = guide_legend(override.aes = list(size=4, alpha= 0.5)))+
  labs(y = "avg. beats/sec")+
  theme(plot.title = element_text(size=18,hjust = 0.5),
    axis.title = element_text(size = 14, color = "black"),
    axis.ticks = element_line(linewidth = 1.5),
    axis.line = element_line(linewidth = 1.5),
    axis.text = element_text(size = 10, color = "black", angle = 0),
    strip.text.x = element_text(size = 12, color = "black", face = "bold"))


```


## G. PCA of `r paste("PCA of CA"^2+~" data")`

```{r PCA_G}
calc_pca <- function(x) {
  # Performs principal components analysis with prcomp
  # x: a sample-by-gene numeric matrix
  prcomp(x, scale. = TRUE, retx = TRUE)
}
time <- rep((rep(c("3h", "24h"), c(6,6))), 6) 

time <- ordered(time, levels =c("3h", "24h"))

anno <- readRDS("data/annotation_data_frame.RDS")
cpm_per_sample <- cbind(anno, t(dat_cpm)) 
pca_all <- calc_pca(t(dat_cpm))
pca_all_anno <- data.frame(anno, pca_all$x)


pca_all_anno %>%
  ggplot(.,aes(x = PC1, y = PC2, col=drug, shape=time))+
  geom_point(size= 5)+
  scale_color_manual(values=drug_palc)+
   ggrepel::geom_text_repel(label=indv)+
   ggtitle(expression("PCA of log"[2]*"(cpm)"))+
  theme_bw()+
  guides( size =4)+
  labs(y = "PC 2 (15.76%)", x ="PC 1 (29.06%)")+
  theme(plot.title=element_text(size= 14,hjust = 0.5),
        axis.title = element_text(size = 12, color = "black"))



```
