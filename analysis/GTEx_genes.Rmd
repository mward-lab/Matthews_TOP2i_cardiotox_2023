---
title: "GTEx_genes"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# GTEx egenes and analysis

```{r packages}
library(ComplexHeatmap)
library(tidyverse)
library(ggsignif)
library(biomaRt)
library(RColorBrewer)
library(cowplot)
library(scales)
library(sjmisc)
library(kableExtra)
library(broom)
library(ggstats)

```

## Data import

```{r data import}
toplistall<- read.csv("output/toplistall.csv", row.names = 1)
my_exp_genes <- read.csv("data/backGL.txt")
egenes_set <- read.csv("output/egenes_set.csv",row.names = 1)
egenes_hgnc <- read.csv("output/egenes_hgnc.csv",row.names = 1)
GTEx_genes <- read.csv("data/GTEx_gene_list.csv",row.names = 1)
not_eqtls <- read.csv("output/not_eqtls_GTEX.csv",row.names = 1)
heart_gtex <- read.csv("output/heart_gtex.csv",row.names = 1)
egenes <- read.csv("output/egenes.csv",row.names = 1)

```

```{r biomart holder, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

ensembl <- useMart("ensembl", dataset="hsapiens_gene_ensembl")
us_mart <- useEnsembl(biomart = "ensembl", mirror = "uswest")
my_chr <- c(1:22, 'M', 'X', 'Y')  

my_attributes <- c('entrezgene_id', 'ensembl_gene_id', 'hgnc_symbol') 
write.csv(heart_gtex,"output/heart_gtex.csv")
write.csv(egenes_set,"output/egenes_set.csv")
write.csv(egenes_hgnc,"output/egenes_hgnc.csv")
write.csv(GTEx_genes,"data/GTEx_gene_list.csv")
write.csv(not_eqtls,"output/not_eqtls_GTEX.csv")
write.csv(egenes,"output/egenes.csv")

```

### Obtaining the GTEx data set

I downloaded the GTEx_Analysis_v8.metasoft.txt.gz files from the Consortium at <https://www.gtexportal.org/home/datasets> .

I the extracted the Heart_Left_Ventricle.v8.egenes.txt file and uploaded into R under the data folder.

```{r GTExdata, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE}
heart_gtex <-
  readr::read_delim("data/Heart_Left_Ventricle.v8.egenes.txt",
                    delim = "\t",
                    escape_double = FALSE,
                    trim_ws = TRUE)
egenes <- heart_gtex %>% 
  dplyr::select(gene_id, gene_name, qval) %>% 
  filter(qval<0.05) %>% 
  separate(gene_id, into =c('ensembl_gene_id', 'gene_version'))

not_eqtl <- heart_gtex %>% 
  dplyr::select(gene_id, gene_name, qval) %>% 
  filter(qval>0.05) %>% 
  separate(gene_id, into =c('ensembl_gene_id', 'gene_version'))

egenes_set <- getBM(attributes=my_attributes, 
                    filters ='ensembl_gene_id',
                    values =egenes$ensembl_gene_id,
                    mart = ensembl)
egenes_hgnc <- getBM(attributes=my_attributes,
                     filters ='hgnc_symbol',
                     values =egenes$gene_name, 
                     mart = ensembl)
not_eqtl_set <- getBM(attributes=my_attributes, 
                    filters ='ensembl_gene_id',
                    values =not_eqtl$ensembl_gene_id,
                    mart = ensembl)

not_eqtls <- not_eqtl_set %>% 
  distinct(entrezgene_id,.keep_all = TRUE) %>% 
  filter(entrezgene_id %in% my_exp_genes$ENTREZID)
##6711 not_eqtls  ##wrong set
GTEx_genes <- egenes_set %>% 
  distinct(entrezgene_id,.keep_all = TRUE)

```

This file contains several columns  `r  colnames(heart_gtex)`.

I then chose the the 'gene_id','gene_name', and 'qval' columns. This left me with 21353 genes. Next I filtered the tissue specific expressed genes using a the 'qval < 0.05' for a total of `r length(egenes$gene_name)`. I then took the gene_name column and used biomart to convert to 'entrezgene_id'.  
Because results vary by which way I look up genes in BioMart, I tested both egenes using ensemble_gene_id  and hgnc_symbol columns.
I found `r length(unique(egenes_set$entrezgene_id))` for the ensemble_gene_ 
set and `r length(unique(egenes_hgnc$entrezgene_id))` for the hgnc_symbol set.    
I went with using ensemble_gene_id because I found ~600 more genes overall than using the hgnc_symbol filter.



```{r comparing with my data}
GTEx <- intersect(GTEx_genes$entrezgene_id,my_exp_genes$ENTREZID)


nQTLmy <- my_exp_genes %>%
   dplyr:: filter(!ENTREZID %in%GTEx)

# testset <- toplistall %>% 
#   filter(adj.P.Val<0.05) %>% 
#  select(ENTREZID) %>% distinct(ENTREZID) %>% 
#   dplyr:: filter(ENTREZID %in%GTEx_genes$entrezgene_id)



```


To find out how many genes from the gtex egenes were expressed in my data, I intersected my expressed genes list of `r length(my_exp_genes$ENTREZID)` genes with the GTEx_genes and found `r length(GTEx)` genes were shared between them. 
I called this set 'GTEx'. Using the other eGenes from GTEx, I made another set intersected with my expressed gene set called 'nQTL'.  This nQTL set contains `r length(nQTLmy$ENTREZID)` genes. Next, I then took my DEG top list and filtered out genes with an adj.P.value < 0.05.  


```{r GTEx proportion overall}
drug_palspc <- c("#8B006D","#DF707E","#8B006D","#DF707E")

```

The next step is to wrangle the data so that I can test the difference between the proportions of  significantly DE genes found in the GTEx and nQTLs.

```{r still going}
nQTLsum <- toplistall %>%
  mutate(id = as.factor(id)) %>%
  mutate(time=factor(time, levels=c("3_hours","24_hours"))) %>%
  dplyr::filter(adj.P.Val <0.05) %>%
  mutate(nQTL=if_else(ENTREZID %in% nQTLmy$ENTREZID,'nQTL_y','nQTL_no')) %>% 
  group_by(id,time,nQTL) %>% 
  tally() %>% 
  separate(nQTL, into=c('set', 'group')) %>% 
  mutate(total=length(nQTLmy$ENTREZID) - n) %>% 
  dplyr::filter(group=="y")

GTExsum <- toplistall %>%
  mutate(id = as.factor(id)) %>%
  mutate(time=factor(time, levels=c("3_hours","24_hours"))) %>%
  dplyr::filter(adj.P.Val <0.05) %>%
   mutate(GTEx=if_else(ENTREZID %in%GTEx,"GTEx_y","GTEx_no")) %>% 
  group_by(id,time,GTEx) %>% 
  tally() %>% 
  separate(GTEx, into=c('set', 'group')) %>% 
  mutate(total=length(GTEx) - n) %>% 
  dplyr::filter(group=="y")

GTEXcr8z <- GTExsum %>% 
  rbind(., nQTLsum) %>% 
  dplyr::select(id,time,set, n,total) %>% 
  pivot_longer(cols=n:total, names_to="group",values_to="total") %>% mutate(group=case_match(group, "n"~"yes","total"~"no",.default = group))  
  

GTEXcr8z %>% #filter(time=="24_hours") %>% 
  ggplot(., aes(x=set,y=total, fill=group))+
   geom_col(position='fill')+
    facet_wrap(time~id,nrow=2,ncol=4)+
    theme_classic()+
    scale_fill_manual(values=drug_palspc)
      
GTExsum %>% 
  rbind(., nQTLsum) %>% 
  dplyr::select(id,time,set, n, total) %>% 
   mutate(time = case_match(time, '3_hours'~'3 hrs',
                           '24_hours'~'24 hrs',.default = time)) %>% 
  mutate(id =case_match( id, 
                         'Daunorubicin'~'DNR',   
                         'Doxorubicin'~'DOX' ,
                         'Epirubicin'~'EPI' , 
                         'Mitoxantrone' ~ 'MTX', .default = id)) #%>% 
  

```

```{r trychi again}


testDNR3chix <- matrix(c(365,190,7458, 6071), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","gtex"),c( "y", "n"))) 
    DNR_3chix <- chisq.test(testDNR3chix,correct=TRUE)$p.value
testDNR24chix <- matrix(c(3832,3032,3991,3229), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","gtex"),c( "y", "n")))  
    DNR_24chix <- chisq.test(testDNR24chix,correct=TRUE)$p.value

testDOX3chix <- matrix(c(14,2,7809,6259), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","gtex"),c( "y", "n")))  
    DOX_3chix <- chisq.test(testDOX3chix,correct=TRUE)$p.value
testDOX24chix <- matrix(c(3639,2877,4184,3384), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","gtex"),c( "y", "n"))) 
    DOX_24chix <- chisq.test(testDOX24chix,correct=TRUE)$p.value

testEPI3chix <- matrix(c(143,77,7680,6184), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","gtex"),c( "y", "n"))) 
    EPI_3chix <- chisq.test(testEPI3chix)$p.value
testEPI24chix <- matrix(c(3516,2686,4307,3575), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","gtex"),c( "y", "n"))) 
    EPI_24chix <- chisq.test(testEPI24chix)$p.value
  
testMTX3chix <- matrix(c(45,13,7778,6248), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","nogtex"),c( "y", "n"))) 
    MTX_3chix <- chisq.test(testMTX3chix)$p.value
testMTX24chix <- matrix(c(793,534,7030,5727), nrow=2, ncol=2, byrow=FALSE,
dimnames=list(c("nogtex","nogtex"),c( "y", "n"))) 
    MTX_24chix <- chisq.test(testMTX24chix,correct=TRUE)$p.value
GTEX_table_chix <- data.frame(treatment=c('DNR_3','DNR_24','DOX_3','DOX_24','EPI_3','EPI_24','MTX_3','MTX_24'), chi_p.value=c(DNR_3chix,DNR_24chix,DOX_3chix,DOX_24chix,EPI_3chix,EPI_24chix,MTX_3chix,MTX_24chix))

GTEX_table_chix %>% 
  separate(treatment, into= c('Drug','time')) %>% 
  pivot_wider(id_cols = Drug, names_from = time, values_from = chi_p.value) %>% 
  kable(., caption= "Chi Square p. values from chi-square test between proportions of sig-DE meQTLs and reQTLS by time and treatment") %>% 
  kable_paper("striped", full_width = TRUE) %>%  
  kable_styling(full_width = FALSE, font_size = 16) %>% 
  scroll_box( height = "500px")
```
