---
title: "After_comments"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```




```{r package loading}
library(tidyverse)
library(ggsignif)
library(cowplot)
library(ggpubr)
library(scales)
library(sjmisc)
library(kableExtra)
library(broom)
# library(ComplexHeatmap)
# library(ggVennDiagram)
library(biomaRt)
```

```{r}

ensembl <- useMart("ensembl", dataset="hsapiens_gene_ensembl")
my_chr <- c(1:22, 'M', 'X', 'Y')  ## creates a filter for each
#
my_attributes <- c('entrezgene_id', 'ensembl_gene_id', 'hgnc_symbol')

genehold <- c("ENSG00000049239", "ENSG00000116663","ENSG00000132768",	
"ENSG00000162601",	
"ENSG00000142856",	
"ENSG00000143450",	"ENSG00000165886",	
"ENSG00000198018",	
"ENSG00000166881",	
"ENSG00000100968",	
"ENSG00000081181",	
"ENSG00000181827",
"ENSG00000154945",	
"ENSG00000125457",	
"ENSG00000189362",	
"ENSG00000128274",	
"ENSG00000104205")

elife.33480.supp14.v2 <- read.delim("~/Ward Lab/Cardiotoxicity/supplementals from papers/elife-33480-supp14-v2.gz")

##had to parse a little differently.  the first table had a shift (the dataframe was downloads incorrectly)
namesof <- read_delim("C:/Users/renee/Downloads/Knowles_raw_data_dryad_download/log2_counts_per_million.txt.gz", delim = "\t", n_max=3)
colnames_k <- colnames(namesof)## This found the first 3 lines of the data and pulled the columnnames into colnames_k
Knowles_log2cpm <- read_table("C:/Users/renee/Downloads/Knowles_raw_data_dryad_download/log2_counts_per_million.txt.gz", col_names = c("ESGN",colnames_k), skip=1) ##this skipped the first row containing the wrong colnames and shifted the data to parse 218 columns)


sample_table_k <- read_delim("C:/Users/renee/Downloads/Knowles_raw_data_dryad_download/sample_table.txt", delim = "\t")

trop_knowles <- read.delim("~/Ward Lab/Cardiotoxicity/supplementals from papers/elife-33480-supp11-v2.txt")

```



























































## RNA-seq trial analysis  

### Analysis of expressed genes

```{r data_import_expression}

RNA_seq_trial<- readRDS("data/RNA_seq_trial.RDS")

all_cpmcount <-  read_table("data/Counts_RNA_ERMatthews.txt")
cpm_count_main <- readRDS("data/cpmcount.RDS") %>% rownames_to_column(var = "ENTREZID")
colnames(cpm_count_main) <- colnames(all_cpmcount)


test_run_sample_list <- read.csv("data/test_run_sample_list.txt", row.names = 1)

colnames(RNA_seq_trial) <- c("ENTREZID",test_run_sample_list$Sample_ID)

lcpm_trial <- RNA_seq_trial %>% 
  column_to_rownames("ENTREZID") %>% 
  cpm(., log=TRUE) %>% 
  as.data.frame() #%>% 
 

row_means <- rowMeans(lcpm_trial)
x_trial <- lcpm_trial[row_means > 0,]
dim(x_trial)
list_genes_trial <- rownames(x_trial)
ggVennDiagram::ggVennDiagram(list(list_genes_trial, cpm_count_main$ENTREZID),
                             category.names = c("Trialgenes","Maingenes"),
              show_intersect = TRUE,
              set_color = "black",
              label = "count",
              label_percent_digit = 1,
              label_size = 4,
              label_alpha = 0,
              label_color = "black",
              edge_lty = "solid", set_size = 4.5)#+
  
```





### Correlation of counts files


```{r correlations}

lcpm_trial_full <- RNA_seq_trial %>% 
  column_to_rownames("ENTREZID") %>% 
  cpm(., log=TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "ENTREZID")

lcpm_trial_full %>%
  column_to_rownames(var="ENTREZID") %>%
  cor(.) %>% 
  Heatmap(.,layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(., i, j)), x, y, 
            gp = gpar(fontsize = 10))})

lcpm_main <- all_cpmcount %>% 
  column_to_rownames("ENTREZID") %>% 
  cpm(., log=TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "ENTREZID") %>% 
  select(ENTREZID, all_of(starts_with("DOX"))) %>% 
  select(ENTREZID, all_of(ends_with("3h")))  
  
combined_data <- lcpm_main %>%
  full_join(., lcpm_trial_full, by= "ENTREZID") %>% 
  column_to_rownames("ENTREZID") %>% 
  cor(.,) 


  
  Heatmap(combined_data,column_title = "Full gene list",
          layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(combined_data, i, j)), x, y, 
            gp = gpar(fontsize = 10))})
  
  only79_ind <- lcpm_main %>%
  full_join(., lcpm_trial_full, by= "ENTREZID") %>% 
    select(ENTREZID,'3hr_0.5',"DOX.4.3h") %>% 
    column_to_rownames("ENTREZID") %>% 
  cor(.,) 

  
  Heatmap(only79_ind,column_title = "Full gene list",
          layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(only79_ind, i, j)), x, y, 
            gp = gpar(fontsize = 10))})
  
  
  
lcpm_main_veh <- all_cpmcount %>% 
  column_to_rownames("ENTREZID") %>% 
  cpm(., log=TRUE) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "ENTREZID") %>% 
  select(ENTREZID, all_of(c(starts_with("DOX"),starts_with("VEH")))) %>% 
  select(ENTREZID, all_of(ends_with("3h")))  
  

combined_data_veh<- lcpm_main_veh %>%
  full_join(., lcpm_trial_full, by= "ENTREZID") %>% 
  column_to_rownames("ENTREZID") %>% 
  cor(.,) 
  
  
  
  Heatmap(combined_data_veh, column_title = "all genes in list, no filtering",
          layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(combined_data_veh, i, j)), x, y, 
            gp = gpar(fontsize = 8))})
  
  


```

```{r correlation RNAseqtrial filter}
lcpm_trial_filter_main <- lcpm_trial_full %>% 
  filter(ENTREZID %in% cpm_count_main$ENTREZID)
 


lcpm_trial_filter_main %>% 
column_to_rownames(var="ENTREZID") %>%
  cor(.) %>% 
  Heatmap(.,column_title = "Using 14,084 expressed genes from Main data",
          layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(., i, j)), x, y, 
            gp = gpar(fontsize = 8))})


lcpm_trial_filter <- lcpm_trial_full %>% 
  filter(ENTREZID %in% list_genes_trial)
 

lcpm_trial_filter %>% 
column_to_rownames(var="ENTREZID") %>%
  cor(.) %>% 
  Heatmap(.,column_title = "Using 13277 expressed genes",
          layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(., i, j)), x, y, 
            gp = gpar(fontsize = 8))})


lcpm_main_filter_trial <- lcpm_main_veh %>% 
  filter(ENTREZID %in% list_genes_trial)

lcpm_trial_filter %>% 
  full_join(., lcpm_main_filter_trial, by = "ENTREZID") %>% 
  column_to_rownames(var="ENTREZID") %>%
  cor(.) %>% 
  Heatmap(.,column_title = "Using 13277 expressed genes",
          layer_fun = function(j, i, x, y, width, height, fill) {
              grid.text(sprintf("%.3f", pindex(., i, j)), x, y, 
            gp = gpar(fontsize = 8))})



  
 
```


```{r bar_plots of GOI, eval=FALSE, include=FALSE}



for (g in seq(1:4)){
  datafilter <- top_genes_df %>% filter(drug=="DOX")
  a <- datafilter[g,3]
  # b <- datafilter[g,1]
  cpm_boxplot(cpmcounts,GOI=datafilter[g,2],
              "Dark2",
              drug_pal_fact,
              ylab=bquote(~italic(.(a))~log[2]~"cpm "))
  
}
cpm_boxplot <-function(lcpm_trial, GOI,brewer_palette, fill_colors, ylab) {
    ##GOI needs to be ENTREZID
  df <- lcpm_trial
  df_plot <- df %>% 
      dplyr::filter(rownames(.)== 5916) %>%
      pivot_longer(everything(),
                   names_to = "treatment",
                   values_to = "counts") %>%
      separate(treatment, c("time","conc")) %>%
        mutate(conc = factor(conc,levels=c('0.0','0.1','0.5','1.0')))
      # mutate(time = factor(time, levels= c("3h","24h"), labels = c("3 hours","24 hours"))) %>% 
      # mutate(indv=factor(indv, levels = c(1,2,3,4,5,6))) %>%
      # mutate(drug =case_match(drug, "Da"~"DNR",
                            # "Do"~"DOX",
                            # "Ep"~"EPI",
                            # "Mi"~"MTX",
                            # "Tr"~"TRZ",
                            # "Ve"~"VEH", .default = drug)) %>% 
      # mutate(drug=factor(drug, levels = c('DOX','EPI','DNR','MTX','TRZ','VEH'))) 
  
    plot <- ggplot2::ggplot(df_plot, aes(x=drug, y=counts))+
      geom_boxplot(position="identity",aes(fill=drug))+
      geom_point(aes(col=indv, size=2, alpha=0.5))+
      guides(alpha= "none", size= "none")+
      scale_color_brewer(palette = brewer_palette, guide = "none")+
      scale_fill_manual(values=fill_colors)+
      facet_wrap(~time, nrow=1, ncol=2)+
      theme_bw()+
      ylab(ylab)+
      xlab("")+
      # ggtitle("24 hours")+
      theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "pt"),face = "bold"))
    print(plot)
}
plot_lcpm_trial <- lcpm_trial %>% 
  rownames_to_column(var="ENTREZID")
df_plot <- lcpm_trial %>% 
      dplyr::filter(ENTREZID== 5916) %>%
      pivot_longer(!ENTREZID,
                   names_to = "treatment",
                   values_to = "counts") %>%
      separate(treatment, c("time","conc"),sep="_") %>%
  mutate(conc = as.numeric(conc)) %>% 
   mutate(conc = factor(conc, levels=c('0.0','0.1','0.5','1.0'), labels = c ("NT", "0.1 uM", "0.5 uM", "1.0 uM")))


ggplot2::ggplot(plot_lcpm_trial, aes(x=conc, y= counts))+
      geom_bar(position="identity",aes(fill=conc))+
      # geom_point(position="identity",stat = "identity")+
      # guides(alpha= "none", size= "none")+
      #scale_color_brewer(palette = brewer_palette, guide = "none")+
      #scale_fill_manual(values=fill_colors)+
      #facet_wrap(~time, nrow=1, ncol=2)+
      theme_bw()+
      ylab(ylab)+
      xlab("")#+
      # ggtitle("24 hours")+
      theme(strip.background = element_rect(fill = "white",linetype=1, linewidth = 0.5),
          plot.title = element_text(size=12,hjust = 0.5,face="bold"),
          axis.title = element_text(size = 10, color = "black"),
          axis.ticks = element_line(linewidth = 1.0),
          panel.background = element_rect(colour = "black", size=1),
          axis.text.x = element_blank(),
          strip.text.x = element_text(margin = margin(2,0,2,0, "pt"),face = "bold"))
    print(plot)
}

```
